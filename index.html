<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HÃ nh TrÃ¬nh Cá»§a An - v57.2 Rollback & Stable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Merriweather:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        /* --- CORE --- */
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #e2e8f0; overflow: hidden; touch-action: none; }
        .font-serif { font-family: 'Merriweather', serif; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }

        /* --- TOAST --- */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 200; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { 
            background: rgba(30, 41, 59, 0.95); border-left: 4px solid #6366f1; color: white; 
            padding: 12px 24px; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5);
            animation: slideIn 0.3s ease-out, fadeOut 0.3s ease-in 4s forwards; 
            pointer-events: auto; font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 12px;
        }
        .toast.event { border-left-color: #fbbf24; background: linear-gradient(to right, #1e1b4b, #0f172a); border: 1px solid #fbbf24; box-shadow: 0 0 15px rgba(251, 191, 36, 0.2); }
        .toast.error { border-left-color: #f43f5e; }
        .toast.success { border-left-color: #10b981; }
        .toast.warning { border-left-color: #f59e0b; }

        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- MODAL --- */
        .modal { display: none; position: fixed; z-index: 100; inset: 0; background-color: rgba(0,0,0,0.9); backdrop-filter: blur(5px); align-items: center; justify-content: center; padding: 16px; }
        .modal-content { background-color: #1e293b; border: 1px solid #334155; border-radius: 1rem; max-width: 600px; width: 100%; max-height: 85vh; overflow-y: auto; animation: zoomIn 0.2s ease-out; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); display: flex; flex-direction: column; }

        /* SIDEBAR COLLAPSED LOGIC */
        .sidebar-collapsed { width: 80px !important; }
        .sidebar-collapsed .nav-text { display: none !important; }
        .sidebar-collapsed .sidebar-header-content { display: none !important; }
        .sidebar-collapsed .nav-item { justify-content: center !important; padding: 12px 0 !important; }
        .sidebar-collapsed .nav-icon { margin: 0 !important; font-size: 1.5rem !important; }
        .sidebar-collapsed #inventory-section-content { display: none !important; }
        .sidebar-collapsed #btn-reset-journey span { display: inline-block; font-size: 1.2rem; }
        .sidebar-collapsed #btn-reset-journey { padding: 10px 0; justify-content: center; }
        .sidebar-collapsed #btn-reset-text { display: none; }
        .sidebar-collapsed #toggle-sidebar-btn { transform: rotate(180deg); }

        /* ITEM & SKILL STYLES */
        .item-slot { width: 40px; height: 40px; border-radius: 8px; background: #1e293b; border: 1px solid #475569; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; transition: all 0.2s; position: relative; }
        .item-slot:hover { background: #334155; border-color: #94a3b8; transform: translateY(-2px); }
        .item-slot.locked { opacity: 0.3; cursor: not-allowed; filter: grayscale(100%); pointer-events: none; }
        .item-slot.used { opacity: 0.5; filter: grayscale(100%); cursor: default; }
        .item-slot.used::after { content: 'âœ“'; position: absolute; bottom: -4px; right: -4px; background: #10b981; color: white; font-size: 10px; padding: 2px 4px; border-radius: 4px; font-weight: bold; }
        .item-slot.usable { border-color: #fbbf24; box-shadow: 0 0 10px rgba(251, 191, 36, 0.3); animation: pulse-border 2s infinite; }
        @keyframes pulse-border { 0% { border-color: #fbbf24; } 50% { border-color: #f59e0b; box-shadow: 0 0 15px rgba(251, 191, 36, 0.5); } 100% { border-color: #fbbf24; } }
        .skill-btn { width: 100%; padding: 12px; border-radius: 8px; font-weight: bold; text-align: center; margin-top: 8px; transition: all 0.2s; border: 1px solid transparent; }
        .skill-btn.available { background: #4f46e5; color: white; cursor: pointer; }
        .skill-btn.available:hover { background: #4338ca; }
        .skill-btn.used { background: #1e293b; color: #64748b; cursor: default; border-color: #334155; }
        .skill-content { margin-top: 12px; padding: 12px; background: #0f172a; border-radius: 8px; border: 1px dashed #334155; display: none; }
        .skill-content.visible { display: block; animation: fadeIn 0.3s; }

        /* GAME STYLES */
        .bulb-btn { transition: all 0.1s; } .bulb-btn:active { transform: scale(0.98); } .bulb-on { background-color: #fcd34d !important; color: #713f12 !important; box-shadow: 0 0 40px #fcd34d; border-color: #fbbf24 !important; } .bulb-off { background-color: #1e293b; color: #64748b; border-color: #475569; }
        .jug-container { position: relative; background: #334155; border-radius: 0 0 12px 12px; border: 4px solid #64748b; border-top: none; overflow: hidden; transition: all 0.2s; cursor: pointer; width: 90px; margin: 0 8px; } .jug-container:hover { border-color: #94a3b8; } .jug-water { position: absolute; bottom: 0; left: 0; width: 100%; background-color: #fbbf24; transition: height 0.5s ease; opacity: 0.9; box-shadow: inset 0 -5px 10px rgba(0,0,0,0.1); } .jug-selected { border-color: #d946ef !important; box-shadow: 0 0 0 4px rgba(217, 70, 239, 0.5) !important; transform: translateY(-4px); }
        .char-card { transition: all 0.2s; cursor: pointer; user-select: none; position: relative; z-index: 20; box-shadow: 0 4px 6px rgba(0,0,0,0.4); background: #1e293b; border: 2px solid #475569; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px; width: 100%; aspect-ratio: 1/1; } .char-card:hover { transform: translateY(-3px); border-color: #fbbf24; background: #334155; }
        .bridge-layout { display: flex; width: 100%; height: 600px; border: 2px solid #334155; border-radius: 16px; overflow: hidden; background: #0f172a; position: relative; } .cliff-side { width: 250px; height: 100%; background: #1e293b; border-right: 2px solid #334155; padding: 16px; overflow-y: auto; flex-shrink: 0; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; align-content: start; justify-items: center; z-index: 5; } .cliff-side.right { border-left: 2px solid #334155; border-right: none; } .bridge-zone { flex: 1; height: 100%; position: relative; background: linear-gradient(180deg, #020617 0%, #0f172a 100%); overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; } .bridge-zone .btn-go-round { margin-top: 60px; } .bridge-cable { position: absolute; width: 100%; height: 8px; background: #64748b; top: 40%; transform: translateY(-50%); border-radius: 4px; box-shadow: 0 10px 20px rgba(0,0,0,0.5); } .lamp-carrier { width: 180px; height: 180px; border-radius: 50%; border: 4px dashed rgba(251, 191, 36, 0.6); display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 8px; padding: 20px; background: radial-gradient(circle, rgba(251,191,36,0.15) 0%, transparent 70%); transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1); z-index: 10; position: absolute; box-shadow: 0 0 30px rgba(251, 191, 36, 0.1); top: 40%; margin-top: -90px; } .pos-left { transform: translateX(0); left: 10px; } .pos-right { transform: translateX(0); left: calc(100% - 190px); }
        .btn-go-round { width: 90px; height: 90px; border-radius: 50%; background: linear-gradient(135deg, #d97706, #b45309); color: white; font-weight: 900; box-shadow: 0 4px 15px rgba(217, 119, 6, 0.5); border: 4px solid rgba(251, 191, 36, 0.3); letter-spacing: 0.05em; font-size: 1.3rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s; z-index: 40; cursor: pointer; } .btn-go-round:active { transform: scale(0.9); box-shadow: 0 2px 5px rgba(217, 119, 6, 0.5); }
        .btn-go-mobile { width: 100%; padding: 12px; border-radius: 8px; background: linear-gradient(to right, #d97706, #b45309); color: white; font-weight: 900; box-shadow: 0 4px 15px rgba(217, 119, 6, 0.4); border: 2px solid rgba(251, 191, 36, 0.5); letter-spacing: 0.1em; font-size: 1.1rem; text-transform: uppercase; transition: all 0.2s; margin-bottom: 0; } .btn-go-mobile:active { transform: scale(0.98); }
        
        @media (max-width: 767px) { 
            .bridge-layout { flex-direction: column; height: auto; min-height: auto; border: none; background: transparent; overflow: visible; gap: 4px; } 
            .cliff-side { width: 100%; height: auto; min-height: 70px; border: 2px solid #334155; border-radius: 12px; background: #1e293b; padding: 8px; margin: 0; display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; } 
            /* COMPACT BRIDGE ZONE (180px) */
            .bridge-zone { min-height: 180px; border: 2px solid #334155; border-radius: 12px; background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%); margin: 0; display: flex; flex-direction: column; justify-content: center; } 
            .bridge-zone .btn-go-round { display: none; } 
            .mobile-action-bar { margin-top: 0px; padding: 0; display: flex; justify-content: center; } 
            .bridge-cable { width: 6px; height: 100%; top: 0; left: 50%; transform: translateX(-50%); } 
            .lamp-carrier { left: 50%; width: 100px; height: 100px; margin-left: -50px; top: 10px; margin-top: 0; transition: top 0.8s cubic-bezier(0.4, 0, 0.2, 1); } 
            .pos-left { top: 10px; transform: none; left: 50%; } 
            .pos-right { top: calc(100% - 110px); transform: none; left: 50%; } 
            .char-card { height: 45px; width: 100%; padding: 1px; border-radius: 4px; } 
            .char-emoji { font-size: 1.1rem; line-height: 1; } .char-text { font-size: 0.55rem; display: none; } 
        }

        .box-btn { transition: all 0.2s; cursor: pointer; touch-action: manipulation; } .box-btn:active { transform: scale(0.95); } .quantum-active { animation: pulse-glow 2s infinite; border-color: #818cf8; } @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 5px rgba(99, 102, 241, 0.2); } 50% { box-shadow: 0 0 20px rgba(99, 102, 241, 0.5); } }
        .spider-frame { border: 2px solid #475569; border-radius: 24px; background: #0f172a; box-shadow: inset 0 0 40px rgba(0,0,0,0.6); overflow: hidden; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; max-width: 600px; margin: 0 auto; aspect-ratio: 1/1; touch-action: none; position: relative; }
        .horse { width: 40px; height: 40px; border-radius: 8px; background-color: #be185d; color: white; display: flex; align-items: center; justify-content: center; font-weight: 800; cursor: pointer; transition: all 0.2s; user-select: none; border: 2px solid #fbcfe8; font-size: 0.9rem; box-shadow: 0 2px 4px rgba(0,0,0,0.3); } .horse:active { transform: scale(1.1); } #horse-pool-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; width: 100%; max-width: 350px; margin: 0 auto; }
        .ball { width: 38px; height: 38px; border-radius: 50%; background-color: #4f46e5; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; cursor: pointer; transition: transform 0.1s; font-size: 0.8rem; margin: 2px; box-shadow: inset -5px -5px 10px rgba(0,0,0,0.4); border: 2px solid #818cf8; } .pan { min-height: 120px; border: 3px solid #64748b; border-top: none; border-radius: 0 0 20px 20px; background-color: #1e293b; display: grid; grid-template-columns: repeat(2, 1fr); align-content: start; justify-items: center; gap: 5px; padding: 10px; transition: border-color 0.3s; cursor: pointer; width: 100%; position: relative; } .pan::before { content:''; position: absolute; top: -40px; left: 50%; width: 4px; height: 40px; background: #64748b; transform: translateX(-50%); } @media (min-width: 768px) { .pan { grid-template-columns: repeat(4, 1fr); } } .pan:hover { border-color: #94a3b8; } .pan.selected-pan { border-color: #fbbf24; background-color: rgba(251, 191, 36, 0.08); box-shadow: 0 0 20px rgba(251, 191, 36, 0.15); } .pan.selected-pan::before { background: #fbbf24; } .scale-arm { width: 100%; height: 8px; background: #64748b; border-radius: 4px; transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); transform-origin: center; position: relative; } .scale-pivot { width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent; border-bottom: 40px solid #475569; position: absolute; bottom: -48px; left: 50%; transform: translateX(-50%); } .balanced-anim { animation: balancePulse 0.5s ease-in-out; } @keyframes balancePulse { 0% { transform: scaleX(1); } 50% { transform: scaleX(1.1); background-color: #10b981; } 100% { transform: scaleX(1); } } .tilt-left { transform: rotate(-10deg); } .tilt-right { transform: rotate(10deg); } .pan-container { transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); width: 40%; display: flex; flex-direction: column; items-center; } .pan-tilt-up { transform: translateY(-30px); } .pan-tilt-down { transform: translateY(30px); }

        .game-canvas { display: block; width: 100%; height: 100%; object-fit: contain; } .log-box { font-family: monospace; font-size: 0.9rem; background: #0f172a; padding: 12px; border-radius: 8px; overflow-y: auto; border: 1px solid #334155; color: #94a3b8; line-height: 1.6; }
        .victory-overlay { position: absolute; inset: 0; background: rgba(2, 6, 23, 0.98); backdrop-filter: blur(12px); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; pointer-events: auto; transition: opacity 0.3s ease-out; padding: 20px; text-align: center; pointer-events: none; } .victory-visible { opacity: 1; pointer-events: auto; }
        .accordion-content { overflow: hidden; transition: max-height 0.4s ease-in-out; } .accordion-collapsed { max-height: 0 !important; padding-top: 0 !important; padding-bottom: 0 !important; } .accordion-expanded { max-height: 800px; } @media (min-width: 768px) { #story-content-wrapper.accordion-collapsed { max-height: 0 !important; } #story-content-wrapper:not(.accordion-collapsed) { max-height: 800px !important; } } .intro-active #accordion-icon-mobile { display: none; } .intro-active #accordion-icon-desktop { display: none; } .intro-active .accordion-content { max-height: none !important; }
    </style>
</head>
<body class="flex h-screen bg-slate-950 text-slate-200">

    <div id="toast-container"></div>

    <!-- SIDEBAR -->
    <aside id="desktop-sidebar" class="hidden md:flex flex-col w-72 bg-slate-900 border-r border-slate-800 h-full shrink-0 z-30 transition-all duration-300 relative">
        <div class="p-6 border-b border-slate-800 flex justify-between items-center overflow-hidden h-[80px]">
            <div class="sidebar-header-content">
                <h1 id="app-title" class="text-lg font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-cyan-400 whitespace-nowrap">HÃ€NH TRÃŒNH Cá»¦A AN</h1>
                <div class="text-[10px] text-slate-500 font-bold mt-1 tracking-widest">v57.2 ROLLBACK</div>
            </div>
        </div>
        <nav id="sidebar-nav" class="flex-1 overflow-y-auto pb-4 space-y-1 p-2"></nav>
        <div id="inventory-section" class="p-4 border-t border-slate-800 bg-slate-900/50">
            <div id="inventory-section-content">
                <div class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2">KHO Váº¬T PHáº¨M</div>
                <div id="inventory-grid" class="grid grid-cols-4 gap-2 mb-4"></div>
                <div class="flex justify-between items-center bg-slate-800 p-3 rounded-lg border border-slate-700 shadow-inner mb-3">
                    <div class="flex items-center space-x-2"><span class="text-xl">âš™ï¸</span><span class="text-xs font-bold text-amber-400 uppercase">BÃ¡nh RÄƒng</span></div>
                    <span id="gear-count" class="text-xl font-black text-white">0/8</span>
                </div>
            </div>
            <button onclick="openModal('reset-modal')" id="btn-reset-journey" class="w-full py-2 bg-red-900/30 hover:bg-red-900/50 border border-red-800 text-red-400 text-xs font-bold rounded uppercase tracking-wider transition flex items-center justify-center gap-2">
                <span>ğŸ—‘ï¸</span> <span id="btn-reset-text">XÃ“A HÃ€NH TRÃŒNH</span>
            </button>
        </div>
        <!-- Collapse Button -->
        <button id="toggle-sidebar-btn" onclick="GameManager.toggleSidebar()" class="absolute bottom-4 right-[-12px] bg-slate-800 border border-slate-600 rounded-full p-1 text-xs hover:bg-slate-700 transition-transform z-50 shadow-lg text-white w-6 h-6 flex items-center justify-center cursor-pointer">
            Â«
        </button>
    </aside>

    <!-- MOBILE HEADER -->
    <div class="md:hidden fixed top-0 w-full h-14 bg-slate-900/95 backdrop-blur border-b border-slate-800 z-50 flex items-center justify-between px-4 shadow-lg">
        <span class="font-bold text-indigo-400 text-sm truncate">HÃ€NH TRÃŒNH Cá»¦A AN</span>
        <div class="flex items-center gap-3">
            <div id="mobile-inventory" class="flex gap-2 mr-2"></div>
            <span class="text-amber-400 text-xs font-bold" id="mobile-gear">0 âš™ï¸</span>
            <button onclick="document.getElementById('mobile-menu').classList.toggle('hidden')" class="text-2xl p-2">â˜°</button>
        </div>
    </div>
    <div id="mobile-menu" class="hidden fixed top-14 left-0 w-full bg-slate-950/95 backdrop-blur z-40 border-b border-slate-800 p-4 md:hidden max-h-[80vh] overflow-y-auto shadow-2xl">
        <nav id="mobile-nav-list" class="space-y-1 pb-4"></nav>
    </div>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col relative pt-14 md:pt-0 overflow-hidden h-full">
        
        <!-- STORY ACCORDION -->
        <div id="story-section" class="bg-slate-900 border-b border-slate-800 shrink-0 z-20 shadow-md relative transition-all duration-300">
            <div class="md:hidden flex justify-between items-center p-3 bg-slate-800 cursor-pointer active:bg-slate-700 transition border-b border-slate-800" onclick="toggleStory()">
                <div class="flex items-center gap-2 overflow-hidden"><span id="chapter-tag-mobile" class="text-[9px] font-bold text-slate-400 bg-slate-950 px-2 py-1 rounded border border-slate-700 shrink-0">CHÆ¯Æ NG 1</span><span id="story-title-mobile" class="text-sm font-bold text-white truncate">...</span></div><span id="accordion-icon-mobile" class="text-xs text-slate-500">â–¼</span>
            </div>
            <div class="hidden md:flex justify-between items-center p-4 bg-slate-800 border-b border-slate-700 cursor-pointer hover:bg-slate-750 transition" onclick="toggleStory()">
                 <div class="flex items-center gap-3"><span id="part-tag" class="text-[10px] font-black text-indigo-400 uppercase tracking-widest border border-indigo-500/30 px-2 py-0.5 rounded bg-indigo-500/10">PHáº¦N 1</span><h3 id="story-title" class="text-xl font-serif font-bold text-white truncate">...</h3></div><div class="flex items-center gap-4"><span id="chapter-tag" class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">CHÆ¯Æ NG 1</span><span id="accordion-icon-desktop" class="text-slate-400 hover:text-white transition text-sm">â–² Thu gá»n</span></div>
            </div>
            <div id="story-content-wrapper" class="accordion-content accordion-expanded p-4 md:p-6 overflow-y-auto max-h-[40vh] bg-slate-900">
                <div class="max-w-4xl mx-auto">
                    <div id="story-text" class="text-slate-300 text-sm leading-relaxed mb-4 font-light">...</div>
                    <div id="game-rules-section" class="mb-6 p-4 bg-slate-950/50 rounded-xl border border-slate-800 hidden"><h4 class="text-xs font-black text-amber-500 uppercase tracking-widest mb-2">HÆ¯á»šNG DáºªN NHIá»†M Vá»¤</h4><div id="game-rules-text" class="text-sm text-slate-400 leading-relaxed space-y-2"></div></div>
                    <div class="flex gap-3 flex-wrap"><button id="btn-play" onclick="GameManager.playLevel()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-bold rounded-lg shadow-lg transition-transform active:scale-95">Báº®T Äáº¦U (Enter)</button></div>
                </div>
            </div>
        </div>

        <!-- GAME STAGE -->
        <div class="flex-1 bg-[#020617] relative overflow-hidden flex flex-col w-full">
            <div id="game-container" class="flex flex-col h-full w-full hidden">
                <div class="flex justify-between items-center p-2 px-4 border-b border-slate-800 bg-slate-900 z-30 shrink-0 h-14">
                    <div class="flex items-center gap-3"><div class="flex flex-col"><span class="text-[9px] text-slate-500 font-bold uppercase">Tráº¡ng thÃ¡i</span><span id="game-metric" class="font-mono text-3xl md:text-2xl text-emerald-400 font-black">...</span></div><div id="game-msg" class="hidden"></div></div>
                    <div class="flex gap-2"><button onclick="ActiveGame.reset()" class="px-3 py-1.5 bg-slate-800 hover:bg-slate-700 text-slate-300 border border-slate-600 rounded text-xs font-bold transition">â†º Reset</button><button onclick="openModal('hint-modal')" class="px-3 py-1.5 bg-amber-900/30 hover:bg-amber-800 text-amber-200 border border-amber-700/50 rounded text-xs font-bold transition">ğŸ’¡ Gá»£i Ã½</button><button onclick="GameManager.skip()" class="px-3 py-1.5 bg-rose-900/20 hover:bg-rose-900 text-rose-300 border border-rose-800 rounded text-xs font-bold transition">â© SKIP</button></div>
                </div>
                <div id="game-stage" class="flex-1 overflow-y-auto w-full p-4 relative flex flex-col items-center"></div>
            </div>
            <div id="placeholder" class="absolute inset-0 flex flex-col items-center justify-center opacity-20 select-none pointer-events-none"><div class="text-6xl md:text-8xl mb-4 grayscale">ğŸ°</div><div class="text-xl md:text-2xl font-serif font-bold tracking-[0.2em] text-white">VÆ¯Æ NG QUá»C LOGIC</div></div>
            <div id="victory-overlay" class="victory-overlay"></div>
        </div>
    </main>

    <!-- MODALS -->
    <div id="hint-modal" class="modal" style="display:none;" onclick="closeModal('hint-modal')">
        <div class="modal-content p-0" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center p-4 border-b border-slate-700 bg-slate-900">
                <h3 class="text-lg font-bold text-amber-500">Trung TÃ¢m Chiáº¿n Thuáº­t</h3>
                <button onclick="closeModal('hint-modal')" class="text-slate-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="p-4 bg-slate-900 space-y-4">
                <div class="bg-slate-800 p-4 rounded-lg border border-slate-700">
                    <div class="text-xs font-bold text-slate-400 uppercase mb-2">Gá»¢I Ã CÆ  Báº¢N</div>
                    <p id="hint-text" class="text-slate-300 text-sm italic">...</p>
                </div>
                <div class="space-y-2">
                    <div id="comp-dog" class="bg-slate-800 p-4 rounded-lg border border-slate-700 opacity-50"><div class="flex justify-between items-center"><span class="font-bold text-yellow-500">ğŸ• <span class="name">ChÃ³ VÃ ng</span></span><span class="text-xs text-slate-500 status-text">ChÆ°a má»Ÿ khÃ³a</span></div><div id="btn-dog" class="skill-btn" onclick="GameManager.useSkill('dog')">ÄÃ¡nh HÆ¡i (1 láº§n)</div><div id="content-dog" class="skill-content text-sm text-yellow-200"></div></div>
                    <div id="comp-bear" class="bg-slate-800 p-4 rounded-lg border border-slate-700 opacity-50"><div class="flex justify-between items-center"><span class="font-bold text-amber-600">ğŸ» <span class="name">Gáº¥u</span></span><span class="text-xs text-slate-500 status-text">ChÆ°a má»Ÿ khÃ³a</span></div><div id="btn-bear" class="skill-btn" onclick="GameManager.useSkill('bear')">Chá»‰ Dáº«n (1 láº§n)</div><div id="content-bear" class="skill-content text-sm text-amber-200"></div></div>
                    <div id="comp-robo" class="bg-slate-800 p-4 rounded-lg border border-slate-700 opacity-50"><div class="flex justify-between items-center"><span class="font-bold text-cyan-400">ğŸ¤– <span class="name">Robo</span></span><span class="text-xs text-slate-500 status-text">ChÆ°a má»Ÿ khÃ³a</span></div><div id="btn-robo" class="skill-btn" onclick="GameManager.useSkill('robo')">PhÃ¢n TÃ­ch (1 láº§n)</div><div id="content-robo" class="skill-content text-sm text-cyan-200 font-mono"></div></div>
                </div>
            </div>
        </div>
    </div>

    <div id="reset-modal" class="modal" style="display:none;" onclick="closeModal('reset-modal')">
        <div class="bg-slate-900 border border-slate-700 p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4 text-center" onclick="event.stopPropagation()">
            <div class="text-4xl mb-4">âš ï¸</div>
            <h3 class="text-xl font-bold text-white mb-2">XÃ¡c nháº­n xÃ³a hÃ nh trÃ¬nh?</h3>
            <p class="text-slate-400 text-sm mb-6">ToÃ n bá»™ tiáº¿n Ä‘á»™ sáº½ bá»‹ xÃ³a.</p>
            <div class="flex gap-3">
                <button onclick="closeModal('reset-modal')" class="flex-1 py-3 bg-slate-800 hover:bg-slate-700 text-white font-bold rounded-lg transition">Há»§y</button>
                <button onclick="GameManager.confirmReset()" class="flex-1 py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg transition">XÃ³a LuÃ´n</button>
            </div>
        </div>
    </div>

    <!-- ENDING SCREEN -->
    <div id="ending-screen" class="hidden fixed inset-0 z-[200] bg-black flex flex-col items-center justify-center animate-fadeIn overflow-y-auto">
        <div class="w-full min-h-screen flex items-center justify-center p-4 py-12">
            <div class="max-w-3xl w-full bg-slate-900/95 p-8 rounded-3xl border-2 border-slate-700 shadow-2xl relative overflow-hidden transform scale-95 animate-zoomIn flex flex-col max-h-[95vh]">
                <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
                <div class="text-center shrink-0">
                    <div id="end-icon" class="text-6xl mb-4 animate-bounce inline-block">ğŸ†</div>
                    <h1 id="end-title" class="text-3xl md:text-5xl font-serif font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-200 to-amber-500 mb-2">THE END</h1>
                    <div id="end-subtitle" class="text-sm font-bold text-slate-500 uppercase tracking-[0.3em] mb-6">HÃ€NH TRÃŒNH KHÃ‰P Láº I</div>
                </div>
                <div class="bg-slate-950/60 p-6 rounded-2xl border border-slate-800 mb-8 text-left overflow-y-auto custom-scrollbar shadow-inner flex-1" style="max-height: none; flex-grow: 1;">
                    <p id="end-desc" class="text-base md:text-lg text-slate-300 leading-relaxed font-light font-serif pb-10">...</p>
                </div>
                <div class="flex justify-center items-center gap-6 mb-8 bg-slate-800/50 p-4 rounded-xl border border-slate-700 shrink-0">
                    <div class="flex flex-col text-center"><span class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">BÃNH RÄ‚NG</span><span id="end-score" class="text-2xl font-black text-white mt-1">0/8 âš™ï¸</span></div>
                    <div class="w-px h-8 bg-slate-600"></div>
                    <div class="flex flex-col text-center"><span class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">ÄÃNH GIÃ</span><span id="end-rank" class="text-2xl font-black text-emerald-400 mt-1">B</span></div>
                </div>
                <div class="shrink-0 sticky bottom-0 bg-slate-900 pt-4 pb-2">
                    <button onclick="GameManager.confirmReset()" class="w-full py-4 bg-white hover:bg-slate-200 text-black font-black text-lg rounded-full shadow-[0_0_20px_rgba(255,255,255,0.2)] transition-transform hover:scale-105 active:scale-95">CHÆ I Láº I Tá»ª Äáº¦U</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function showToast(msg, type='info') { const c = document.getElementById('toast-container'); const t = document.createElement('div'); t.className = `toast ${type}`; t.innerHTML = msg; c.appendChild(t); setTimeout(() => t.remove(), 4000); }
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(t) { if(audioCtx.state==='suspended')audioCtx.resume(); if(t==='silent')return; const osc=audioCtx.createOscillator(),g=audioCtx.createGain(); osc.connect(g);g.connect(audioCtx.destination); const n=audioCtx.currentTime; if(t==='click'){osc.type='sine';osc.frequency.setValueAtTime(600,n);g.gain.setValueAtTime(0.05,n);g.gain.exponentialRampToValueAtTime(0.001,n+0.1);osc.start(n);osc.stop(n+0.1)} else if(t==='win'){osc.type='triangle';osc.frequency.setValueAtTime(523,n);osc.frequency.linearRampToValueAtTime(1046,n+0.3);g.gain.setValueAtTime(0.1,n);g.gain.linearRampToValueAtTime(0.001,n+1);osc.start(n);osc.stop(n+1)} else if(t==='fail'){osc.type='sawtooth';osc.frequency.setValueAtTime(150,n);osc.frequency.linearRampToValueAtTime(100,n+0.3);g.gain.setValueAtTime(0.1,n);g.gain.linearRampToValueAtTime(0.001,n+0.5);osc.start(n);osc.stop(n+0.5)} }
        function toggleStory() { const w=document.getElementById('story-content-wrapper'); const im=document.getElementById('accordion-icon-mobile'); const id=document.getElementById('accordion-icon-desktop'); if(document.body.classList.contains('intro-active')) return; if(w.classList.contains('accordion-collapsed')){ w.classList.remove('accordion-collapsed'); w.classList.add('accordion-expanded'); if(im) im.innerText='â–²'; if(id) id.innerText='â–² Thu gá»n'; } else { w.classList.remove('accordion-expanded'); w.classList.add('accordion-collapsed'); if(im) im.innerText='â–¼'; if(id) id.innerText='â–¼ Má»Ÿ rá»™ng'; } }
        function forceCollapseStory() { const w=document.getElementById('story-content-wrapper'); const im=document.getElementById('accordion-icon-mobile'); const id=document.getElementById('accordion-icon-desktop'); if(w) { w.classList.remove('accordion-expanded'); w.classList.add('accordion-collapsed'); if(im) im.innerText='â–¼'; if(id) id.innerText='â–¼ Má»Ÿ rá»™ng'; } }

        const STORY = [
            { id: 'intro', type: 'text', part: 'Má» Äáº¦U', title: 'Lá»i Nháº¯n Tá»« QuÃ¡ Khá»©', text: 'An, con trai yÃªu quÃ½ cá»§a ta. Náº¿u con Ä‘á»c Ä‘Æ°á»£c nhá»¯ng dÃ²ng nÃ y, cÃ³ láº½ ta Ä‘Ã£ khÃ´ng cÃ²n á»Ÿ bÃªn con. Háº¯c PhÃ¡p SÆ° Muá»™i Than - káº» thÃ¹ truyá»n kiáº¿p cá»§a HoÃ ng Gia - Ä‘Ã£ trá»—i dáº­y vÃ  báº¯t cÃ³c ta Ä‘á»ƒ chiáº¿m Ä‘oáº¡t bÃ­ máº­t vá» Thá»i Gian. Ta Ä‘Ã£ ká»‹p giáº¥u CÃ¢y ÄÃ¨n ChÃ¢n LÃ½ vÃ o gÃ³i bÆ°u pháº©m nÃ y. NÃ³ khÃ´ng chá»‰ lÃ  má»™t cÃ´ng cá»¥, mÃ  lÃ  ngÆ°á»i dáº«n Ä‘Æ°á»ng. HÃ£y láº¯ng nghe tiáº¿ng nÃ³i cá»§a Ã¡nh sÃ¡ng, nÃ³ sáº½ chá»‰ cho con con Ä‘Æ°á»ng cá»©u ta vÃ  cáº£ VÆ°Æ¡ng Quá»‘c Logic. HÃ£y dÅ©ng cáº£m lÃªn, con trai!', rules: null },
            { id: 'c1', type: 'game', game: 'switches', part: 'PHáº¦N 1: KHá»I Äáº¦U', title: 'ChÆ°Æ¡ng 1: CÄƒn NhÃ  Gá»—', text: 'Theo chá»‰ dáº«n cá»§a ngá»n Ä‘Ã¨n, An tÃ¬m Ä‘áº¿n cÄƒn nhÃ  gá»— bÃ¬a rá»«ng nÆ¡i ngÆ°á»i báº¡n trung thÃ nh cá»§a cha - ChÃº ChÃ³ VÃ ng - Ä‘ang bá»‹ giam giá»¯. CÄƒn phÃ²ng tá»‘i om, chá»‰ cÃ³ má»™t lá»“ng nÄƒng lÆ°á»£ng nhiá»‡t Ä‘ang nhá»‘t ChÃº ChÃ³. Äá»ƒ phÃ¡ lá»“ng, An cáº§n tÃ¬m Ä‘Ãºng cÃ´ng táº¯c kÃ­ch hoáº¡t trong 4 cÃ´ng táº¯c trÃªn tÆ°á»ng. Ngá»n Ä‘Ã¨n thÃ¬ tháº§m: "Ãnh sÃ¡ng khÃ´ng pháº£i lÃ  táº¥t cáº£, hÃ£y cáº£m nháº­n hÆ¡i áº¥m cÃ²n vÆ°Æ¡ng láº¡i..."', hint: 'Báº­t cÃ´ng táº¯c, Ä‘á»£i nÃ³ng, rá»“i táº¯t Ä‘i. BÃ³ng Ä‘Ã¨n táº¯t nhÆ°ng cÃ²n NÃ“NG chÃ­nh lÃ  chÃ¬a khÃ³a.', math: 'Logic Nhá»‹ phÃ¢n má»Ÿ rá»™ng (Tráº¡ng thÃ¡i thá»© 3).', rules: '<p>1. CÃ³ 4 cÃ´ng táº¯c (A, B, C, D) vÃ  4 bÃ³ng Ä‘Ã¨n (1, 2, 3, 4) trong phÃ²ng kÃ­n. Báº¡n khÃ´ng biáº¿t cÃ´ng táº¯c nÃ o ná»‘i vá»›i Ä‘Ã¨n nÃ o.</p><p>2. Báº¡n cÃ³ thá»ƒ Báº¬T/Táº®T cÃ´ng táº¯c tÃ¹y Ã½.</p><p>3. Nháº¥n "â±ï¸ Chá» 10 phÃºt" Ä‘á»ƒ cÃ¡c Ä‘Ã¨n Ä‘ang Báº¬T nÃ³ng lÃªn.</p><p>4. Sau khi thao tÃ¡c xong, nháº¥n "ğŸšª VÃ o PhÃ²ng" Ä‘á»ƒ kiá»ƒm tra tráº¡ng thÃ¡i (SÃ¡ng/Tá»‘i, NÃ³ng/áº¤m/Láº¡nh) cá»§a cÃ¡c bÃ³ng Ä‘Ã¨n.</p><p>5. <strong>Nhiá»‡m vá»¥:</strong> TÃ¬m chÃ­nh xÃ¡c cáº·p CÃ´ng táº¯c - BÃ³ng Ä‘Ã¨n tÆ°Æ¡ng á»©ng. (Chá»‰ Ä‘Æ°á»£c vÃ o phÃ²ng 1 láº§n).</p>', hint2: null, guide: null },
            { id: 'c2', type: 'game', game: 'jugs', part: 'PHáº¦N 1: KHá»I Äáº¦U', title: 'ChÆ°Æ¡ng 2: Suá»‘i Dáº§u Cáº¡n', text: 'Giáº£i cá»©u thÃ nh cÃ´ng, ChÃº ChÃ³ VÃ ng dáº«n An Ä‘áº¿n má»™t suá»‘i dáº§u cáº¡n. Táº¡i Ä‘Ã³, Robo Tin-Tin - há»™ vá»‡ khá»•ng lá»“ cá»§a cha - Ä‘ang náº±m báº¥t Ä‘á»™ng vÃ¬ cáº¡n kiá»‡t nÄƒng lÆ°á»£ng. LÃµi nÄƒng lÆ°á»£ng cá»§a Tin-Tin yÃªu cáº§u náº¡p chÃ­nh xÃ¡c 4 LÃ­t dáº§u Ä‘á»ƒ tÃ¡i khá»Ÿi Ä‘á»™ng. An chá»‰ tÃ¬m tháº¥y 3 chiáº¿c bÃ¬nh rá»—ng vá»›i dung tÃ­ch 8L, 5L vÃ  3L. Má»™t giá»t cÅ©ng khÃ´ng Ä‘Æ°á»£c sai!', hint: 'Táº­p trung vÃ o sá»± chÃªnh lá»‡ch. 5 - 3 = 2. LÃ m sao tá»« 2 ra 4?', hint2: 'GÃ¢u! MÃ¹i dáº§u á»Ÿ bÃ¬nh 5L vÃ  3L lÃ  ná»“ng nháº¥t, hÃ£y dÃ¹ng chÃºng Ä‘á»ƒ táº¡o ra sá»‘ dÆ°!', guide: null, math: 'PhÆ°Æ¡ng trÃ¬nh Diophantine: 5x + 3y = 4.', rules: '<p>1. Báº¡n cÃ³ 3 bÃ¬nh chá»©a vá»›i dung tÃ­ch tá»‘i Ä‘a lÃ  8L, 5L vÃ  3L. Ban Ä‘áº§u bÃ¬nh 8L Ä‘áº§y, 2 bÃ¬nh kia rá»—ng.</p><p>2. <strong>CÃ¡ch chÆ¡i:</strong> Nháº¥n vÃ o má»™t bÃ¬nh Ä‘á»ƒ chá»n lÃ m nguá»“n, sau Ä‘Ã³ nháº¥n vÃ o bÃ¬nh khÃ¡c Ä‘á»ƒ Ä‘á»• dáº§u sang.</p><p>3. Dáº§u sáº½ Ä‘Æ°á»£c Ä‘á»• cho Ä‘áº¿n khi bÃ¬nh nguá»“n cáº¡n HOáº¶C bÃ¬nh Ä‘Ã­ch Ä‘áº§y.</p><p>4. <strong>Nhiá»‡m vá»¥:</strong> Táº¡o ra chÃ­nh xÃ¡c 4 LÃ­t dáº§u trong báº¥t ká»³ bÃ¬nh nÃ o.</p>' },
            { id: 'c3', type: 'game', game: 'graph', part: 'PHáº¦N 1: KHá»I Äáº¦U', title: 'ChÆ°Æ¡ng 3: Cá»•ng ÄÃ¡ Cá»• Äáº¡i', text: 'Vá»›i sá»± gia nháº­p cá»§a Tin-Tin, cáº£ nhÃ³m tiáº¿n sÃ¢u vÃ o rá»«ng vÃ  bá»‹ cháº·n láº¡i bá»Ÿi má»™t Cá»•ng ÄÃ¡ Cá»• Äáº¡i khá»•ng lá»“. GiÃ¡o SÆ° Gáº¥u - nhÃ  nghiÃªn cá»©u cá»• ngá»¯ - Ä‘ang loay hoay trÆ°á»›c cá»•ng. "Cá»•ng nÃ y phong áº¥n báº±ng má»™t hÃ¬nh váº½ sao," GiÃ¡o SÆ° nÃ³i, "Äá»ƒ má»Ÿ nÃ³, ta pháº£i dÃ¹ng nÄƒng lÆ°á»£ng cá»§a Ä‘Ã¨n váº½ láº¡i toÃ n bá»™ hÃ¬nh ngÃ´i sao nÃ y báº±ng má»™t nÃ©t bÃºt liá»n máº¡ch, khÃ´ng Ä‘Æ°á»£c nháº¥c tay vÃ  khÃ´ng Ä‘Æ°á»£c váº½ láº¡i Ä‘Æ°á»ng Ä‘Ã£ Ä‘i."', hint: 'Äáº¿m sá»‘ Ä‘Æ°á»ng ná»‘i táº¡i má»—i Ä‘iá»ƒm. Báº¯t Ä‘áº§u tá»« Ä‘iá»ƒm cÃ³ sá»‘ Ä‘Æ°á»ng ná»‘i Láºº.', hint2: 'GÃ¢u! Äiá»ƒm gÃ³c dÆ°á»›i nÃ y cÃ³ mÃ¹i láº¡, hÃ£y báº¯t Ä‘áº§u tá»« Ä‘Ã³!', guide: 'Chá»‰ cÃ³ thá»ƒ báº¯t Ä‘áº§u tá»« má»™t trong hai Ä‘iá»ƒm á»Ÿ Ä‘Ã¡y (báº­c 5). Äi theo viá»n ngoÃ i rá»“i vÃ o trong.', math: 'ÄÆ°á»ng Ä‘i Euler: Äá»“ thá»‹ cÃ³ 0 hoáº·c 2 Ä‘á»‰nh báº­c láº».', rules: '<p>1. Báº¡n cáº§n váº½ láº¡i hÃ¬nh ngÃ´i sao trÃªn cá»•ng Ä‘Ã¡.</p><p>2. <strong>CÃ¡ch chÆ¡i:</strong> Nháº¥n vÃ o má»™t Ä‘iá»ƒm (node) Ä‘á»ƒ báº¯t Ä‘áº§u. Sau Ä‘Ã³ nháº¥n vÃ o cÃ¡c Ä‘iá»ƒm ká» nhau Ä‘á»ƒ di chuyá»ƒn.</p><p>3. <strong>Luáº­t:</strong> Báº¡n pháº£i Ä‘i qua Táº¤T Cáº¢ cÃ¡c Ä‘Æ°á»ng ná»‘i (cáº¡nh) mÃ u xÃ¡m Ä‘Ãºng 1 láº§n duy nháº¥t.</p><p>4. Náº¿u Ä‘i sai hoáº·c háº¿t Ä‘Æ°á»ng, nháº¥n nÃºt "â†º Reset" Ä‘á»ƒ lÃ m láº¡i.</p>' },
            { id: 'c4', type: 'game', game: 'river', part: 'PHáº¦N 2: HÃ€NH TRÃŒNH', title: 'ChÆ°Æ¡ng 4: CÃ¢y Cáº§u Äá»©t GÃ£y', text: 'Cá»•ng Ä‘Ã¡ má»Ÿ ra má»™t vá»±c tháº³m. CÃ¢y cáº§u treo duy nháº¥t Ä‘Ã£ bá»‹ Ä‘á»©t gÃ£y, chá»‰ hiá»‡n ra lá» má» dÆ°á»›i Ã¡nh sÃ¡ng cá»§a CÃ¢y ÄÃ¨n ChÃ¢n LÃ½. Má»™t Lá»¯ KhÃ¡ch BÃ­ áº¨n xuáº¥t hiá»‡n vÃ  xin Ä‘i nhá». Ngá»n Ä‘Ã¨n cáº£nh bÃ¡o nÄƒng lÆ°á»£ng chá»‰ cÃ²n Ä‘á»§ chiáº¿u sÃ¡ng trong 29 giÃ¢y. Cáº£ nhÃ³m pháº£i qua cáº§u trÆ°á»›c khi bÃ³ng tá»‘i nuá»‘t chá»­ng táº¥t cáº£. NhÆ°ng cÃ¢y cáº§u chá»‰ chá»‹u Ä‘Æ°á»£c tá»‘i Ä‘a 2 ngÆ°á»i má»™t lÃºc, vÃ  báº¯t buá»™c pháº£i cÃ³ ngÆ°á»i cáº§m Ä‘Ã¨n Ä‘á»ƒ soi Ä‘Æ°á»ng.', hint: 'Äá»«ng Ä‘á»ƒ ngÆ°á»i nhanh nháº¥t lÃ m má»i viá»‡c. HÃ£y Ä‘á»ƒ hai ngÆ°á»i cháº­m nháº¥t (Gáº¥u & Robo) Ä‘i cÃ¹ng nhau má»™t lÆ°á»£t.', hint2: 'GÃ¢u! Äá»ƒ tÃ´i cáº§m Ä‘Ã¨n cháº¡y vá» cho nhanh, tÃ´i cháº¡y cÃ³ 1 giÃ¢y thÃ´i!', guide: 'LÆ°á»£t quan trá»ng: Cho Gáº¥u (8s) vÃ  Robo (12s) Ä‘i cÃ¹ng nhau Ä‘á»ƒ "gÃ³i" thá»i gian cháº­m nháº¥t láº¡i.', math: 'BÃ i toÃ¡n láº­p lá»‹ch tá»‘i Æ°u (Critical Path).', rules: '<p>1. <strong>Má»¥c tiÃªu:</strong> ÄÆ°a táº¥t cáº£ 5 thÃ nh viÃªn (ChÃ³, An, KhÃ¡ch, Gáº¥u, Robo) qua bá» pháº£i trong vÃ²ng 29 giÃ¢y.</p><p>2. <strong>Tá»‘c Ä‘á»™:</strong> ChÃ³(1s), An(3s), KhÃ¡ch(6s), Gáº¥u(8s), Robo(12s).</p><p>3. <strong>Luáº­t Ä‘i:</strong><br>- Tá»‘i Ä‘a 2 ngÆ°á»i lÃªn cáº§u má»™t lÆ°á»£t.<br>- Pháº£i cÃ³ ngÆ°á»i cáº§m Ä‘Ã¨n (ğŸ®) má»›i Ä‘Æ°á»£c Ä‘i.<br>- Thá»i gian Ä‘i tÃ­nh theo ngÆ°á»i cháº­m nháº¥t trong lÆ°á»£t Ä‘Ã³.</p><p>4. <strong>CÃ¡ch chÆ¡i:</strong> Nháº¥n vÃ o nhÃ¢n váº­t Ä‘á»ƒ Ä‘Æ°a lÃªn/xuá»‘ng Ä‘Ã¨n. Nháº¥n nÃºt "BÄ‚NG QUA" (hoáº·c nÃºt trÃ²n "ÄI") Ä‘á»ƒ di chuyá»ƒn.</p>' },
            { id: 'c5', type: 'game', game: 'cat', part: 'PHáº¦N 2: HÃ€NH TRÃŒNH', title: 'ChÆ°Æ¡ng 5: Sá»± Pháº£n Bá»™i', text: 'Ngay khi qua cáº§u an toÃ n, Lá»¯ KhÃ¡ch BÃ­ áº¨n cÆ°á»i nham hiá»ƒm vÃ  hiá»‡n nguyÃªn hÃ¬nh lÃ  Háº¯c PhÃ¡p SÆ° Muá»™i Than! Háº¯n giáº­t láº¥y máº£nh báº£n Ä‘á»“ tá»« tay An rá»“i biáº¿n máº¥t vÃ o khu rá»«ng ma thuáº­t. Khu rá»«ng nÃ y cÃ³ 5 bá»¥i cÃ¢y lÆ°á»£ng tá»­, vÃ  háº¯n chá»‰ cÃ³ thá»ƒ láº©n trá»‘n trong Ä‘Ã³. Háº¯n cÃ³ thÃ³i quen ká»³ láº¡: má»—i khi báº¡n kiá»ƒm tra má»™t há»™p, háº¯n báº¯t buá»™c pháº£i nháº£y sang má»™t há»™p ngay bÃªn cáº¡nh.', hint: 'Náº¿u háº¯n á»Ÿ Ã´ Cháºµn, láº§n sau háº¯n pháº£i sang Láº». HÃ£y kiá»ƒm tra theo trÃ¬nh tá»±.', hint2: 'GÃ¢u! Háº¯n cÃ³ mÃ¹i á»Ÿ há»™p sá»‘ 2...', guide: 'Chiáº¿n thuáº­t "Dá»“n toa": Kiá»ƒm tra Ã´ 2, náº¿u khÃ´ng cÃ³, ngÃ y mai háº¯n cháº¯c cháº¯n á»Ÿ Ã´ láº».', math: 'Äá»“ thá»‹ lÆ°á»¡ng phÃ¢n (TÃ­nh cháºµn láº»/Parity).', rules: '<p>1. Háº¯c PhÃ¡p SÆ° trá»‘n trong 1 trong 5 há»™p (Ä‘Ã¡nh sá»‘ 1-5).</p><p>2. <strong>Má»—i lÆ°á»£t</strong>, báº¡n Ä‘Æ°á»£c phÃ©p chá»n má»Ÿ 1 há»™p Ä‘á»ƒ kiá»ƒm tra.</p><p>3. <strong>Sau má»—i láº§n kiá»ƒm tra</strong>, háº¯n Sáº¼ di chuyá»ƒn sang há»™p liá»n ká» (VD: tá»« 2 sang 1 hoáº·c 3).</p><p>4. <strong>Nhiá»‡m vá»¥:</strong> TÃ¬m ra vá»‹ trÃ­ chÃ­nh xÃ¡c cá»§a háº¯n trong tá»‘i Ä‘a 10 láº§n thá»­.</p>' },
            { id: 'c6', type: 'game', game: 'spider', part: 'PHáº¦N 2: HÃ€NH TRÃŒNH', title: 'ChÆ°Æ¡ng 6: VÃ¢y Báº¯t Nhá»‡n MÃ¡y', text: 'Bá»‹ dá»“n vÃ o Ä‘Æ°á»ng cÃ¹ng, Háº¯c PhÃ¡p SÆ° triá»‡u há»“i má»™t con Nhá»‡n MÃ¡y Khá»•ng Lá»“ Ä‘á»ƒ cháº·n Ä‘Æ°á»ng rá»“i tiáº¿p tá»¥c bá» cháº¡y. Con nhá»‡n di chuyá»ƒn cá»±c nhanh trÃªn máº¡ng lÆ°á»›i cá»§a nÃ³. An pháº£i sá»­ dá»¥ng kháº£ nÄƒng cá»§a CÃ¢y ÄÃ¨n Ä‘á»ƒ xÃ¢m nháº­p vÃ o há»‡ thá»‘ng radar, Ä‘iá»u khiá»ƒn cÃ¡c Ä‘iá»ƒm nÃºt trÃªn máº¡ng nhá»‡n Ä‘á»ƒ vÃ¢y báº¯t vÃ  vÃ´ hiá»‡u hÃ³a con quÃ¡i váº­t nÃ y trÆ°á»›c khi nÃ³ trá»‘n thoÃ¡t.', hint: 'Äá»«ng cháº¡y theo Ä‘uÃ´i. HÃ£y chiáº¿m cÃ¡c giao lá»™ quan trá»ng Ä‘á»ƒ cáº¯t Ä‘Æ°á»ng rÃºt lui.', hint2: 'GÃ¢u! Cháº·n Ä‘áº§u nÃ³ á»Ÿ cÃ¡i vÃ²ng ngoÃ i kia kÃ¬a!', guide: 'Chiáº¿n thuáº­t "Bao vÃ¢y": Äi vÃ o trung tÃ¢m trÆ°á»›c Ä‘á»ƒ kiá»ƒm soÃ¡t cÃ¡c hÆ°á»›ng ra.', math: 'LÃ½ thuyáº¿t trÃ² chÆ¡i Ä‘uá»•i báº¯t trÃªn Ä‘á»“ thá»‹.', rules: '<p>1. Báº¡n Ä‘iá»u khiá»ƒn Ä‘iá»ƒm mÃ u Xanh (ğŸ”µ), Nhá»‡n lÃ  Ä‘iá»ƒm mÃ u Há»“ng (ğŸ”´).</p><p>2. <strong>CÃ¡ch chÆ¡i:</strong> Nháº¥n vÃ o cÃ¡c Ä‘iá»ƒm nÃºt lÃ¢n cáº­n (cÃ³ Ä‘Æ°á»ng ná»‘i mÃ u tráº¯ng) Ä‘á»ƒ di chuyá»ƒn.</p><p>3. <strong>Luáº­t:</strong><br>- Báº¡n Ä‘i trÆ°á»›c 1 bÆ°á»›c, Nhá»‡n Ä‘i sau 1 bÆ°á»›c.<br>- Nhá»‡n sáº½ luÃ´n cá»‘ gáº¯ng di chuyá»ƒn ra xa báº¡n nháº¥t cÃ³ thá»ƒ.</p><p>4. <strong>Nhiá»‡m vá»¥:</strong> Báº¯t Ä‘Æ°á»£c Nhá»‡n (di chuyá»ƒn vÃ o cÃ¹ng vá»‹ trÃ­) trong tá»‘i Ä‘a 15 bÆ°á»›c Ä‘i cá»§a báº¡n.</p>' },
            { id: 'c7', type: 'game', game: 'horses', part: 'PHáº¦N 3: Äá»ˆNH CAO', title: 'ChÆ°Æ¡ng 7: Triá»‡u Há»“i Rá»“ng', text: 'VÆ°á»£t qua Nhá»‡n MÃ¡y, cáº£ nhÃ³m Ä‘áº¿n Ä‘Æ°á»£c chÃ¢n TÃ²a ThÃ¡p Thá»i Gian. Cáº§u thang Ä‘Ã£ bá»‹ phÃ¡ há»§y. CÃ¡ch duy nháº¥t Ä‘á»ƒ lÃªn Ä‘á»‰nh lÃ  nhá» sá»± trá»£ giÃºp cá»§a loÃ i Rá»“ng. Táº¡i Tráº¡i Rá»“ng gáº§n Ä‘Ã³, cÃ³ 25 con rá»“ng Ä‘ang ngá»§ say. An cáº§n Ä‘Ã¡nh thá»©c 3 con rá»“ng nhanh nháº¥t Ä‘á»ƒ Ä‘Æ°a má»i ngÆ°á»i lÃªn Ä‘á»‰nh thÃ¡p. KhÃ´ng cÃ³ thiáº¿t bá»‹ Ä‘o thá»i gian, An chá»‰ cÃ³ thá»ƒ tá»• chá»©c cÃ¡c cuá»™c Ä‘ua giá»¯a chÃºng Ä‘á»ƒ xÃ¡c Ä‘á»‹nh thá»© háº¡ng.', hint: 'Chia 25 con thÃ nh 5 nhÃ³m Ä‘ua. Loáº¡i bá» nhá»¯ng con khÃ´ng thá»ƒ náº±m trong Top 3 dá»±a trÃªn tÃ­nh cháº¥t báº¯c cáº§u.', hint2: 'GÃ¢u! (KÃ­nh LÃºp) Máº¥y con vá» bÃ©t á»Ÿ vÃ²ng loáº¡i cháº¯c cháº¯n loáº¡i rá»“i!', guide: 'Äua 5 nhÃ³m Ä‘áº§u. Láº¥y 5 con nháº¥t Ä‘ua vá»›i nhau (Láº§n 6). Tá»« Ä‘Ã³ loáº¡i trá»« tiáº¿p.', math: 'Thuáº­t toÃ¡n sáº¯p xáº¿p vÃ  lá»±a chá»n tá»‘i Æ°u.', rules: '<p>1. CÃ³ 25 con rá»“ng vá»›i tá»‘c Ä‘á»™ khÃ¡c nhau (báº¡n khÃ´ng biáº¿t tá»‘c Ä‘á»™ cá»¥ thá»ƒ).</p><p>2. ÄÆ°á»ng Ä‘ua chá»‰ cho phÃ©p tá»‘i Ä‘a 5 con rá»“ng cháº¡y cÃ¹ng lÃºc.</p><p>3. Sau má»—i cuá»™c Ä‘ua, báº¡n chá»‰ biáº¿t thá»© tá»± vá» Ä‘Ã­ch (nháº¥t, nhÃ¬, ba...), khÃ´ng biáº¿t thá»i gian.</p><p>4. <strong>CÃ¡ch chÆ¡i:</strong> Chá»n 2-5 con rá»“ng tá»« "Tráº¡i Rá»“ng" Ä‘Æ°a vÃ o "ÄÆ°á»ng Äua", rá»“i nháº¥n "ÄUA".</p><p>5. <strong>Nhiá»‡m vá»¥:</strong> XÃ¡c Ä‘á»‹nh chÃ­nh xÃ¡c 3 con rá»“ng nhanh nháº¥t (theo thá»© tá»± #1, #2, #3) vá»›i sá»‘ láº§n Ä‘ua Ã­t nháº¥t (Tá»‘i Æ°u: 7 láº§n).</p>' },
            { id: 'c8', type: 'game', game: 'balls', part: 'PHáº¦N 3: Äá»ˆNH CAO', title: 'ChÆ°Æ¡ng 8: TrÃ¡i Tim Thá»i Gian', text: 'Äá»‰nh thÃ¡p! Cha cá»§a An Ä‘ang bá»‹ giam giá»¯ trong má»™t khá»‘i pha lÃª thá»i gian. Háº¯c PhÃ¡p SÆ° Ä‘Ã£ trá»™n LÃµi Thá»i Gian tháº­t vÃ o 12 quáº£ cáº§u nÄƒng lÆ°á»£ng giá»‘ng há»‡t nhau. Háº¯n cÆ°á»i nháº¡o: "Chá»‰ cÃ³ LÃµi tháº­t má»›i phÃ¡ Ä‘Æ°á»£c pha lÃª. Náº¿u chá»n sai, cha ngÆ°Æ¡i sáº½ bá»‹ káº¹t trong dÃ²ng thá»i gian mÃ£i mÃ£i!". Chiáº¿c cÃ¢n thÄƒng báº±ng cá»• xÆ°a á»Ÿ giá»¯a phÃ²ng lÃ  hy vá»ng duy nháº¥t. An chá»‰ cÃ³ 3 láº§n cÃ¢n Ä‘á»ƒ tÃ¬m ra quáº£ cáº§u chá»©a LÃµi tháº­t vÃ  biáº¿t nÃ³ Náº·ng hay Nháº¹ hÆ¡n cÃ¡c quáº£ khÃ¡c.', hint: 'Chia 12 quáº£ thÃ nh 3 nhÃ³m (4-4-4). CÃ¢n nhÃ³m 1 vÃ  2 sáº½ loáº¡i trá»« Ä‘Æ°á»£c nhiá»u nháº¥t.', hint2: null, guide: 'Láº§n 1: CÃ¢n 1,2,3,4 vs 5,6,7,8. Náº¿u cÃ¢n báº±ng -> Lá»—i á»Ÿ nhÃ³m cÃ²n láº¡i.', math: 'CÃ¢y quyáº¿t Ä‘á»‹nh tam phÃ¢n (Ternary Search Tree).', rules: '<p>1. CÃ³ 12 quáº£ cáº§u (Ä‘Ã¡nh sá»‘ 1-12). Má»™t quáº£ lÃ  giáº£ (khÃ¡c khá»‘i lÆ°á»£ng), 11 quáº£ cÃ²n láº¡i lÃ  tháº­t (cÃ¹ng khá»‘i lÆ°á»£ng).</p><p>2. Báº¡n cÃ³ má»™t chiáº¿c cÃ¢n thÄƒng báº±ng vÃ  Ä‘Æ°á»£c phÃ©p cÃ¢n tá»‘i Ä‘a 3 láº§n.</p><p>3. <strong>CÃ¡ch chÆ¡i:</strong><br>- Nháº¥n chá»n "ÄÄ©a TrÃ¡i" hoáº·c "ÄÄ©a Pháº£i".<br>- Nháº¥n vÃ o cÃ¡c quáº£ bÃ³ng Ä‘á»ƒ Ä‘áº·t lÃªn Ä‘Ä©a cÃ¢n Ä‘Ã£ chá»n.<br>- Nháº¥n "âš–ï¸ CÃ‚N NGAY" Ä‘á»ƒ xem káº¿t quáº£ (TrÃ¡i náº·ng, Pháº£i náº·ng, hoáº·c CÃ¢n báº±ng).</p><p>4. <strong>Nhiá»‡m vá»¥:</strong> Sau 3 láº§n cÃ¢n, xÃ¡c Ä‘á»‹nh chÃ­nh xÃ¡c quáº£ bÃ³ng nÃ o lÃ  giáº£ vÃ  nÃ³ Náº·ng hay Nháº¹ hÆ¡n bÃ³ng tháº­t.</p>' }
        ];

        class GameSwitches { constructor(){this.reset()} reset(){this.map={};let s=['A','B','C','D'].sort(()=>Math.random()-0.5);[1,2,3,4].forEach((n,i)=>this.map[n]=s[i]);this.sw={A:{on:false,heat:0},B:{on:false,heat:0},C:{on:false,heat:0},D:{on:false,heat:0}};this.time=0;this.entered=false;this.render()} toggle(k){if(!this.entered){this.sw[k].on=!this.sw[k].on;playSound('click');this.render()}} wait(){if(!this.entered){this.time+=10;Object.keys(this.sw).forEach(k=>{if(this.sw[k].on)this.sw[k].heat+=10});playSound('click');this.render()}} enter(){this.entered=true;this.render()} check(){let c=0;[1,2,3,4].forEach(n=>{if(document.getElementById(`sel-${n}`).value===this.map[n])c++});if(c===4)GameManager.win(this.time<=20);else{playSound('fail');
            /* SHOW ANSWER IN UI */
            const ui=document.getElementById('game-stage').querySelector('.grid');
            if(ui) {
               [1,2,3,4].forEach(n => {
                   const sel = document.getElementById(`sel-${n}`);
                   if(sel) {
                       sel.value = this.map[n]; 
                       sel.classList.add('bg-red-900', 'border-red-500', 'text-red-200');
                   }
               });
               showToast('Sai rá»“i! Äang Reset...', 'error'); 
               GameManager.autoResetGame(4000);
            }
        }} render(){ const s = document.getElementById('game-stage'); if(!s) return; if(!this.entered){ s.innerHTML=`<div class="flex flex-col items-center w-full h-full justify-start pt-4 overflow-y-auto pb-20"><div class="grid grid-cols-2 md:grid-cols-4 gap-4 w-full max-w-5xl mb-8">${['A','B','C','D'].map(k=>`<button onclick="window.ActiveGame.toggle('${k}')" class="bulb-btn h-32 md:h-40 rounded-2xl border-2 border-slate-600 text-3xl font-bold flex flex-col items-center justify-center transition-all ${this.sw[k].on?'bulb-on':'bulb-off'} shadow-lg w-full hover:scale-105"><span class="text-5xl mb-2">ğŸ’¡</span><span>${k}</span><span class="text-xs opacity-70 font-normal mt-2 bg-black/30 px-3 py-1 rounded-full border border-white/20">${this.sw[k].on?'ON':'OFF'}</span></button>`).join('')}</div><div class="md:hidden fixed bottom-0 left-0 w-full flex z-50"><button onclick="window.ActiveGame.wait()" class="flex-1 py-5 bg-slate-800 hover:bg-slate-700 text-white font-bold text-lg border-r border-slate-700 rounded-none">â±ï¸ Chá» 10 phÃºt</button><button onclick="window.ActiveGame.enter()" class="flex-1 py-5 bg-rose-700 hover:bg-rose-600 text-white font-bold text-lg rounded-none">ğŸšª VÃ o PhÃ²ng</button></div><div class="hidden md:flex gap-4 w-full max-w-lg mt-auto"><button onclick="window.ActiveGame.wait()" class="flex-1 py-4 bg-slate-700 hover:bg-slate-600 rounded-xl font-bold text-white text-lg shadow-xl border border-slate-500 active:scale-95 transition-transform">â±ï¸ Chá» 10 phÃºt</button><button onclick="window.ActiveGame.enter()" class="flex-1 py-4 bg-rose-600 hover:bg-rose-500 rounded-xl font-bold text-white text-lg uppercase shadow-xl border border-rose-400 active:scale-95 transition-transform">ğŸšª VÃ o PhÃ²ng</button></div></div>`; }else{ s.innerHTML=`<div class="flex flex-col items-center w-full h-full justify-start pt-4 overflow-y-auto pb-24"><div class="grid grid-cols-1 md:grid-cols-4 gap-6 w-full max-w-6xl mb-8 px-4">${[1,2,3,4].map(n=>{const st=this.sw[this.map[n]];let txt='Táº®T',sub='Láº NH',cls='bulb-off';if(st.on){txt='Báº¬T';sub='NÃ“NG';cls='bulb-on'}else if(st.heat>=15){sub='NÃ“NG';cls='heat-high text-white'}else if(st.heat>0){sub='áº¤M';cls='heat-med text-slate-300'}return `<div class="flex flex-row md:flex-col gap-4 w-full bg-slate-800/50 p-4 rounded-2xl border border-slate-700 items-center shadow-md"><div class="${cls} h-24 w-24 md:w-full md:h-32 rounded-xl border-2 flex flex-col items-center justify-center shadow-lg transition-all shrink-0"><span class="text-xs font-bold opacity-50 mb-1">ÄÃ¨n ${n}</span><span class="text-xl font-black mb-1">${txt}</span><span class="text-[10px] font-bold uppercase tracking-widest bg-black/20 px-2 py-0.5 rounded-full">${sub}</span></div><select id="sel-${n}" class="flex-1 md:w-full p-4 bg-slate-900 border-2 border-slate-600 rounded-xl text-white font-bold cursor-pointer hover:border-indigo-500 outline-none text-center appearance-none text-base shadow-md"><option value="">Chá»n cÃ´ng táº¯c...</option><option value="A">CÃ´ng táº¯c A</option><option value="B">CÃ´ng táº¯c B</option><option value="C">CÃ´ng táº¯c C</option><option value="D">CÃ´ng táº¯c D</option></select></div>`}).join('')}</div><div class="fixed bottom-0 left-0 w-full p-4 bg-slate-900/90 border-t border-slate-700 z-50 flex justify-center"><button onclick="window.ActiveGame.check()" class="w-full max-w-md py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl text-xl shadow-xl hover:scale-105 transition-transform">KIá»‚M TRA ÄÃP ÃN</button></div></div>`; } 
            if(document.getElementById('game-metric')) document.getElementById('game-metric').innerText=`${this.time} phÃºt`; } getHint(t){ return ""; } 
        }

        class GameJugs { constructor(){this.reset()} reset(){this.jugs=[8,0,0];this.caps=[8,5,3];this.moves=0;this.sel=null;this.render()} click(i){if(this.sel===null){if(this.jugs[i]>0){this.sel=i;playSound('click')}}else{if(this.sel!==i)this.pour(this.sel,i);this.sel=null}this.render()} pour(f,t){const a=Math.min(this.jugs[f],this.caps[t]-this.jugs[t]);if(a>0){this.jugs[f]-=a;this.jugs[t]+=a;this.moves++;playSound('click')}if(this.jugs.includes(4))GameManager.win(this.moves===6)} render(){ document.getElementById('game-metric').innerText=`${this.moves} bÆ°á»›c`; const hArr = [320, 200, 120]; const h=this.jugs.map((v,i)=>{ const cls=this.sel===i?'jug-selected':'border-slate-500'; const pct = (v/this.caps[i])*100; return `<div onclick="window.ActiveGame.click(${i})" style="height:${[320,200,120][i]}px" class="jug-container ${cls} flex-shrink-0"><div class="jug-water" style="height:${pct}%"></div><div class="absolute inset-0 flex items-center justify-center font-bold text-white drop-shadow-md z-10 text-3xl">${v}L</div></div>` }).join(''); document.getElementById('game-stage').innerHTML=`<div class="flex flex-col items-center justify-center h-full w-full py-8 flex-1 pt-20"><div class="flex-1 flex items-end justify-center gap-2 w-full pb-12 h-full">${h}</div><div class="text-slate-400 font-bold text-xl mb-4">Chá»n bÃ¬nh nguá»“n â” Chá»n bÃ¬nh Ä‘Ã­ch</div></div>` } getHint(t){ if(t==='dog') return "GÃ¢u! MÃ¹i dáº§u á»Ÿ bÃ¬nh 5L vÃ  3L lÃ  ná»“ng nháº¥t, hÃ£y dÃ¹ng chÃºng Ä‘á»ƒ táº¡o ra sá»‘ dÆ°!"; return ""; } }
        class GameGraph { constructor(){this.reset()} reset(){this.nodes={1:{x:275,y:50},2:{x:175,y:130},3:{x:375,y:130},4:{x:175,y:230},5:{x:375,y:230},6:{x:175,y:330},7:{x:375,y:330},8:{x:275,y:410}};this.edges=[{u:1,v:2},{u:1,v:3},{u:2,v:3},{u:2,v:4},{u:2,v:5},{u:3,v:4},{u:3,v:5},{u:4,v:5},{u:4,v:6},{u:5,v:7},{u:6,v:7},{u:6,v:8},{u:7,v:8}];this.curr=null;this.visited=new Set();this.path=[];this.bt=0; document.getElementById('game-stage').innerHTML=`<div class="w-full h-full flex items-center justify-center p-0 m-0 overflow-hidden"><canvas id="graph-canvas" class="w-full h-full"></canvas></div>`; this.resizeObserver=new ResizeObserver(()=>window.requestAnimationFrame(()=>this.draw()));this.resizeObserver.observe(document.getElementById('game-stage'));setTimeout(()=>this.draw(),50)} click(e){const c=e.target,r=c.getBoundingClientRect(),scale=(window.innerWidth>=768)?Math.min(c.width/550,c.height/450)*0.9:Math.min(c.width/550,c.height/450)*1.2,offX=(c.width-550*scale)/2,offY=(c.height-450*scale)/2,lx=(e.clientX-r.left-offX)/scale,ly=(e.clientY-r.top-offY)/scale;let h=null;for(let k in this.nodes){if(Math.hypot(lx-this.nodes[k].x,ly-this.nodes[k].y)<50)h=parseInt(k)}if(h){if(this.curr===null){this.curr=h;this.path.push(h);playSound('click')}else if(this.path.length>1&&h===this.path[this.path.length-2]){const u=Math.min(this.curr,h),v=Math.max(this.curr,h),ei=this.edges.findIndex(e=>e.u===u&&e.v===v);this.visited.delete(ei);this.path.pop();this.curr=h;this.bt++;playSound('click')}else{const u=Math.min(this.curr,h),v=Math.max(this.curr,h),ei=this.edges.findIndex(e=>e.u===u&&e.v===v);if(ei>-1&&!this.visited.has(ei)){this.visited.add(ei);this.path.push(h);this.curr=h;playSound('click')}}this.draw();if(this.visited.size===13)GameManager.win(this.bt===0)}} draw(){const c=document.getElementById('graph-canvas');if(!c)return;c.onclick=(e)=>this.click(e);const con=c.parentElement;c.width=con.clientWidth;c.height=con.clientHeight;const ctx=c.getContext('2d'),scale=(window.innerWidth>=768)?Math.min(c.width/550,c.height/450)*0.9:Math.min(c.width/550,c.height/450)*1.2,offX=(c.width-550*scale)/2,offY=(c.height-450*scale)/2;ctx.setTransform(scale,0,0,scale,offX,offY);ctx.clearRect(-offX/scale,-offY/scale,c.width/scale,c.height/scale);ctx.lineWidth=8;this.edges.forEach((e,i)=>{const n1=this.nodes[e.u],n2=this.nodes[e.v];ctx.beginPath();ctx.moveTo(n1.x,n1.y);ctx.lineTo(n2.x,n2.y);ctx.strokeStyle=this.visited.has(i)?'#fbbf24':'#475569';ctx.stroke()});for(let k in this.nodes){const n=this.nodes[k];ctx.beginPath();ctx.arc(n.x,n.y,28,0,6.28);ctx.fillStyle=parseInt(k)===this.curr?'#fbbf24':'#3b82f6';if(this.curr===null)ctx.fillStyle='#fbbf24';ctx.fill();ctx.fillStyle='white';ctx.font='bold 24px Arial';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(k,n.x,n.y)}document.getElementById('game-metric').innerText=`${13-this.visited.size} cáº¡nh`} getHint(t){ if(t==='dog') return "GÃ¢u! Äiá»ƒm gÃ³c dÆ°á»›i nÃ y cÃ³ mÃ¹i láº¡, hÃ£y báº¯t Ä‘áº§u tá»« Ä‘Ã³!"; if(t==='robo') return "Dá»¯ liá»‡u: Äiá»ƒm báº¯t Ä‘áº§u pháº£i cÃ³ sá»‘ Ä‘Æ°á»ng ná»‘i lÃ  sá»‘ láº»."; return ""; } }
        class GameRiver { constructor(){this.reset()} reset(){this.L=[1,3,6,8,12];this.R=[];this.lamp=[];this.side='L';this.time=0;this.names={1:'ğŸ•',3:'ğŸ‘¦',6:'ğŸ§™â€â™‚ï¸',8:'ğŸ»',12:'ğŸ¤–'};this.render()} move(id,loc){if(loc===this.side){if(this.lamp.length<2){this[this.side]=this[this.side].filter(x=>x!==id);this.lamp.push(id);playSound('click')}}else if(loc==='lamp'){this.lamp=this.lamp.filter(x=>x!==id);this[this.side].push(id);playSound('click')}this.render()} go(){if(this.lamp.length===0){showToast('Cáº§n ngÆ°á»i cáº§m Ä‘Ã¨n!', 'error');playSound('fail');return}this.time+=Math.max(...this.lamp);this.side=this.side==='L'?'R':'L';this.render();playSound('click');
            /* STRICT FAIL LOGIC */
            if(this.time > 30) {
                showToast('Tháº¥t báº¡i! QuÃ¡ 30 giÃ¢y.', 'error');
                GameManager.autoResetGame(1000);
                return;
            }
            if(this.L.length===0&&this.side==='R')setTimeout(()=>GameManager.win(this.time<=29),500)} render(){ document.getElementById('game-metric').innerText=`${this.time}s`; const d=(arr,loc)=>arr.map(id=>`<div onclick="window.ActiveGame.move(${id},'${loc}')" class="char-card bg-slate-700 p-2 rounded-lg border-2 border-slate-500 flex flex-col items-center justify-center shadow-lg cursor-pointer transform active:scale-95 w-full"><span class="char-emoji text-2xl md:text-3xl">${this.names[id].split(' ')[0]}</span><span class="font-bold text-emerald-400 text-xs md:text-sm">${id}s</span></div>`).join(''); const desktopHTML = `<div class="bridge-layout shadow-2xl relative w-full h-[600px] flex"><div class="cliff-side"><div class="col-span-full text-xs font-black text-slate-500 w-full text-center mb-2 tracking-widest uppercase">VÃCH TRÃI</div>${d(this.L,'L')}</div><div class="bridge-zone"><div class="bridge-cable"></div><div class="lamp-carrier ${this.side==='L'?'pos-left':'pos-right'}"><div class="absolute -top-10 text-4xl animate-pulse">ğŸ®</div>${this.lamp.map(id=>`<div onclick="window.ActiveGame.move(${id},'lamp')" class="char-card bg-amber-900/90 border-amber-500 p-1 rounded-lg text-center z-30 transform hover:scale-110 shadow-xl" style="width:50px; height:50px; min-height:0;"><div class="text-xl">${this.names[id].split(' ')[0]}</div></div>`).join('')}</div><button onclick="window.ActiveGame.go()" class="btn-go-round hover:scale-105">ÄI</button></div><div class="cliff-side right"><div class="col-span-full text-xs font-black text-slate-500 w-full text-center mb-2 tracking-widest uppercase">VÃCH PHáº¢I</div>${d(this.R,'R')}</div></div>`; const mobileHTML = `<div class="bridge-layout shadow-2xl relative"><div class="cliff-side"><div class="col-span-full text-xs font-black text-slate-500 w-full text-center mb-2 tracking-widest uppercase">VÃCH TRÃI</div>${d(this.L,'L')}</div><div class="bridge-zone"><div class="bridge-track-area w-full md:w-full relative h-full"><div class="bridge-cable"></div><div class="lamp-carrier ${this.side==='L'?'pos-left':'pos-right'}"><div class="absolute -top-10 text-4xl animate-pulse">ğŸ®</div>${this.lamp.map(id=>`<div onclick="window.ActiveGame.move(${id},'lamp')" class="char-card bg-amber-900/90 border-amber-500 p-1 rounded-lg text-center z-30 transform hover:scale-110 shadow-xl" style="width:50px; height:50px; min-height:0;"><div class="text-xl">${this.names[id].split(' ')[0]}</div></div>`).join('')}</div></div></div><div class="cliff-side right"><div class="col-span-full text-xs font-black text-slate-500 w-full text-center mb-2 tracking-widest uppercase">VÃCH PHáº¢I</div>${d(this.R,'R')}</div><div class="w-full p-4 mt-2 flex justify-center pb-8"><button onclick="window.ActiveGame.go()" class="btn-go-mobile">BÄ‚NG QUA</button></div></div>`; const content = window.innerWidth >= 768 ? desktopHTML : mobileHTML; document.getElementById('game-stage').innerHTML = `<div class="w-full max-w-5xl mx-auto flex flex-col h-full md:justify-center md:pt-10 pb-20">${content}</div>`; } getHint(t){ if(t==='dog') return "GÃ¢u! Äá»ƒ tÃ´i cáº§m Ä‘Ã¨n cháº¡y vá» cho nhanh, tÃ´i cháº¡y cÃ³ 1 giÃ¢y thÃ´i!"; if(t==='bear') return "Chiáº¿n thuáº­t: LÆ°á»£t Ä‘i quan trá»ng nháº¥t hÃ£y cho 2 ngÆ°á»i cháº­m nháº¥t Ä‘i cÃ¹ng nhau."; if(t==='robo') return "TÃ­nh toÃ¡n: Cáº§n tá»‘i Æ°u lÆ°á»£t Ä‘i Ä‘á»ƒ giáº£m tá»•ng thá»i gian chá» xuá»‘ng dÆ°á»›i 29s."; return ""; } }
        class GameCat { constructor(){this.reset()} reset(){this.day=1;this.pos=new Set([1,2,3,4,5]);this.logs=[];this.render()} check(i){if(this.pos.has(i)){if(this.pos.size===1)GameManager.win(this.day<=6);else this.pos.delete(i)}const n=new Set();this.pos.forEach(p=>{if(p>1)n.add(p-1);if(p<5)n.add(p+1)});this.pos=n;this.logs.unshift(`Láº§n ${this.day}: Há»™p ${i} -> Trá»‘ng.`);this.day++;this.render(); if(this.day > 10) { showToast("Tháº¥t báº¡i! QuÃ¡ 10 ngÃ y.", "error"); setTimeout(()=>this.giveUp(), 1500); }} 
        giveUp(){
            let current = Array.from(this.pos)[0] || 1;
            let sequence = [current];
            for(let i=0; i<5; i++) {
                let next = (current === 1) ? 2 : (current === 5) ? 4 : (Math.random()>0.5 ? current-1 : current+1);
                sequence.push(next);
                current = next;
            }
            this.logs.unshift(`<div class="text-amber-500 font-bold">Lá»™ trÃ¬nh Háº¯c PhÃ¡p SÆ° (ÄÃ¡p Ã¡n): ${sequence.join(" â†’ ")}</div>`);
            this.render();
            GameManager.autoResetGame(4000);
        }
        render(){ document.getElementById('game-metric').innerText=`Láº§n ${this.day}`; const boxes = [1,2,3,4,5].map(i=>`<button onclick="window.ActiveGame.check(${i})" class="box-btn h-24 md:h-40 flex-1 bg-slate-800 border-4 border-slate-600 rounded-2xl text-5xl md:text-7xl font-black text-slate-500 hover:text-indigo-400 hover:border-indigo-500 quantum-active transition-all shadow-xl">${i}</button>`).join(''); const logs = this.logs.map(l=>`<div class="flex justify-between text-sm md:text-base text-slate-400 mb-2 border-b border-slate-800 pb-1 font-mono"><span>${l}</span></div>`).join(''); document.getElementById('game-stage').innerHTML=`<div class="flex flex-col items-center gap-8 w-full max-w-4xl h-full justify-center pt-4 pb-8"><div class="flex gap-3 w-full justify-center">${boxes}</div><div class="text-slate-400 font-mono text-sm mb-2">Kháº£ nÄƒng áº©n náº¥p: <span class="text-indigo-400 font-bold text-2xl">${this.pos.size}</span> vá»‹ trÃ­</div><div class="w-full bg-slate-950/50 p-6 rounded-2xl border border-slate-800 h-64 flex-1 overflow-y-auto shadow-inner"><div class="text-xs font-bold text-slate-500 mb-4 uppercase tracking-widest border-b border-slate-800 pb-2 sticky top-0 bg-slate-950/90">Lá»ŠCH Sá»¬ Má» Há»˜P</div>${logs || '<div class="text-center text-slate-600 italic mt-10 text-lg">...</div>'}</div></div>`} getHint(t){ if(t==='dog') return "GÃ¢u! Háº¯n cÃ³ mÃ¹i á»Ÿ há»™p sá»‘ 2..."; if(t==='bear') return "Chiáº¿n thuáº­t 'Dá»“n toa': Kiá»ƒm tra Ã´ 2, náº¿u khÃ´ng cÃ³, ngÃ y mai háº¯n cháº¯c cháº¯n á»Ÿ Ã´ láº»."; if(t==='robo') return "Dá»¯ liá»‡u: Tráº¡ng thÃ¡i thay Ä‘á»•i luÃ¢n phiÃªn Cháºµn/Láº» sau má»—i bÆ°á»›c."; return ""; } }
        class GameSpider { 
            constructor(){this.reset()} 
            reset(){
                this.player=12; this.spider=4; this.moves=15; this.over=false; this.adj = {}; this.adj[0] = [1,2,3,4,5]; 
                for(let r=0; r<4; r++) { for(let ray=0; ray<5; ray++) { const id = 1 + (r*5) + ray; if(!this.adj[id]) this.adj[id] = []; if(ray > 0) this.adj[id].push(id - 1); if(ray < 4) this.adj[id].push(id + 1); if(r===0) { this.adj[id].push(0); } else { this.adj[id].push(id - 5); } if(r<3) { this.adj[id].push(id + 5); } } } 
                this.player = 18; this.spider = 20; 
                document.getElementById('game-stage').innerHTML=`<div class="w-full h-full flex flex-col items-center justify-center p-4" style="touch-action:none; overflow:hidden;"><div class="spider-frame relative w-full h-full flex items-center justify-center" id="spider-wrapper"><div class="absolute top-4 left-4 text-white font-bold text-xl z-10 flex items-center gap-2 pointer-events-none"><span class="text-3xl">ğŸ•¸ï¸</span> VÃ¢y Báº¯t</div><canvas id="spider-canvas" width="600" height="600" style="max-width:100%; max-height:100%; object-fit:contain"></canvas></div></div>`; 
                this.draw(); 
                this.initPanZoom();
            } 
            
            initPanZoom() {
                const wrapper = document.getElementById('spider-wrapper');
                const canvas = document.getElementById('spider-canvas');
                let scale = 1, panning = false, pointX = 0, pointY = 0, start = { x: 0, y: 0 };
                wrapper.onmousedown = (e) => { e.preventDefault(); start = { x: e.clientX - pointX, y: e.clientY - pointY }; panning = true; }
                wrapper.onmouseup = () => { panning = false; }
                wrapper.onmousemove = (e) => { if (!panning) return; e.preventDefault(); pointX = (e.clientX - start.x); pointY = (e.clientY - start.y); canvas.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`; }
                wrapper.addEventListener('wheel', (e) => { e.preventDefault(); scale += e.deltaY * -0.001; scale = Math.min(Math.max(.5, scale), 3); canvas.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`; });
            }
            
            // BFS for Node Distance
            getDist(start, end) {
                let q = [[start, 0]]; let visited = new Set([start]);
                while(q.length > 0) {
                    let [node, d] = q.shift();
                    if(node === end) return d;
                    (this.adj[node]||[]).forEach(n => {
                        if(!visited.has(n)) { visited.add(n); q.push([n, d+1]); }
                    });
                }
                return 999;
            }

            getPos(id){ const cx=300, cy=520; if(id===0) return {x:cx, y:cy}; const val = id-1; const ring = Math.floor(val/5); const ray = val % 5; const maxDists = [300, 420, 480, 420, 300]; const maxDist = maxDists[ray]; const ratio = (ring + 1) / 4; const dist = ratio * maxDist; const startAngle = -150 * (Math.PI/180); const step = 30 * (Math.PI/180); const angle = startAngle + (ray * step); return { x: cx + dist * Math.cos(angle), y: cy + dist * Math.sin(angle) }; } 
            
            getMousePos(canvas, evt) {
                var rect = canvas.getBoundingClientRect();
                return { x: (evt.clientX - rect.left) * (canvas.width / rect.width), y: (evt.clientY - rect.top) * (canvas.height / rect.height) };
            }

            click(e){ 
                if(this.over)return; 
                const canvas = document.getElementById('spider-canvas');
                const pos = this.getMousePos(canvas, e);
                let bestNode = -1; let minDist = 9999; 
                for(let i=0; i<=20; i++){ const p = this.getPos(i); const dist = Math.hypot(pos.x-p.x, pos.y-p.y); if(dist < minDist){ minDist = dist; bestNode = i; } } 
                /* FIX HITBOX to 40px */ 
                if(bestNode !== -1 && minDist < 40){ 
                    if(this.adj[this.player].includes(bestNode)){ 
                        this.player = bestNode; playSound('click'); 
                        if(this.player===this.spider) this.win(); 
                        else { this.moves--; document.getElementById('game-metric').innerText=`${this.moves} bÆ°á»›c`; if(this.moves===0) this.fail(); else setTimeout(()=>this.ai(),300) } 
                        this.draw() 
                    } 
                } 
            } 
            ai(){ 
                if(this.over)return; 
                const nb=this.adj[this.spider]; 
                let best=-1, maxDist=-1; 
                nb.forEach(n=>{ 
                    const d = this.getDist(n, this.player); // Use BFS Distance
                    if(n!==this.player){ if(d > maxDist){ maxDist = d; best = n; } } 
                }); 
                if(best===-1) best=nb[0]; 
                this.spider=best; playSound('click'); 
                if(this.player===this.spider) this.win(); 
                this.draw(); 
            } 
            win(){this.over=true;GameManager.win(15-this.moves<=10)} 
            fail(){this.over=true;showToast('Tháº¥t báº¡i! Háº¿t bÆ°á»›c.', 'error');playSound('fail'); GameManager.autoResetGame(1000); } 
            draw(){ 
                const cvs=document.getElementById('spider-canvas'); if(!cvs)return;
                cvs.width = 600; cvs.height = 600; cvs.onclick=(e)=>this.click(e); 
                const ctx=cvs.getContext('2d'); ctx.clearRect(0,0,600,600); 
                const cx=300, cy=520; ctx.lineWidth=2; ctx.strokeStyle='#475569'; 
                for(let r=0; r<4; r++) { ctx.beginPath(); for(let ray=0; ray<5; ray++) { const id = 1 + (r*5) + ray; const p = this.getPos(id); if(ray===0) ctx.moveTo(p.x, p.y); else ctx.lineTo(p.x, p.y); } ctx.stroke(); } 
                for(let ray=0; ray<5; ray++) { ctx.beginPath(); ctx.moveTo(cx, cy); const outerId = 1 + (3*5) + ray; const p = this.getPos(outerId); ctx.lineTo(p.x, p.y); ctx.stroke(); } 
                for(let i=0; i<=20; i++){ const p=this.getPos(i); const isNeighbor = this.adj[this.player].includes(i); ctx.beginPath(); ctx.arc(p.x,p.y, i===0?15:10, 0, 6.28); if(i===this.player) { ctx.fillStyle='#3b82f6'; ctx.shadowBlur=20; ctx.shadowColor='#3b82f6'; } else if(i===this.spider) { ctx.fillStyle='#f472b6'; ctx.shadowBlur=20; ctx.shadowColor='#f472b6'; } else if(isNeighbor) { ctx.fillStyle='#94a3b8'; ctx.shadowBlur=0; } else { ctx.fillStyle='#1e293b'; ctx.shadowBlur=0; } ctx.fill(); if(isNeighbor) { ctx.lineWidth=2; ctx.strokeStyle='white'; ctx.stroke(); } ctx.shadowBlur=0; } ctx.fillStyle = '#ef4444'; ctx.font="bold 12px sans-serif"; ctx.textAlign="center"; ctx.fillText("O", cx, cy+30); 
            } 
            getHint(t){ if(t==='dog') return "GÃ¢u! Cháº·n Ä‘áº§u nÃ³ á»Ÿ cÃ¡i vÃ²ng ngoÃ i kia kÃ¬a!"; if(t==='bear') return "Chiáº¿n thuáº­t 'Bao vÃ¢y': Äi vÃ o trung tÃ¢m trÆ°á»›c Ä‘á»ƒ kiá»ƒm soÃ¡t cÃ¡c hÆ°á»›ng ra."; if(t==='robo') return "Dá»¯ liá»‡u: Chiáº¿m lÄ©nh cÃ¡c Ä‘iá»ƒm trung tÃ¢m Ä‘á»ƒ thu háº¹p vÃ¹ng di chuyá»ƒn."; return ""; } 
        }
        class GameHorses { 
            constructor(){this.reset()} 
            reset(){
                this.track=[];this.races=0;
                this.pool=Array.from({length:25},(_,i)=>i+1);
                // RIGGED LOGIC: Put #1 and #2 in SAME initial group
                let s=Array.from({length:25},(_,i)=>i+1); 
                let group = Math.floor(Math.random()*5); 
                let idx1 = group*5 + Math.floor(Math.random()*5);
                let idx2 = group*5 + Math.floor(Math.random()*5);
                while(idx1 === idx2) idx2 = group*5 + Math.floor(Math.random()*5); 
                let temp = [...s]; temp = temp.filter(x => x!==1 && x!==2);
                for(let i=temp.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[temp[i],temp[j]]=[temp[j],temp[i]]}
                this.speeds = {}; let tempIdx = 0;
                for(let i=0; i<25; i++) {
                    if(i === idx1) this.speeds[i+1] = 1;
                    else if (i === idx2) this.speeds[i+1] = 2;
                    else this.speeds[i+1] = temp[tempIdx++];
                }
                this.renderHTML();
            } 
            renderHTML(){ document.getElementById('game-stage').innerHTML=`<div class="flex flex-col w-full h-full pb-10 px-4 overflow-y-auto pt-6"><div class="bg-slate-800 p-4 rounded-2xl border-2 border-slate-600 min-h-[100px] flex items-center justify-center gap-3 shadow-lg mb-4 sticky top-0 z-10"><div class="text-slate-500 text-xs font-black uppercase mr-2 tracking-widest">ÄÆ¯á»œNG ÄUA</div><div id="horse-track-container" class="flex gap-2"></div><button onclick="window.ActiveGame.race()" class="px-6 py-2 bg-pink-600 hover:bg-pink-500 rounded-xl font-black text-white shadow-lg text-sm uppercase tracking-wider active:scale-95">ÄUA</button></div><div class="flex flex-col lg:flex-row gap-6 flex-1"><div class="w-full lg:w-1/2 bg-slate-800 p-4 rounded-2xl border-2 border-slate-600 flex-1 flex-col"><div class="w-full text-slate-500 text-xs font-black uppercase mb-3 border-b border-slate-700 pb-2">TRáº I Rá»’NG</div><div id="horse-pool-container" class="grid grid-cols-5 gap-3 place-items-center"></div></div><div class="w-full lg:w-1/2 flex flex-col gap-4"><div class="bg-slate-800 p-4 rounded-2xl border-2 border-slate-600 flex-1 min-h-[200px] flex flex-col"><div class="text-xs font-black text-indigo-400 mb-3 uppercase tracking-widest border-b border-indigo-900 pb-2">THÃ€NH TÃCH</div><div id="horse-logs" class="log-box flex-1 text-base space-y-3"></div></div><div class="p-5 bg-indigo-950/50 border-2 border-indigo-800 rounded-2xl shrink-0"><div class="text-xs font-black text-indigo-400 mb-3 uppercase tracking-widest">Dá»° ÄOÃN TOP 3</div><div class="flex space-x-3 mb-4"><input type="number" id="h-pred-1" placeholder="#1" class="bg-slate-900 border-2 border-slate-600 rounded-lg p-3 w-full text-white text-center text-lg font-bold outline-none"><input type="number" id="h-pred-2" placeholder="#2" class="bg-slate-900 border-2 border-slate-600 rounded-lg p-3 w-full text-white text-center text-lg font-bold outline-none"><input type="number" id="h-pred-3" placeholder="#3" class="bg-slate-900 border-2 border-slate-600 rounded-lg p-3 w-full text-white text-center text-lg font-bold outline-none"></div><button onclick="window.ActiveGame.check()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-xl text-base uppercase shadow-lg active:scale-95">Gá»¬I Káº¾T QUáº¢</button></div></div></div></div>`; this.updateUI(); } updateUI(){document.getElementById('game-metric').innerText=`Cuá»™c Ä‘ua #${this.races}`;document.getElementById('horse-track-container').innerHTML=this.track.map(id=>`<div class="horse" onclick="window.ActiveGame.toggle(${id})">${id}</div>`).join('');document.getElementById('horse-pool-container').innerHTML=this.pool.sort((a,b)=>a-b).map(id=>`<div class="horse bg-slate-700 border-slate-500 text-slate-300 hover:bg-slate-600 hover:border-slate-300" onclick="window.ActiveGame.toggle(${id})">${id}</div>`).join('')} toggle(id){const p=this.pool.indexOf(id);if(p>-1){if(this.track.length<5){this.pool.splice(p,1);this.track.push(id);playSound('click')}}else{const t=this.track.indexOf(id);if(t>-1){this.track.splice(t,1);this.pool.push(id);playSound('click')}}this.pool.sort((a,b)=>a-b);this.updateUI()} race(){
                if(this.races >= 7) { showToast("Háº¿t lÆ°á»£t Ä‘ua (Max 7)", "error"); setTimeout(()=>this.giveUp(), 1500); return; }
                if(this.track.length<2)return;
                this.races++;
                const r=[...this.track].sort((a,b)=>this.speeds[a]-this.speeds[b]);
                const l=document.getElementById('horse-logs');
                l.innerHTML=`<div class="mb-3 pb-2 border-b border-slate-700"><div class="text-pink-400 font-bold mb-1">Race #${this.races}</div><div class="flex flex-wrap gap-2 text-xs text-white">${r.map((h,i)=>`<span class="${i===0?'text-emerald-400 font-bold':''}">#${i+1}: ${h}</span>`).join('<span class="text-slate-500 mx-1">|</span>')}</div></div>`+l.innerHTML;
                this.pool.push(...this.track);this.track=[];this.updateUI();
            } 
            check(){const p1=parseInt(document.getElementById('h-pred-1').value),p2=parseInt(document.getElementById('h-pred-2').value),p3=parseInt(document.getElementById('h-pred-3').value);if(!p1||!p2||!p3){showToast("Nháº­p Ä‘á»§ 3!", 'warning');return}const s=Object.keys(this.speeds).sort((a,b)=>this.speeds[a]-this.speeds[b]);if(p1==s[0]&&p2==s[1]&&p3==s[2])GameManager.win(this.races<=7);else{playSound('fail');showToast("Sai rá»“i!", 'error'); setTimeout(()=>this.giveUp(), 1500);}} 
            giveUp(){
                const s=Object.keys(this.speeds).sort((a,b)=>this.speeds[a]-this.speeds[b]);
                const l=document.getElementById('horse-logs');
                l.innerHTML=`<div class="text-amber-400 font-bold mt-2">ÄÃP ÃN: #1:${s[0]} | #2:${s[1]} | #3:${s[2]}</div>` + l.innerHTML;
                GameManager.autoResetGame(4000);
            }
            useGlass(){ const l = document.getElementById('horse-logs'); const slowest = Object.keys(this.speeds).sort((a,b)=>this.speeds[b]-this.speeds[a]).slice(0,5); l.innerHTML=`<div class="mb-3 pb-2 border-b border-yellow-500/50 bg-yellow-900/20 p-2 rounded"><div class="text-yellow-400 font-bold mb-1">ğŸ” KÃNH LÃšP PHÃT HIá»†N:</div><div class="text-slate-300 text-sm">5 Rá»“ng cháº­m nháº¥t: ${slowest.join(', ')}</div></div>`+l.innerHTML; } 
            getHint(t){ if(t==='dog') return "GÃ¢u! Máº¥y con vá» bÃ©t á»Ÿ vÃ²ng loáº¡i cháº¯c cháº¯n loáº¡i rá»“i!"; if(t==='bear') return "Äua 5 nhÃ³m Ä‘áº§u. Láº¥y 5 con nháº¥t Ä‘ua vá»›i nhau (Láº§n 6). Tá»« Ä‘Ã³ loáº¡i trá»« tiáº¿p."; if(t==='robo') return "Thuáº­t toÃ¡n: Sá»­ dá»¥ng tÃ­nh cháº¥t báº¯c cáº§u (A>B, B>C => A>C) Ä‘á»ƒ loáº¡i bá» dá»¯ liá»‡u thá»«a."; return ""; } 
        }
        class GameBalls { constructor(){this.reset()} reset(){this.pool=Array.from({length:12},(_,i)=>i+1);this.L=[];this.R=[];this.weighs=3;
            // FIX: RANDOM FAKE 3-10
            this.fake=Math.floor(Math.random()*8)+3; 
            this.heavy=Math.random()>0.5;this.selPan=null;this.render();
            let safe1, safe2;
            do { safe1 = Math.floor(Math.random() * 12) + 1; } while (safe1 === this.fake);
            do { safe2 = Math.floor(Math.random() * 12) + 1; } while (safe2 === this.fake || safe2 === safe1);
            this.magnetSafe = safe1;
            this.dogSafe = safe2;
        } selectPan(s){this.selPan=(this.selPan===s)?null:s;this.updateUI()} click(id){if(this.L.includes(id)){this.L=this.L.filter(x=>x!==id);this.pool.push(id)}else if(this.R.includes(id)){this.R=this.R.filter(x=>x!==id);this.pool.push(id)}else{if(!this.selPan){showToast("Chá»n Ä‘Ä©a cÃ¢n trÆ°á»›c!", 'warning');return}this.pool=this.pool.filter(x=>x!==id);if(this.selPan==='L')this.L.push(id);else this.R.push(id)}this.pool.sort((a,b)=>a-b);this.L.sort((a,b)=>a-b);this.R.sort((a,b)=>a-b);playSound('click');this.updateUI()} weigh(){ if(this.weighs<=0)return;this.weighs--; const arm=document.getElementById('scale-arm'); let res=0; if(this.L.length>this.R.length)res=-1;else if(this.R.length>this.L.length)res=1;else{if(this.L.includes(this.fake))res=this.heavy?-1:1;else if(this.R.includes(this.fake))res=this.heavy?1:-1} if(res===-1){ arm.classList.add('tilt-left'); } else if(res===1){ arm.classList.add('tilt-right'); } else { arm.classList.add('balanced-anim'); } const txt=res===0?"CÃ‚N Báº°NG":(res===-1?"TRÃI Náº¶NG":"PHáº¢I Náº¶NG"); document.getElementById('balls-logs').innerHTML=`<div class="mb-3 pb-2 border-b border-slate-700 flex flex-col"><div class="text-amber-400 font-bold text-base">Láº§n #${3-this.weighs}: ${txt}</div><div class="text-slate-400 text-xs mt-1 leading-relaxed">L:[${this.L}] <br> R:[${this.R}]</div></div>`+document.getElementById('balls-logs').innerHTML; setTimeout(()=>{ arm.classList.remove('tilt-left','tilt-right','balanced-anim'); this.pool.push(...this.L, ...this.R); this.L=[]; this.R=[]; this.pool.sort((a,b)=>a-b); this.updateUI(); },2500); this.updateUI(); 
            if(this.weighs===0) setTimeout(()=>showToast("Háº¿t lÆ°á»£t cÃ¢n! HÃ£y Ä‘oÃ¡n ngay.", "warning"), 3000);
        } 
        check(){const id=parseInt(document.getElementById('balls-guess-id').value),st=document.getElementById('balls-guess-status').value;if(!id||!st){showToast("Chá»n bÃ³ng!", 'warning');return}if(id===this.fake&&st===(this.heavy?'Heavy':'Light'))GameManager.win(true);else{playSound('fail');showToast("Sai rá»“i!", 'error'); setTimeout(()=>this.giveUp(), 1500);}} 
        giveUp(){
            const l = document.getElementById('balls-logs');
            l.innerHTML=`<div class="text-amber-400 font-bold mt-2">ÄÃP ÃN: BÃ³ng ${this.fake} lÃ  bÃ³ng ${this.heavy?'Náº¶NG':'NHáº¸'}</div>` + l.innerHTML;
            GameManager.autoResetGame(3000);
        }
        render(){ document.getElementById('game-stage').innerHTML=`<div class="flex flex-col lg:flex-row gap-8 w-full max-w-7xl items-start h-full pb-10 overflow-y-auto pt-6"><div class="w-full lg:w-2/3 flex flex-col items-center justify-center min-h-[450px]"><div class="relative w-full max-w-xl mx-auto mb-8 mt-4"><div class="flex justify-between items-end px-4 mb-[-5px] gap-8"><div id="pan-container-L" class="pan-container w-[45%] flex flex-col items-center cursor-pointer group" onclick="window.ActiveGame.selectPan('L')"><div class="text-xs font-bold text-slate-500 mb-2 group-hover:text-white transition-colors uppercase tracking-widest">ÄÄ©a TrÃ¡i</div><div id="pan-L" class="pan w-full border-4 border-slate-500 group-hover:border-slate-300 transition-colors shadow-2xl bg-slate-800/50"></div><div class="h-12 w-2 bg-slate-500 mt-[-2px]"></div></div><div id="pan-container-R" class="pan-container w-[45%] flex flex-col items-center cursor-pointer group" onclick="window.ActiveGame.selectPan('R')"><div class="text-xs font-bold text-slate-500 mb-2 group-hover:text-white transition-colors uppercase tracking-widest">ÄÄ©a Pháº£i</div><div id="pan-R" class="pan w-full border-4 border-slate-500 group-hover:border-slate-300 transition-colors shadow-2xl bg-slate-800/50"></div><div class="h-12 w-2 bg-slate-500 mt-[-2px]"></div></div></div><div class="scale-arm-wrapper"><div id="scale-arm" class="scale-arm shadow-xl border border-slate-600"></div><div class="scale-pivot"></div></div></div><button onclick="window.ActiveGame.weigh()" class="px-12 py-4 bg-indigo-600 hover:bg-indigo-500 rounded-full font-black text-white shadow-2xl text-xl uppercase tracking-widest transition-transform hover:scale-105 mb-8 border-4 border-indigo-400/30">âš–ï¸ CÃ‚N NGAY</button><div class="w-full bg-slate-800 p-6 rounded-2xl border-2 border-slate-600 shadow-inner"><div class="text-xs font-bold text-slate-500 mb-3 uppercase tracking-widest">KHO BÃ“NG</div><div id="balls-pool" class="flex flex-wrap justify-start gap-3 min-h-[80px]"></div></div></div><div class="w-full lg:w-1/3 flex flex-col gap-4 h-full"><div class="bg-slate-800 p-4 rounded-2xl border-2 border-slate-600 flex-1 min-h-[250px] flex flex-col max-h-[60vh]"><div class="text-xs font-black text-indigo-400 mb-3 uppercase tracking-widest border-b border-indigo-900 pb-2">Lá»ŠCH Sá»¬ CÃ‚N</div><div id="balls-logs" class="log-box flex-1 text-base space-y-2"></div></div><div class="p-5 bg-emerald-900/30 border-2 border-emerald-700 rounded-2xl"><div class="text-xs font-black text-emerald-400 mb-3 uppercase tracking-widest">ÄÃP ÃN</div><div class="flex gap-3 mb-4"><select id="balls-guess-id" class="bg-slate-900 border-2 border-slate-600 rounded-xl p-3 text-white w-1/2 font-bold outline-none focus:border-emerald-500"><option value="">BÃ³ng #</option>${Array.from({length:12},(_,i)=>`<option value="${i+1}">${i+1}</option>`).join('')}</select><select id="balls-guess-status" class="bg-slate-900 border-2 border-slate-600 rounded-xl p-3 text-white w-1/2 font-bold outline-none focus:border-emerald-500"><option value="">?</option><option value="Heavy">Náº·ng</option><option value="Light">Nháº¹</option></select></div><button onclick="window.ActiveGame.check()" class="w-full py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl text-base uppercase shadow-lg transition-transform hover:scale-105">KIá»‚M TRA</button></div></div></div>`; this.updateUI(); } updateUI(){ document.getElementById('game-metric').innerText=`${this.weighs} láº§n`; const b=(id)=>`<div onclick="event.stopPropagation(); window.ActiveGame.click(${id})" class="ball text-base shadow-md flex items-center justify-center hover:scale-110 border-2 border-indigo-500/30 transition-transform cursor-pointer font-bold">${id}</div>`; document.getElementById('balls-pool').innerHTML = this.pool.map(b).join(''); document.getElementById('pan-L').innerHTML = this.L.map(b).join(''); document.getElementById('pan-R').innerHTML = this.R.map(b).join(''); const pL = document.getElementById('pan-L'), pR = document.getElementById('pan-R'); if(this.selPan === 'L') { pL.parentElement.classList.add('scale-105'); pL.classList.add('selected-pan'); pR.classList.remove('selected-pan'); pR.parentElement.classList.remove('scale-105'); } else if(this.selPan === 'R') { pR.parentElement.classList.add('scale-105'); pR.classList.add('selected-pan'); pL.classList.remove('selected-pan'); pL.parentElement.classList.remove('scale-105'); } else { pL.classList.remove('selected-pan'); pR.classList.remove('selected-pan'); pL.parentElement.classList.remove('scale-105'); pR.parentElement.classList.remove('scale-105'); } } 
            useMagnet(){ const l = document.getElementById('balls-logs'); l.innerHTML=`<div class="mb-3 pb-2 border-b border-red-500/50 bg-red-900/20 p-2 rounded"><div class="text-red-400 font-bold mb-1">ğŸ§² NAM CHÃ‚M HÃšT:</div><div class="text-slate-300 text-sm">BÃ³ng sá»‘ #${this.magnetSafe} khÃ´ng bá»‹ hÃºt (LÃ  bÃ³ng tháº­t)</div></div>`+l.innerHTML; } 
            getHint(t){ 
                if(t==='dog') return `GÃ¢u! GÃ¢u! MÅ©i tÃ´i ngá»­i tháº¥y bÃ³ng sá»‘ <b>#${this.dogSafe}</b> cÃ³ mÃ¹i giá»‘ng cÃ¡c quáº£ khÃ¡c, nÃ³ lÃ  bÃ³ng THáº¬T Ä‘áº¥y!`;
                if(t==='bear') return "Chia 12 quáº£ thÃ nh 3 nhÃ³m (4-4-4). CÃ¢n nhÃ³m 1 vÃ  2 sáº½ loáº¡i trá»« Ä‘Æ°á»£c nhiá»u nháº¥t."; 
                if(t==='robo') return "Dá»¯ liá»‡u: CÃ¢y quyáº¿t Ä‘á»‹nh Tam phÃ¢n (3^3 = 27 trÆ°á»ng há»£p) Ä‘á»§ Ä‘á»ƒ tÃ¬m 1/12."; 
                return ""; 
            } 
        }

        const GameManager = {
            idx:0, gears:0, progress:{}, isTransitioning: false, visited: {}, 
            unlockedCompanions: new Set(), inventory: new Set(), usedSkills: {}, usedItems: {},

            init(){
                const s=localStorage.getItem('an_v52_save');
                if(s){
                    const d=JSON.parse(s);
                    this.idx=d.idx; this.gears=d.gears; this.progress=d.prog; this.visited=d.visited || {};
                    this.unlockedCompanions = new Set(d.unlockedCompanions || []);
                    this.inventory = new Set(d.inventory || []);
                    this.usedSkills = d.usedSkills || {};
                    this.usedItems = d.usedItems || {};
                }
                this.renderSidebar(); this.loadContent();
            },
            save(){
                localStorage.setItem('an_v52_save',JSON.stringify({
                    idx:this.idx, gears:this.gears, prog:this.progress, visited:this.visited,
                    unlockedCompanions: Array.from(this.unlockedCompanions),
                    inventory: Array.from(this.inventory),
                    usedSkills: this.usedSkills, usedItems: this.usedItems
                }));
            },
            resetJourney(){ openModal('reset-modal'); },
            confirmReset(){ localStorage.removeItem('an_v52_save'); location.reload(); },
            autoResetGame(delay){
                setTimeout(() => {
                    if(window.ActiveGame && window.ActiveGame.reset) {
                        window.ActiveGame.reset();
                        showToast("ÄÃ£ tá»± Ä‘á»™ng lÃ m má»›i mÃ n chÆ¡i.", "event");
                    }
                }, delay);
            },
            renderSidebar(){
                const nav=document.getElementById('sidebar-nav'), mob=document.getElementById('mobile-nav-list');
                const inv=document.getElementById('inventory-grid');
                const mobInv=document.getElementById('mobile-inventory');
                const isCollapsed = document.getElementById('desktop-sidebar')?.classList.contains('sidebar-collapsed');
                
                if(nav) nav.innerHTML=''; if(mob) mob.innerHTML=''; if(inv) inv.innerHTML=''; if(mobInv) mobInv.innerHTML='';
                if(document.getElementById('gear-count')) document.getElementById('gear-count').innerText=`${this.gears}/8`;
                if(document.getElementById('mobile-gear')) document.getElementById('mobile-gear').innerText=`${this.gears} âš™ï¸`;

                const items = [
                    {id:'glass', icon:'ğŸ”', name:'KÃ­nh LÃºp', game: 'horses'},
                    {id:'magnet', icon:'ğŸ§²', name:'Nam ChÃ¢m', game: 'balls'}
                ];
                
                items.forEach(it => {
                    if(this.inventory.has(it.id)) {
                        const currentStory = STORY[this.idx];
                        const isUsable = currentStory && currentStory.game === it.game;
                        const isUsed = this.usedItems[this.idx]?.[it.id];
                        
                        const cls = `item-slot ${isUsed ? 'used' : (isUsable ? 'usable cursor-pointer hover:bg-slate-700' : 'opacity-50')}`;
                        const onclick = isUsable && !isUsed ? `GameManager.useItem('${it.id}')` : '';
                        
                        const el = `<div class="${cls}" title="${it.name}" onclick="${onclick}">${it.icon}</div>`;
                        if(inv) inv.innerHTML += el;
                        if(mobInv) mobInv.innerHTML += el;
                    }
                });

                let cur='';
                STORY.forEach((d,i)=>{
                    if(d.type==='text')return;
                    if(d.part!==cur){
                        cur=d.part;
                        if(nav)nav.innerHTML+=`<div class="nav-part-header text-xs font-bold text-slate-500 uppercase tracking-widest mt-4 mb-2 pl-2 border-l-2 border-indigo-500/30 whitespace-nowrap overflow-hidden text-ellipsis" title="${cur}">${isCollapsed ? '' : cur}</div>`
                    }
                    const p=this.progress[d.id];let st='text-slate-500 cursor-not-allowed',ic='ğŸ”’';
                    const prev=STORY[i-1];
                    if(i===0||i<=this.idx||(prev&&this.progress[prev.id]?.done))st='text-slate-300 hover:bg-slate-800 cursor-pointer';
                    if(i===this.idx) st='text-indigo-400 bg-indigo-950/30 border-r-2 border-indigo-500 font-bold';
                    if(p&&p.done){st='text-emerald-400';ic='âœ…'}
                    if(p&&p.opt){st='text-amber-400 font-bold';ic='âš™ï¸'}
                    
                    // Nav Item Structure
                    const shortTitle = d.title.split(':')[1] || d.title;
                    const el = `<div class="flex items-center px-3 py-2 rounded-md transition-all mb-1 gap-2 ${st}" onclick="GameManager.jump(${i})" title="${d.title}">
                        <span class="text-lg min-w-[24px] text-center">${ic}</span>
                        <span class="truncate text-sm nav-text ${isCollapsed ? 'hidden' : ''}">${shortTitle}</span>
                    </div>`;
                    
                    if(nav)nav.innerHTML+=el; if(mob)mob.innerHTML+=el;
                })
                
                if(mob) {
                    mob.innerHTML += `<div class="mt-6 pt-4 border-t border-slate-800"><button onclick="openModal('reset-modal')" class="w-full py-3 bg-red-900/30 hover:bg-red-900/50 text-red-400 font-bold rounded-lg flex items-center justify-center gap-2"><span>ğŸ—‘ï¸</span> XÃ“A HÃ€NH TRÃŒNH</button></div>`;
                }
            },
            useItem(itemId) {
                if(this.usedItems[this.idx]?.[itemId]) return;
                if(itemId === 'glass' && window.ActiveGame.useGlass) window.ActiveGame.useGlass();
                if(itemId === 'magnet' && window.ActiveGame.useMagnet) window.ActiveGame.useMagnet();
                if(!this.usedItems[this.idx]) this.usedItems[this.idx] = {};
                this.usedItems[this.idx][itemId] = true;
                this.save(); this.renderSidebar();
                showToast("ÄÃ£ sá»­ dá»¥ng váº­t pháº©m!", 'event');
            },
            useSkill(compId) {
                if(this.usedSkills[this.idx]?.[compId]) return;
                const content = window.ActiveGame.getHint(compId);
                document.getElementById(`content-${compId}`).innerHTML = content;
                document.getElementById(`content-${compId}`).classList.add('visible');
                document.getElementById(`btn-${compId}`).classList.remove('available');
                document.getElementById(`btn-${compId}`).classList.add('used');
                document.getElementById(`btn-${compId}`).innerText = "ÄÃ£ sá»­ dá»¥ng";
                if(!this.usedSkills[this.idx]) this.usedSkills[this.idx] = {};
                this.usedSkills[this.idx][compId] = true;
                this.save();
            },
            loadContent(){
                const d=STORY[this.idx];
                if (d.id === 'intro') { document.body.classList.add('intro-active'); forceCollapseStory(); } 
                else { document.body.classList.remove('intro-active'); }

                if (document.getElementById('chapter-tag-mobile')) document.getElementById('chapter-tag-mobile').innerText = d.title.split(':')[0];
                if (document.getElementById('story-title-mobile')) document.getElementById('story-title-mobile').innerText = d.title.split(':')[1] || d.title;
                if (document.getElementById('part-tag')) document.getElementById('part-tag').innerText=d.part;
                if (document.getElementById('chapter-tag')) document.getElementById('chapter-tag').innerText=d.title;
                if (document.getElementById('story-title')) document.getElementById('story-title').innerText=d.title;
                if (document.getElementById('story-text')) document.getElementById('story-text').innerText=d.text;
                
                const hText = document.getElementById('hint-text'); if(hText) hText.innerText = d.hint || 'KhÃ´ng cÃ³ gá»£i Ã½.';

                ['dog', 'bear', 'robo'].forEach(id => {
                    const btn = document.getElementById(`btn-${id}`);
                    const content = document.getElementById(`content-${id}`);
                    const tab = document.getElementById(`comp-${id}`);
                    if(tab) {
                        if(this.unlockedCompanions.has(id)) {
                            tab.classList.remove('opacity-50');
                            document.querySelector(`#comp-${id} .status-text`).innerText = "Sáºµn sÃ ng";
                            if(this.usedSkills[this.idx]?.[id]) {
                                 btn.className = 'skill-btn used'; btn.innerText = 'ÄÃ£ sá»­ dá»¥ng';
                                 if(window.ActiveGame && window.ActiveGame.getHint) {
                                     content.innerHTML = window.ActiveGame.getHint(id);
                                     content.classList.add('visible');
                                 }
                            } else {
                                 btn.className = 'skill-btn available'; btn.innerText = 'KÃCH HOáº T (1 Láº§n)';
                                 content.innerHTML = ''; content.classList.remove('visible');
                            }
                        } else {
                            tab.classList.add('opacity-50');
                            document.querySelector(`#comp-${id} .status-text`).innerText = "ChÆ°a gáº·p";
                            btn.className = 'skill-btn used'; btn.innerText = '???';
                            content.classList.remove('visible');
                        }
                    }
                });

                const rulesSection = document.getElementById('game-rules-section');
                const rulesText = document.getElementById('game-rules-text');
                if (d.rules) { rulesText.innerHTML = d.rules; rulesSection.classList.remove('hidden'); } else { rulesSection.classList.add('hidden'); }
                
                const gw=document.getElementById('game-container'),ph=document.getElementById('placeholder');
                const b1=document.getElementById('btn-play');
                if(gw) gw.classList.add('hidden'); if(ph) ph.classList.remove('hidden');
                
                const vic = document.getElementById('victory-overlay');
                if(!vic.classList.contains('victory-visible') || d.id !== 'c1') { 
                    vic.classList.remove('victory-visible'); vic.classList.remove('is-story-overlay'); vic.style.pointerEvents = 'none'; vic.innerHTML = ''; 
                }
                document.getElementById('hint-modal').style.display = 'none';
                
                if(window.innerWidth >= 768) {
                    document.body.classList.add('desktop-game-active');
                    const wrap = document.getElementById('story-content-wrapper');
                    const id = document.getElementById('accordion-icon-desktop');
                    if(wrap) { wrap.classList.remove('accordion-collapsed'); wrap.classList.add('accordion-expanded'); }
                    if(id) id.innerText='â–² Thu gá»n';
                } else {
                    document.body.classList.remove('desktop-game-active');
                }

                if (d.id === 'c1' && !this.visited['c1']) {
                     const storyHTML = `<div class="max-w-2xl bg-slate-900 p-8 rounded-2xl border border-slate-700 shadow-2xl relative animate-fade-in mx-4"><div class="text-xs font-black text-indigo-400 uppercase tracking-widest mb-4">CHÆ¯Æ NG 1</div><h2 class="text-3xl font-serif font-bold text-white mb-4">${d.title.split(':')[1]}</h2><div class="text-slate-300 text-base leading-relaxed mb-8 max-h-[60vh] overflow-y-auto">${d.text}</div><button onclick="GameManager.closeStoryOverlay()" class="w-full py-4 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-xl uppercase tracking-wider transition-transform active:scale-95">TIáº¾P Tá»¤C</button></div>`;
                     vic.innerHTML = storyHTML; vic.classList.add('victory-visible'); vic.classList.add('is-story-overlay'); vic.style.pointerEvents = 'auto';
                     this.visited['c1'] = true; this.save();
                }

                if(d.type!=='text'){ this.playLevel(); }
                if(d.type==='text'){ if(b1) {b1.classList.remove('hidden');b1.innerText="Báº®T Äáº¦U";} }else{ if(b1) {b1.classList.remove('hidden');b1.innerText="Báº®T Äáº¦U / TIáº¾P Tá»¤C";} }
                setTimeout(() => { this.isTransitioning = false; }, 500);
            },
            toggleSidebar() {
                const sidebar = document.getElementById('desktop-sidebar');
                const btn = document.getElementById('toggle-sidebar-btn');
                sidebar.classList.toggle('sidebar-collapsed');
                
                if (sidebar.classList.contains('sidebar-collapsed')) {
                    btn.innerHTML = 'Â»';
                    document.getElementById('btn-reset-journey').innerHTML = '<span>ğŸ—‘ï¸</span>'; // Show only icon
                    document.getElementById('gear-count').classList.add('hidden'); // Hide gear count text
                } else {
                    btn.innerHTML = 'Â«';
                    document.getElementById('btn-reset-journey').innerHTML = `<span>ğŸ—‘ï¸</span> <span id="btn-reset-text">XÃ“A HÃ€NH TRÃŒNH</span>`;
                    document.getElementById('gear-count').classList.remove('hidden');
                }
                this.renderSidebar(); // Re-render to hide/show nav text
            },
            switchTab(tab) {
                document.querySelectorAll('.hint-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.hint-content').forEach(c => c.classList.remove('active'));
            },
            closeStoryOverlay() { const vic = document.getElementById('victory-overlay'); vic.classList.remove('victory-visible'); vic.classList.remove('is-story-overlay'); vic.style.pointerEvents = 'none'; this.playLevel(); },
            playLevel(){
                const d=STORY[this.idx];
                forceCollapseStory();
                if(d.type==='text'){this.next();return}
                document.getElementById('game-container').classList.remove('hidden');
                document.getElementById('placeholder').classList.add('hidden');
                if (document.getElementById('game-msg')) document.getElementById('game-msg').innerText="";
                if(window.ActiveGame && window.ActiveGame.reset) window.ActiveGame = null;
                
                if(d.game==='switches')window.ActiveGame=new GameSwitches();
                if(d.game==='jugs')window.ActiveGame=new GameJugs();
                if(d.game==='graph')window.ActiveGame=new GameGraph();
                if(d.game==='river')window.ActiveGame=new GameRiver();
                if(d.game==='cat')window.ActiveGame=new GameCat();
                if(d.game==='spider')window.ActiveGame=new GameSpider();
                if(d.game==='horses')window.ActiveGame=new GameHorses();
                if(d.game==='balls')window.ActiveGame=new GameBalls();
                
                this.renderSidebar(); 
            },
            skip(){showToast("ÄÃ£ bá» qua mÃ n chÆ¡i!", 'warning');this.win(false)},
            win(opt){
                if(this.isTransitioning) return; 
                playSound('win');
                const d=STORY[this.idx];
                this.progress[d.id]={done:true,opt:opt};
                let g=0;Object.values(this.progress).forEach(v=>{if(v.opt)g++});this.gears=g;
                
                if(d.id === 'c1') { this.unlockedCompanions.add('dog'); showToast("ğŸ• ChÃº ChÃ³ VÃ ng Ä‘Ã£ gia nháº­p Ä‘á»™i!", "event"); }
                if(d.id === 'c2') { this.unlockedCompanions.add('robo'); showToast("ğŸ¤– Robo Tin-Tin Ä‘Ã£ Ä‘Æ°á»£c sá»­a chá»¯a!", "event"); }
                if(d.id === 'c3') { this.unlockedCompanions.add('bear'); this.inventory.add('glass'); showToast("ğŸ» GiÃ¡o SÆ° Gáº¥u Ä‘Ã£ gia nháº­p Ä‘á»™i!", "event"); showToast("ğŸ” ÄÃ£ tÃ¬m tháº¥y KÃ­nh LÃºp!", "event"); }
                if(d.id === 'c6') { this.inventory.add('magnet'); showToast("ğŸ§² ÄÃ£ tÃ¬m tháº¥y Nam ChÃ¢m!", "event"); }

                this.save(); this.renderSidebar();
                
                const nextTitle = STORY[this.idx+1] ? STORY[this.idx+1].title : "Káº¾T THÃšC";
                const nextText = STORY[this.idx+1] ? STORY[this.idx+1].text : "Báº¡n Ä‘Ã£ hoÃ n thÃ nh hÃ nh trÃ¬nh!";
                const overlayHTML = `<div class="animate-bounce text-6xl mb-4">ğŸ‰</div><h2 class="text-4xl md:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-cyan-400 mb-2">CHIáº¾N THáº®NG!</h2><p class="text-slate-300 text-lg mb-8 font-medium">${opt ? "Xuáº¥t sáº¯c! +1 BÃ¡nh RÄƒng VÃ ng âš™ï¸" : "HoÃ n thÃ nh! (ChÆ°a tá»‘i Æ°u)"}</p><div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 max-w-lg w-full text-left mb-8 shadow-2xl transform rotate-1 overflow-y-auto max-h-[40vh]"><div class="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-2">CHÆ¯Æ NG TIáº¾P THEO</div><div class="text-xl font-bold text-white mb-2">${nextTitle}</div><p class="text-slate-400 text-sm leading-relaxed">${nextText}</p></div><button onclick="GameManager.next()" class="px-10 py-4 bg-white text-black font-black text-xl rounded-full shadow-[0_0_30px_rgba(255,255,255,0.3)] hover:scale-105 transition-transform flex items-center gap-2 group">TIáº¾P Tá»¤C <span class="group-hover:translate-x-1 transition-transform">âœ</span></button><div class="mt-4 text-xs text-slate-500 font-mono">Nháº¥n Enter Ä‘á»ƒ tiáº¿p tá»¥c</div>`;
                const vic = document.getElementById('victory-overlay'); vic.innerHTML = overlayHTML; vic.classList.add('victory-visible'); vic.style.pointerEvents = 'auto';
            },
            next(){
                if(this.isTransitioning) return;
                this.isTransitioning = true;
                const vic = document.getElementById('victory-overlay'); vic.classList.remove('victory-visible'); vic.style.pointerEvents = 'none';
                if(this.idx<STORY.length-1){ this.idx++; this.save(); this.loadContent(); } else { this.ending(); }
            },
            jump(i){
                const prev=STORY[i-1];if((i===0)||(prev&&this.progress[prev.id]?.done)||this.progress[STORY[i].id]?.done){
                    this.idx=i; this.loadContent(); document.getElementById('mobile-menu').classList.add('hidden');
                }
            },
            ending(){
                document.getElementById('ending-screen').classList.remove('hidden');
                const gears = this.gears;
                document.getElementById('end-score').innerText = `${gears}/8 âš™ï¸`;
                const rank = document.getElementById('end-rank');
                const icon = document.getElementById('end-icon');
                const title = document.getElementById('end-title');
                
                let r = 'B', i = 'ğŸŒ±';
                let rClass = "text-3xl font-black text-slate-400 mt-1";
                let tClass = "text-3xl md:text-5xl font-serif font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-200 to-cyan-500 mb-2";
                let tText = "BÃŒNH MINH CHÆ¯A TRá»ŒN";
                let sText = "NORMAL ENDING";
                
                if(gears === 8) {
                    r = 'S+'; rClass = "text-4xl font-black text-amber-400 mt-1 drop-shadow-[0_0_10px_rgba(251,191,36,0.8)]";
                    i = 'ğŸ‘‘'; tClass = "text-3xl md:text-5xl font-serif font-black text-transparent bg-clip-text bg-gradient-to-r from-amber-200 via-yellow-400 to-amber-600 mb-2";
                    tText = "HUYá»€N THOáº I ÃNH SÃNG"; sText = "TRUE ENDING - HOÃ€N Háº¢O";
                } else if (gears >= 6) {
                    r = 'S'; rClass = "text-4xl font-black text-yellow-300 mt-1";
                    i = 'âš”ï¸'; tText = "HIá»†P SÄ¨ THá»œI GIAN";
                } else if (gears === 5) {
                    r = 'A+'; rClass = "text-3xl font-black text-emerald-400 mt-1";
                    i = 'ğŸ›¡ï¸'; tText = "Há»˜ Vá»† TÃ€I BA";
                } else if (gears === 4) {
                    r = 'A'; rClass = "text-3xl font-black text-emerald-500 mt-1";
                    i = 'ğŸ•¯ï¸'; tText = "NGÆ¯á»œI DáºªN ÄÆ¯á»œNG";
                } else {
                    r = 'B'; i = 'ğŸŒ±'; tText = "Táº¬P Sá»°";
                }

                rank.innerText = r; rank.className = rClass;
                icon.innerText = i; title.className = tClass; title.innerText = tText; document.getElementById('end-subtitle').innerText = sText;

                const desc = document.getElementById('end-desc');
                if(gears === 8) {
                    desc.innerHTML = `"KhÃ´ng thá»ƒ tin Ä‘Æ°á»£c!" - Háº¯c PhÃ¡p SÆ° Muá»™i Than thá»‘t lÃªn khi Ã¡nh sÃ¡ng tá»« 8 BÃ¡nh RÄƒng VÃ ng há»£p nháº¥t thÃ nh má»™t luá»“ng nÄƒng lÆ°á»£ng thuáº§n khiáº¿t, xuyÃªn thá»§ng mÃ n Ä‘Ãªm vÄ©nh cá»­u. <br><br>Cha cá»§a An bÆ°á»›c ra tá»« khá»‘i pha lÃª vá»¡ vá»¥n, khÃ´ng má»™t váº¿t xÆ°á»›c. CÃ¢y ÄÃ¨n ChÃ¢n LÃ½ khÃ´ng chá»‰ soi sÃ¡ng con Ä‘Æ°á»ng, mÃ  cÃ²n thanh táº©y tÃ¢m há»“n Ä‘en tá»‘i cá»§a káº» thÃ¹. Muá»™i Than, giá» Ä‘Ã¢y Ä‘Ã£ Ä‘Æ°á»£c giáº£i thoÃ¡t khá»i lá»i nguyá»n bÃ³ng tá»‘i, cÃºi Ä‘áº§u kÃ­nh phá»¥c trÃ­ tuá»‡ vÃ  lÃ²ng dÅ©ng cáº£m cá»§a An.<br><br>VÆ°Æ¡ng Quá»‘c Logic bÆ°á»›c vÃ o ká»· nguyÃªn thá»‹nh vÆ°á»£ng nháº¥t lá»‹ch sá»­. An trá»Ÿ thÃ nh Thá»£ Äá»“ng Há»“ HoÃ ng Gia tráº» tuá»•i nháº¥t, ngÆ°á»i náº¯m giá»¯ chÃ¬a khÃ³a cá»§a Thá»i Gian vÃ  Sá»± Tháº­t. Má»™t cÃ¡i káº¿t viÃªn mÃ£n khÃ´ng tÃ¬ váº¿t!`;
                } else {
                    desc.innerHTML = `Vá»›i sá»‘ lÆ°á»£ng BÃ¡nh RÄƒng thu tháº­p Ä‘Æ°á»£c (${gears}/8), CÃ¢y ÄÃ¨n ChÃ¢n LÃ½ lÃ³e lÃªn má»™t tia sÃ¡ng máº¡nh máº½, Ä‘á»§ Ä‘á»ƒ phÃ¡ vá»¡ khá»‘i pha lÃª vÃ  giáº£i thoÃ¡t cho Cha. Tuy nhiÃªn, nÄƒng lÆ°á»£ng Ä‘Ã³ chÆ°a Ä‘á»§ Ä‘á»ƒ thanh táº©y hoÃ n toÃ n bÃ³ng tá»‘i.<br><br>Háº¯c PhÃ¡p SÆ° Muá»™i Than, dÃ¹ bá»‹ thÆ°Æ¡ng, Ä‘Ã£ ká»‹p thá»i hÃ³a thÃ nh má»™t lÃ n khÃ³i Ä‘en vÃ  trá»‘n thoÃ¡t vá» phÃ­a Báº¯c. "Ta sáº½ trá»Ÿ láº¡i...", tiáº¿ng cÆ°á»i cá»§a háº¯n vá»ng láº¡i trong giÃ³.<br><br>An dÃ¬u cha trá»Ÿ vá» nhÃ . DÃ¹ gia Ä‘Ã¬nh Ä‘oÃ n tá»¥, nhÆ°ng An biáº¿t ráº±ng, chá»«ng nÃ o chÆ°a thu tháº­p Ä‘á»§ 8 BÃ¡nh RÄƒng VÃ ng Ä‘á»ƒ khÃ´i phá»¥c toÃ n bá»™ sá»©c máº¡nh cá»§a CÃ¢y ÄÃ¨n, VÆ°Æ¡ng Quá»‘c Logic váº«n cÃ²n náº±m trong má»‘i Ä‘e dá»a tiá»m tÃ ng. HÃ nh trÃ¬nh táº¡m káº¿t thÃºc, nhÆ°ng thá»­ thÃ¡ch váº«n cÃ²n Ä‘Ã³.`;
                }
            }
        };
        
        document.addEventListener('keydown', (e) => {
            if(e.key === 'Enter' && !GameManager.isTransitioning) {
                const overlay = document.getElementById('victory-overlay');
                if(overlay.classList.contains('victory-visible')) {
                    if(overlay.classList.contains('is-story-overlay')) { GameManager.closeStoryOverlay(); } else { GameManager.next(); }
                } else {
                   const btn = document.getElementById('btn-play');
                   if(btn && !btn.classList.contains('hidden')) btn.click();
                }
            }
        });
        
        window.GameManager = GameManager;
        window.closeModal=(id)=>document.getElementById(id).style.display='none';
        window.openModal=(id)=>document.getElementById(id).style.display='flex';
        document.addEventListener('DOMContentLoaded', () => { GameManager.init(); });
    </script>
</body>
</html>
