<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>H√†nh Tr√¨nh C·ªßa An - v53.0 Final Stable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Merriweather:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        /* --- CORE --- */
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #e2e8f0; overflow: hidden; touch-action: none; }
        .font-serif { font-family: 'Merriweather', serif; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }

        /* --- TOAST --- */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 200; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { 
            background: rgba(30, 41, 59, 0.95); border-left: 4px solid #6366f1; color: white; 
            padding: 12px 24px; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5);
            animation: slideIn 0.3s ease-out, fadeOut 0.3s ease-in 4s forwards; 
            pointer-events: auto; font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 12px;
        }
        .toast.event { border-left-color: #fbbf24; background: linear-gradient(to right, #1e1b4b, #0f172a); border: 1px solid #fbbf24; box-shadow: 0 0 15px rgba(251, 191, 36, 0.2); }
        .toast.error { border-left-color: #f43f5e; }
        .toast.success { border-left-color: #10b981; }
        .toast.warning { border-left-color: #f59e0b; }

        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- MODAL --- */
        .modal { display: none; position: fixed; z-index: 100; inset: 0; background-color: rgba(0,0,0,0.9); backdrop-filter: blur(5px); align-items: center; justify-content: center; padding: 16px; }
        .modal-content { background-color: #1e293b; border: 1px solid #334155; border-radius: 1rem; max-width: 600px; width: 100%; max-height: 85vh; overflow-y: auto; animation: zoomIn 0.2s ease-out; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); display: flex; flex-direction: column; }

        /* ITEM & SKILL STYLES */
        .item-slot { width: 40px; height: 40px; border-radius: 8px; background: #1e293b; border: 1px solid #475569; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; transition: all 0.2s; position: relative; }
        .item-slot:hover { background: #334155; border-color: #94a3b8; transform: translateY(-2px); }
        .item-slot.locked { opacity: 0.3; cursor: not-allowed; filter: grayscale(100%); pointer-events: none; }
        .item-slot.used { opacity: 0.5; filter: grayscale(100%); cursor: default; }
        .item-slot.used::after { content: '‚úì'; position: absolute; bottom: -4px; right: -4px; background: #10b981; color: white; font-size: 10px; padding: 2px 4px; border-radius: 4px; font-weight: bold; }
        .item-slot.usable { border-color: #fbbf24; box-shadow: 0 0 10px rgba(251, 191, 36, 0.3); animation: pulse-border 2s infinite; }
        @keyframes pulse-border { 0% { border-color: #fbbf24; } 50% { border-color: #f59e0b; box-shadow: 0 0 15px rgba(251, 191, 36, 0.5); } 100% { border-color: #fbbf24; } }
        .skill-btn { width: 100%; padding: 12px; border-radius: 8px; font-weight: bold; text-align: center; margin-top: 8px; transition: all 0.2s; border: 1px solid transparent; }
        .skill-btn.available { background: #4f46e5; color: white; cursor: pointer; }
        .skill-btn.available:hover { background: #4338ca; }
        .skill-btn.used { background: #1e293b; color: #64748b; cursor: default; border-color: #334155; }
        .skill-content { margin-top: 12px; padding: 12px; background: #0f172a; border-radius: 8px; border: 1px dashed #334155; display: none; }
        .skill-content.visible { display: block; animation: fadeIn 0.3s; }

        /* GAME STYLES */
        .bulb-btn { transition: all 0.1s; } .bulb-btn:active { transform: scale(0.98); } .bulb-on { background-color: #fcd34d !important; color: #713f12 !important; box-shadow: 0 0 40px #fcd34d; border-color: #fbbf24 !important; } .bulb-off { background-color: #1e293b; color: #64748b; border-color: #475569; }
        .jug-container { position: relative; background: #334155; border-radius: 0 0 12px 12px; border: 4px solid #64748b; border-top: none; overflow: hidden; transition: all 0.2s; cursor: pointer; width: 90px; margin: 0 8px; } .jug-container:hover { border-color: #94a3b8; } .jug-water { position: absolute; bottom: 0; left: 0; width: 100%; background-color: #fbbf24; transition: height 0.5s ease; opacity: 0.9; box-shadow: inset 0 -5px 10px rgba(0,0,0,0.1); } .jug-selected { border-color: #d946ef !important; box-shadow: 0 0 0 4px rgba(217, 70, 239, 0.5) !important; transform: translateY(-4px); }
        .char-card { transition: all 0.2s; cursor: pointer; user-select: none; position: relative; z-index: 20; box-shadow: 0 4px 6px rgba(0,0,0,0.4); background: #1e293b; border: 2px solid #475569; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px; width: 100%; aspect-ratio: 1/1; } .char-card:hover { transform: translateY(-3px); border-color: #fbbf24; background: #334155; }
        .bridge-layout { display: flex; width: 100%; height: 600px; border: 2px solid #334155; border-radius: 16px; overflow: hidden; background: #0f172a; position: relative; } .cliff-side { width: 250px; height: 100%; background: #1e293b; border-right: 2px solid #334155; padding: 16px; overflow-y: auto; flex-shrink: 0; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; align-content: start; justify-items: center; z-index: 5; } .cliff-side.right { border-left: 2px solid #334155; border-right: none; } .bridge-zone { flex: 1; height: 100%; position: relative; background: linear-gradient(180deg, #020617 0%, #0f172a 100%); overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; } .bridge-zone .btn-go-round { margin-top: 60px; } .bridge-cable { position: absolute; width: 100%; height: 8px; background: #64748b; top: 40%; transform: translateY(-50%); border-radius: 4px; box-shadow: 0 10px 20px rgba(0,0,0,0.5); } .lamp-carrier { width: 180px; height: 180px; border-radius: 50%; border: 4px dashed rgba(251, 191, 36, 0.6); display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 8px; padding: 20px; background: radial-gradient(circle, rgba(251,191,36,0.15) 0%, transparent 70%); transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1); z-index: 10; position: absolute; box-shadow: 0 0 30px rgba(251, 191, 36, 0.1); top: 40%; margin-top: -90px; } .pos-left { transform: translateX(0); left: 10px; } .pos-right { transform: translateX(0); left: calc(100% - 190px); }
        .btn-go-round { width: 90px; height: 90px; border-radius: 50%; background: linear-gradient(135deg, #d97706, #b45309); color: white; font-weight: 900; box-shadow: 0 4px 15px rgba(217, 119, 6, 0.5); border: 4px solid rgba(251, 191, 36, 0.3); letter-spacing: 0.05em; font-size: 1.3rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s; z-index: 40; cursor: pointer; } .btn-go-round:active { transform: scale(0.9); box-shadow: 0 2px 5px rgba(217, 119, 6, 0.5); }
        .btn-go-mobile { width: 100%; padding: 12px; border-radius: 8px; background: linear-gradient(to right, #d97706, #b45309); color: white; font-weight: 900; box-shadow: 0 4px 15px rgba(217, 119, 6, 0.4); border: 2px solid rgba(251, 191, 36, 0.5); letter-spacing: 0.1em; font-size: 1.1rem; text-transform: uppercase; transition: all 0.2s; margin-bottom: 0; } .btn-go-mobile:active { transform: scale(0.98); }
        @media (max-width: 767px) { 
            .bridge-layout { flex-direction: column; height: auto; min-height: auto; border: none; background: transparent; overflow: visible; gap: 4px; } 
            .cliff-side { width: 100%; height: auto; min-height: 70px; border: 2px solid #334155; border-radius: 12px; background: #1e293b; padding: 8px; margin: 0; display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; } 
            /* COMPACT BRIDGE ZONE (180px) */
            .bridge-zone { min-height: 180px; border: 2px solid #334155; border-radius: 12px; background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%); margin: 0; display: flex; flex-direction: column; justify-content: center; } 
            .bridge-zone .btn-go-round { display: none; } 
            .mobile-action-bar { margin-top: 0px; padding: 0; display: flex; justify-content: center; } 
            .bridge-cable { width: 6px; height: 100%; top: 0; left: 50%; transform: translateX(-50%); } 
            .lamp-carrier { left: 50%; width: 100px; height: 100px; margin-left: -50px; top: 10px; margin-top: 0; transition: top 0.8s cubic-bezier(0.4, 0, 0.2, 1); } 
            .pos-left { top: 10px; transform: none; left: 50%; } 
            .pos-right { top: calc(100% - 110px); transform: none; left: 50%; } 
            .char-card { height: 45px; width: 100%; padding: 1px; border-radius: 4px; } 
            .char-emoji { font-size: 1.1rem; line-height: 1; } .char-text { font-size: 0.55rem; display: none; } 
        }

        .box-btn { transition: all 0.2s; cursor: pointer; touch-action: manipulation; } .box-btn:active { transform: scale(0.95); } .quantum-active { animation: pulse-glow 2s infinite; border-color: #818cf8; } @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 5px rgba(99, 102, 241, 0.2); } 50% { box-shadow: 0 0 20px rgba(99, 102, 241, 0.5); } }
        .spider-frame { border: 2px solid #475569; border-radius: 24px; background: #0f172a; box-shadow: inset 0 0 40px rgba(0,0,0,0.6); overflow: hidden; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; max-width: 600px; margin: 0 auto; aspect-ratio: 1/1; touch-action: none; position: relative; }
        .horse { width: 40px; height: 40px; border-radius: 8px; background-color: #be185d; color: white; display: flex; align-items: center; justify-content: center; font-weight: 800; cursor: pointer; transition: all 0.2s; user-select: none; border: 2px solid #fbcfe8; font-size: 0.9rem; box-shadow: 0 2px 4px rgba(0,0,0,0.3); } .horse:active { transform: scale(1.1); } #horse-pool-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; width: 100%; max-width: 350px; margin: 0 auto; }
        .ball { width: 38px; height: 38px; border-radius: 50%; background-color: #4f46e5; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; cursor: pointer; transition: transform 0.1s; font-size: 0.8rem; margin: 2px; box-shadow: inset -5px -5px 10px rgba(0,0,0,0.4); border: 2px solid #818cf8; } .pan { min-height: 120px; border: 3px solid #64748b; border-top: none; border-radius: 0 0 20px 20px; background-color: #1e293b; display: grid; grid-template-columns: repeat(2, 1fr); align-content: start; justify-items: center; gap: 5px; padding: 10px; transition: border-color 0.3s; cursor: pointer; width: 100%; position: relative; } .pan::before { content:''; position: absolute; top: -40px; left: 50%; width: 4px; height: 40px; background: #64748b; transform: translateX(-50%); } @media (min-width: 768px) { .pan { grid-template-columns: repeat(4, 1fr); } } .pan:hover { border-color: #94a3b8; } .pan.selected-pan { border-color: #fbbf24; background-color: rgba(251, 191, 36, 0.08); box-shadow: 0 0 20px rgba(251, 191, 36, 0.15); } .pan.selected-pan::before { background: #fbbf24; } .scale-arm { width: 100%; height: 8px; background: #64748b; border-radius: 4px; transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); transform-origin: center; position: relative; } .scale-pivot { width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent; border-bottom: 40px solid #475569; position: absolute; bottom: -48px; left: 50%; transform: translateX(-50%); } .balanced-anim { animation: balancePulse 0.5s ease-in-out; } @keyframes balancePulse { 0% { transform: scaleX(1); } 50% { transform: scaleX(1.1); background-color: #10b981; } 100% { transform: scaleX(1); } } .tilt-left { transform: rotate(-10deg); } .tilt-right { transform: rotate(10deg); } .pan-container { transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); width: 40%; display: flex; flex-direction: column; items-center; } .pan-tilt-up { transform: translateY(-30px); } .pan-tilt-down { transform: translateY(30px); }

        .game-canvas { display: block; width: 100%; height: 100%; object-fit: contain; } .log-box { font-family: monospace; font-size: 0.9rem; background: #0f172a; padding: 12px; border-radius: 8px; overflow-y: auto; border: 1px solid #334155; color: #94a3b8; line-height: 1.6; }
        .victory-overlay { position: absolute; inset: 0; background: rgba(2, 6, 23, 0.98); backdrop-filter: blur(12px); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; pointer-events: auto; transition: opacity 0.3s ease-out; padding: 20px; text-align: center; pointer-events: none; } .victory-visible { opacity: 1; pointer-events: auto; }
        .accordion-content { overflow: hidden; transition: max-height 0.4s ease-in-out; } .accordion-collapsed { max-height: 0 !important; padding-top: 0 !important; padding-bottom: 0 !important; } .accordion-expanded { max-height: 800px; } @media (min-width: 768px) { #story-content-wrapper.accordion-collapsed { max-height: 0 !important; } #story-content-wrapper:not(.accordion-collapsed) { max-height: 800px !important; } } .intro-active #accordion-icon-mobile { display: none; } .intro-active #accordion-icon-desktop { display: none; } .intro-active .accordion-content { max-height: none !important; }
    </style>
</head>
<body class="flex h-screen bg-slate-950 text-slate-200">

    <div id="toast-container"></div>

    <!-- SIDEBAR -->
    <aside class="hidden md:flex flex-col w-72 bg-slate-900 border-r border-slate-800 h-full shrink-0 z-30">
        <div class="p-6 border-b border-slate-800">
            <h1 class="text-lg font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-cyan-400">H√ÄNH TR√åNH C·ª¶A AN</h1>
            <div class="text-[10px] text-slate-500 font-bold mt-1 tracking-widest">v53.0 FINAL STABLE</div>
        </div>
        <nav id="sidebar-nav" class="flex-1 overflow-y-auto pb-4 space-y-1 p-2"></nav>
        <div id="inventory-section" class="p-4 border-t border-slate-800 bg-slate-900/50">
            <div class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2">KHO V·∫¨T PH·∫®M</div>
            <div id="inventory-grid" class="grid grid-cols-4 gap-2 mb-4"></div>
            <div class="flex justify-between items-center bg-slate-800 p-3 rounded-lg border border-slate-700 shadow-inner mb-3">
                <div class="flex items-center space-x-2"><span class="text-xl">‚öôÔ∏è</span><span class="text-xs font-bold text-amber-400 uppercase">B√°nh RƒÉng</span></div>
                <span id="gear-count" class="text-xl font-black text-white">0/8</span>
            </div>
            <button onclick="openModal('reset-modal')" class="w-full py-2 bg-red-900/30 hover:bg-red-900/50 border border-red-800 text-red-400 text-xs font-bold rounded uppercase tracking-wider transition flex items-center justify-center gap-2">
                <span>üóëÔ∏è</span> X√ìA H√ÄNH TR√åNH
            </button>
        </div>
    </aside>

    <!-- MOBILE HEADER -->
    <div class="md:hidden fixed top-0 w-full h-14 bg-slate-900/95 backdrop-blur border-b border-slate-800 z-50 flex items-center justify-between px-4 shadow-lg">
        <span class="font-bold text-indigo-400 text-sm truncate">H√ÄNH TR√åNH C·ª¶A AN</span>
        <div class="flex items-center gap-3">
            <div id="mobile-inventory" class="flex gap-2 mr-2"></div>
            <span class="text-amber-400 text-xs font-bold" id="mobile-gear">0 ‚öôÔ∏è</span>
            <button onclick="document.getElementById('mobile-menu').classList.toggle('hidden')" class="text-2xl p-2">‚ò∞</button>
        </div>
    </div>
    <div id="mobile-menu" class="hidden fixed top-14 left-0 w-full bg-slate-950/95 backdrop-blur z-40 border-b border-slate-800 p-4 md:hidden max-h-[80vh] overflow-y-auto shadow-2xl">
        <nav id="mobile-nav-list" class="space-y-1 pb-4"></nav>
    </div>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col relative pt-14 md:pt-0 overflow-hidden h-full">
        
        <!-- STORY ACCORDION -->
        <div id="story-section" class="bg-slate-900 border-b border-slate-800 shrink-0 z-20 shadow-md relative transition-all duration-300">
            <div class="md:hidden flex justify-between items-center p-3 bg-slate-800 cursor-pointer active:bg-slate-700 transition border-b border-slate-800" onclick="toggleStory()">
                <div class="flex items-center gap-2 overflow-hidden"><span id="chapter-tag-mobile" class="text-[9px] font-bold text-slate-400 bg-slate-950 px-2 py-1 rounded border border-slate-700 shrink-0">CH∆Ø∆†NG 1</span><span id="story-title-mobile" class="text-sm font-bold text-white truncate">...</span></div><span id="accordion-icon-mobile" class="text-xs text-slate-500">‚ñº</span>
            </div>
            <div class="hidden md:flex justify-between items-center p-4 bg-slate-800 border-b border-slate-700 cursor-pointer hover:bg-slate-750 transition" onclick="toggleStory()">
                 <div class="flex items-center gap-3"><span id="part-tag" class="text-[10px] font-black text-indigo-400 uppercase tracking-widest border border-indigo-500/30 px-2 py-0.5 rounded bg-indigo-500/10">PH·∫¶N 1</span><h3 id="story-title" class="text-xl font-serif font-bold text-white truncate">...</h3></div><div class="flex items-center gap-4"><span id="chapter-tag" class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">CH∆Ø∆†NG 1</span><span id="accordion-icon-desktop" class="text-slate-400 hover:text-white transition text-sm">‚ñ≤ Thu g·ªçn</span></div>
            </div>
            <div id="story-content-wrapper" class="accordion-content accordion-expanded p-4 md:p-6 overflow-y-auto max-h-[40vh] bg-slate-900">
                <div class="max-w-4xl mx-auto">
                    <div id="story-text" class="text-slate-300 text-sm leading-relaxed mb-4 font-light">...</div>
                    <div id="game-rules-section" class="mb-6 p-4 bg-slate-950/50 rounded-xl border border-slate-800 hidden"><h4 class="text-xs font-black text-amber-500 uppercase tracking-widest mb-2">H∆Ø·ªöNG D·∫™N NHI·ªÜM V·ª§</h4><div id="game-rules-text" class="text-sm text-slate-400 leading-relaxed space-y-2"></div></div>
                    <div class="flex gap-3 flex-wrap"><button id="btn-play" onclick="GameManager.playLevel()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-bold rounded-lg shadow-lg transition-transform active:scale-95">B·∫ÆT ƒê·∫¶U (Enter)</button></div>
                </div>
            </div>
        </div>

        <!-- GAME STAGE -->
        <div class="flex-1 bg-[#020617] relative overflow-hidden flex flex-col w-full">
            <div id="game-container" class="flex flex-col h-full w-full hidden">
                <div class="flex justify-between items-center p-2 px-4 border-b border-slate-800 bg-slate-900 z-30 shrink-0 h-14">
                    <div class="flex items-center gap-3"><div class="flex flex-col"><span class="text-[9px] text-slate-500 font-bold uppercase">Tr·∫°ng th√°i</span><span id="game-metric" class="font-mono text-sm text-emerald-400 font-bold">...</span></div><div id="game-msg" class="hidden"></div></div>
                    <div class="flex gap-2"><button onclick="ActiveGame.reset()" class="px-3 py-1.5 bg-slate-800 hover:bg-slate-700 text-slate-300 border border-slate-600 rounded text-xs font-bold transition">‚Ü∫ Reset</button><button onclick="openModal('hint-modal')" class="px-3 py-1.5 bg-amber-900/30 hover:bg-amber-800 text-amber-200 border border-amber-700/50 rounded text-xs font-bold transition">üí° G·ª£i √Ω</button><button onclick="GameManager.skip()" class="px-3 py-1.5 bg-rose-900/20 hover:bg-rose-900 text-rose-300 border border-rose-800 rounded text-xs font-bold transition">‚è© SKIP</button></div>
                </div>
                <div id="game-stage" class="flex-1 overflow-y-auto w-full p-4 relative flex flex-col items-center"></div>
            </div>
            <div id="placeholder" class="absolute inset-0 flex flex-col items-center justify-center opacity-20 select-none pointer-events-none"><div class="text-6xl md:text-8xl mb-4 grayscale">üè∞</div><div class="text-xl md:text-2xl font-serif font-bold tracking-[0.2em] text-white">V∆Ø∆†NG QU·ªêC LOGIC</div></div>
            <div id="victory-overlay" class="victory-overlay"></div>
        </div>
    </main>

    <!-- MODALS -->
    <div id="hint-modal" class="modal" style="display:none;" onclick="closeModal('hint-modal')">
        <div class="modal-content p-0" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center p-4 border-b border-slate-700 bg-slate-900">
                <h3 class="text-lg font-bold text-amber-500">Trung T√¢m Chi·∫øn Thu·∫≠t</h3>
                <button onclick="closeModal('hint-modal')" class="text-slate-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="p-4 bg-slate-900 space-y-4">
                <div class="bg-slate-800 p-4 rounded-lg border border-slate-700">
                    <div class="text-xs font-bold text-slate-400 uppercase mb-2">G·ª¢I √ù C∆† B·∫¢N</div>
                    <p id="hint-text" class="text-slate-300 text-sm italic">...</p>
                </div>
                <div class="space-y-2">
                    <div id="comp-dog" class="bg-slate-800 p-4 rounded-lg border border-slate-700 opacity-50"><div class="flex justify-between items-center"><span class="font-bold text-yellow-500">üêï <span class="name">Ch√≥ V√†ng</span></span><span class="text-xs text-slate-500 status-text">Ch∆∞a m·ªü kh√≥a</span></div><div id="btn-dog" class="skill-btn" onclick="GameManager.useSkill('dog')">ƒê√°nh H∆°i (1 l·∫ßn)</div><div id="content-dog" class="skill-content text-sm text-yellow-200"></div></div>
                    <div id="comp-bear" class="bg-slate-800 p-4 rounded-lg border border-slate-700 opacity-50"><div class="flex justify-between items-center"><span class="font-bold text-amber-600">üêª <span class="name">G·∫•u</span></span><span class="text-xs text-slate-500 status-text">Ch∆∞a m·ªü kh√≥a</span></div><div id="btn-bear" class="skill-btn" onclick="GameManager.useSkill('bear')">Ch·ªâ D·∫´n (1 l·∫ßn)</div><div id="content-bear" class="skill-content text-sm text-amber-200"></div></div>
                    <div id="comp-robo" class="bg-slate-800 p-4 rounded-lg border border-slate-700 opacity-50"><div class="flex justify-between items-center"><span class="font-bold text-cyan-400">ü§ñ <span class="name">Robo</span></span><span class="text-xs text-slate-500 status-text">Ch∆∞a m·ªü kh√≥a</span></div><div id="btn-robo" class="skill-btn" onclick="GameManager.useSkill('robo')">Ph√¢n T√≠ch (1 l·∫ßn)</div><div id="content-robo" class="skill-content text-sm text-cyan-200 font-mono"></div></div>
                </div>
            </div>
        </div>
    </div>

    <div id="reset-modal" class="modal" style="display:none;" onclick="closeModal('reset-modal')">
        <div class="bg-slate-900 border border-slate-700 p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4 text-center" onclick="event.stopPropagation()">
            <div class="text-4xl mb-4">‚ö†Ô∏è</div>
            <h3 class="text-xl font-bold text-white mb-2">X√°c nh·∫≠n x√≥a h√†nh tr√¨nh?</h3>
            <p class="text-slate-400 text-sm mb-6">To√†n b·ªô ti·∫øn ƒë·ªô, v·∫≠t ph·∫©m v√† th√†nh t√≠ch s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn. B·∫°n s·∫Ω quay l·∫°i t·ª´ ƒë·∫ßu.</p>
            <div class="flex gap-3">
                <button onclick="closeModal('reset-modal')" class="flex-1 py-3 bg-slate-800 hover:bg-slate-700 text-white font-bold rounded-lg transition">H·ªßy</button>
                <button onclick="GameManager.confirmReset()" class="flex-1 py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg transition">X√≥a Lu√¥n</button>
            </div>
        </div>
    </div>

    <div id="ending-screen" class="hidden fixed inset-0 z-[200] bg-black flex flex-col items-center justify-center animate-fadeIn overflow-y-auto">
        <div class="w-full min-h-screen flex items-center justify-center p-4 py-12">
            <div class="max-w-3xl w-full bg-slate-900/95 p-8 rounded-3xl border-2 border-slate-700 shadow-2xl relative overflow-hidden transform scale-95 animate-zoomIn flex flex-col max-h-[95vh]">
                <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
                <div class="text-center shrink-0">
                    <div id="end-icon" class="text-6xl mb-4 animate-bounce inline-block">üèÜ</div>
                    <h1 id="end-title" class="text-3xl md:text-5xl font-serif font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-200 to-amber-500 mb-2">THE END</h1>
                    <div id="end-subtitle" class="text-sm font-bold text-slate-500 uppercase tracking-[0.3em] mb-6">H√ÄNH TR√åNH KH√âP L·∫†I</div>
                </div>
                <div class="bg-slate-950/60 p-6 rounded-2xl border border-slate-800 mb-8 text-left overflow-y-auto custom-scrollbar shadow-inner flex-1">
                    <p id="end-desc" class="text-base md:text-lg text-slate-300 leading-relaxed font-light font-serif">...</p>
                </div>
                <div class="flex justify-center items-center gap-6 mb-8 bg-slate-800/50 p-4 rounded-xl border border-slate-700 shrink-0">
                    <div class="flex flex-col text-center"><span class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">B√ÅNH RƒÇNG</span><span id="end-score" class="text-2xl font-black text-white mt-1">0/8 ‚öôÔ∏è</span></div>
                    <div class="w-px h-8 bg-slate-600"></div>
                    <div class="flex flex-col text-center"><span class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">ƒê√ÅNH GI√Å</span><span id="end-rank" class="text-2xl font-black text-emerald-400 mt-1">B</span></div>
                </div>
                <div class="shrink-0 sticky bottom-0 bg-slate-900 pt-4 pb-2">
                    <button onclick="GameManager.confirmReset()" class="w-full py-4 bg-white hover:bg-slate-200 text-black font-black text-lg rounded-full shadow-[0_0_20px_rgba(255,255,255,0.2)] transition-transform hover:scale-105 active:scale-95">CH∆†I L·∫†I T·ª™ ƒê·∫¶U</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function showToast(msg, type='info') { const c = document.getElementById('toast-container'); const t = document.createElement('div'); t.className = `toast ${type}`; t.innerHTML = msg; c.appendChild(t); setTimeout(() => t.remove(), 4000); }
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(t) { if(audioCtx.state==='suspended')audioCtx.resume(); if(t==='silent')return; const osc=audioCtx.createOscillator(),g=audioCtx.createGain(); osc.connect(g);g.connect(audioCtx.destination); const n=audioCtx.currentTime; if(t==='click'){osc.type='sine';osc.frequency.setValueAtTime(600,n);g.gain.setValueAtTime(0.05,n);g.gain.exponentialRampToValueAtTime(0.001,n+0.1);osc.start(n);osc.stop(n+0.1)} else if(t==='win'){osc.type='triangle';osc.frequency.setValueAtTime(523,n);osc.frequency.linearRampToValueAtTime(1046,n+0.3);g.gain.setValueAtTime(0.1,n);g.gain.linearRampToValueAtTime(0.001,n+1);osc.start(n);osc.stop(n+1)} else if(t==='fail'){osc.type='sawtooth';osc.frequency.setValueAtTime(150,n);osc.frequency.linearRampToValueAtTime(100,n+0.3);g.gain.setValueAtTime(0.1,n);g.gain.linearRampToValueAtTime(0.001,n+0.5);osc.start(n);osc.stop(n+0.5)} }
        function toggleStory() { const w=document.getElementById('story-content-wrapper'); const im=document.getElementById('accordion-icon-mobile'); const id=document.getElementById('accordion-icon-desktop'); if(document.body.classList.contains('intro-active')) return; if(w.classList.contains('accordion-collapsed')){ w.classList.remove('accordion-collapsed'); w.classList.add('accordion-expanded'); if(im) im.innerText='‚ñ≤'; if(id) id.innerText='‚ñ≤ Thu g·ªçn'; } else { w.classList.remove('accordion-expanded'); w.classList.add('accordion-collapsed'); if(im) im.innerText='‚ñº'; if(id) id.innerText='‚ñº M·ªü r·ªông'; } }
        function forceCollapseStory() { const w=document.getElementById('story-content-wrapper'); const im=document.getElementById('accordion-icon-mobile'); const id=document.getElementById('accordion-icon-desktop'); if(w) { w.classList.remove('accordion-expanded'); w.classList.add('accordion-collapsed'); if(im) im.innerText='‚ñº'; if(id) id.innerText='‚ñº M·ªü r·ªông'; } }

        const STORY = [
            { id: 'intro', type: 'text', part: 'M·ªû ƒê·∫¶U', title: 'L·ªùi Nh·∫Øn T·ª´ Qu√° Kh·ª©', text: 'An, con trai y√™u qu√Ω c·ªßa ta. N·∫øu con ƒë·ªçc ƒë∆∞·ª£c nh·ªØng d√≤ng n√†y, c√≥ l·∫Ω ta ƒë√£ kh√¥ng c√≤n ·ªü b√™n con. H·∫Øc Ph√°p S∆∞ Mu·ªôi Than - k·∫ª th√π truy·ªÅn ki·∫øp c·ªßa Ho√†ng Gia - ƒë√£ tr·ªói d·∫≠y v√† b·∫Øt c√≥c ta. Ta ƒë√£ k·ªãp gi·∫•u C√¢y ƒê√®n Ch√¢n L√Ω v√†o g√≥i b∆∞u ph·∫©m n√†y. N√≥ kh√¥ng ch·ªâ l√† m·ªôt c√¥ng c·ª•, m√† l√† ng∆∞·ªùi d·∫´n ƒë∆∞·ªùng. H√£y l·∫Øng nghe ti·∫øng n√≥i c·ªßa √°nh s√°ng, n√≥ s·∫Ω ch·ªâ cho con con ƒë∆∞·ªùng c·ª©u ta v√† c·∫£ V∆∞∆°ng Qu·ªëc Logic. H√£y d≈©ng c·∫£m l√™n, con trai!', rules: null },
            { id: 'c1', type: 'game', game: 'switches', part: 'PH·∫¶N 1', title: 'Ch∆∞∆°ng 1: CƒÉn Nh√† G·ªó', text: 'Theo ch·ªâ d·∫´n c·ªßa ng·ªçn ƒë√®n, An t√¨m ƒë·∫øn cƒÉn nh√† g·ªó b√¨a r·ª´ng n∆°i ng∆∞·ªùi b·∫°n trung th√†nh c·ªßa cha - Ch√∫ Ch√≥ V√†ng - ƒëang b·ªã giam gi·ªØ. CƒÉn ph√≤ng t·ªëi om, ch·ªâ c√≥ m·ªôt l·ªìng nƒÉng l∆∞·ª£ng nhi·ªát ƒëang nh·ªët Ch√∫ Ch√≥. ƒê·ªÉ ph√° l·ªìng, An c·∫ßn t√¨m ƒë√∫ng c√¥ng t·∫Øc k√≠ch ho·∫°t trong 4 c√¥ng t·∫Øc. Ng·ªçn ƒë√®n th√¨ th·∫ßm: "√Ånh s√°ng kh√¥ng ph·∫£i l√† t·∫•t c·∫£, h√£y c·∫£m nh·∫≠n h∆°i ·∫•m c√≤n v∆∞∆°ng l·∫°i..."', hint: 'B·∫≠t c√¥ng t·∫Øc, ƒë·ª£i n√≥ng, r·ªìi t·∫Øt ƒëi. B√≥ng ƒë√®n t·∫Øt nh∆∞ng c√≤n N√ìNG ch√≠nh l√† ch√¨a kh√≥a.', math: 'Nguy√™n l√Ω: S·ª≠ d·ª•ng bi·∫øn tr·∫°ng th√°i th·ª© 3 (Nhi·ªát ƒë·ªô) ƒë·ªÉ ph√¢n bi·ªát 2 tr·∫°ng th√°i ƒë·∫ßu ra (S√°ng/T·ªëi).', rules: '<p>1. C√≥ 4 c√¥ng t·∫Øc v√† 4 b√≥ng ƒë√®n.</p><p>2. B·∫≠t/T·∫Øt c√¥ng t·∫Øc t√πy √Ω, nh·∫•n "Ch·ªù 10 ph√∫t" ƒë·ªÉ l√†m n√≥ng ƒë√®n.</p><p>3. Nh·∫•n "V√†o Ph√≤ng" ƒë·ªÉ ki·ªÉm tra tr·∫°ng th√°i.</p><p>4. <strong>Nhi·ªám v·ª•:</strong> T√¨m ch√≠nh x√°c c√¥ng t·∫Øc n√†o ƒëi·ªÅu khi·ªÉn b√≥ng ƒë√®n n√†o.</p>', hint2: null, guide: null },
            { id: 'c2', type: 'game', game: 'jugs', part: 'PH·∫¶N 1', title: 'Ch∆∞∆°ng 2: Su·ªëi D·∫ßu C·∫°n', text: 'Gi·∫£i c·ª©u th√†nh c√¥ng, Ch√∫ Ch√≥ V√†ng d·∫´n An ƒë·∫øn su·ªëi d·∫ßu c·∫°n. T·∫°i ƒë√≥, Robo Tin-Tin ƒëang n·∫±m b·∫•t ƒë·ªông. L√µi nƒÉng l∆∞·ª£ng c·ªßa Tin-Tin y√™u c·∫ßu n·∫°p ch√≠nh x√°c 4 L√≠t d·∫ßu ƒë·ªÉ t√°i kh·ªüi ƒë·ªông. An ch·ªâ t√¨m th·∫•y 3 chi·∫øc b√¨nh r·ªóng v·ªõi dung t√≠ch 8L, 5L v√† 3L.', hint: 'T·∫≠p trung v√†o s·ª± ch√™nh l·ªách. 5 - 3 = 2. L√†m sao t·ª´ 2 ra 4?', hint2: 'G√¢u! M√πi d·∫ßu ·ªü b√¨nh 5L v√† 3L l√† n·ªìng nh·∫•t, h√£y d√πng ch√∫ng ƒë·ªÉ t·∫°o ra s·ªë d∆∞!', guide: null, math: 'Nguy√™n l√Ω: 5x + 3y = 4 (Ph∆∞∆°ng tr√¨nh Diophantine).', rules: '<p>1. C√≥ 3 b√¨nh: 8L, 5L, 3L.</p><p>2. ƒê·ªï d·∫ßu qua l·∫°i gi·ªØa c√°c b√¨nh.</p><p>3. T·∫°o ra ch√≠nh x√°c 4 L√≠t d·∫ßu trong b·∫•t k·ª≥ b√¨nh n√†o.</p>' },
            { id: 'c3', type: 'game', game: 'graph', part: 'PH·∫¶N 1', title: 'Ch∆∞∆°ng 3: C·ªïng ƒê√° C·ªï ƒê·∫°i', text: 'C·∫£ nh√≥m b·ªã ch·∫∑n l·∫°i b·ªüi C·ªïng ƒê√° C·ªï ƒê·∫°i. Gi√°o S∆∞ G·∫•u ƒëang loay hoay tr∆∞·ªõc c·ªïng. "C·ªïng n√†y phong ·∫•n b·∫±ng m·ªôt h√¨nh v·∫Ω sao," Gi√°o S∆∞ n√≥i, "Ph·∫£i v·∫Ω l·∫°i to√†n b·ªô h√¨nh n√†y b·∫±ng m·ªôt n√©t b√∫t li·ªÅn m·∫°ch."', hint: 'B·∫Øt ƒë·∫ßu t·ª´ ƒëi·ªÉm c√≥ s·ªë ƒë∆∞·ªùng n·ªëi L·∫∫.', hint2: 'G√¢u! ƒêi·ªÉm g√≥c d∆∞·ªõi n√†y c√≥ m√πi l·∫°, h√£y b·∫Øt ƒë·∫ßu t·ª´ ƒë√≥!', guide: 'Ch·ªâ c√≥ th·ªÉ b·∫Øt ƒë·∫ßu t·ª´ m·ªôt trong hai ƒëi·ªÉm ·ªü ƒë√°y (b·∫≠c 5). ƒêi theo vi·ªÅn ngo√†i r·ªìi v√†o trong.', math: 'Nguy√™n l√Ω Euler: ƒê·ªì th·ªã v·∫Ω ƒë∆∞·ª£c 1 n√©t khi v√† ch·ªâ khi c√≥ 0 ho·∫∑c 2 ƒë·ªânh b·∫≠c l·∫ª.', rules: '<p>1. V·∫Ω l·∫°i h√¨nh ng√¥i sao b·∫±ng m·ªôt n√©t li·ªÅn.</p><p>2. Kh√¥ng ƒë∆∞·ª£c ƒëi l·∫°i ƒë∆∞·ªùng ƒë√£ v·∫Ω.</p>' },
            { id: 'c4', type: 'game', game: 'river', part: 'PH·∫¶N 2', title: 'Ch∆∞∆°ng 4: C√¢y C·∫ßu ƒê·ª©t G√£y', text: 'C√¢y c·∫ßu treo duy nh·∫•t ƒë√£ b·ªã ƒë·ª©t g√£y. Ng·ªçn ƒë√®n c·∫£nh b√°o nƒÉng l∆∞·ª£ng ch·ªâ c√≤n 29 gi√¢y. C·∫£ nh√≥m (5 ng∆∞·ªùi) ph·∫£i qua c·∫ßu. C·∫ßu ch·ªâ ch·ªãu ƒë∆∞·ª£c 2 ng∆∞·ªùi/l∆∞·ª£t, v√† ph·∫£i c√≥ ƒë√®n.', hint: 'ƒê·ª´ng ƒë·ªÉ ng∆∞·ªùi nhanh nh·∫•t l√†m m·ªçi vi·ªác. H√£y ƒë·ªÉ hai ng∆∞·ªùi ch·∫≠m nh·∫•t ƒëi c√πng nhau.', hint2: 'G√¢u! ƒê·ªÉ t√¥i c·∫ßm ƒë√®n ch·∫°y v·ªÅ cho nhanh, t√¥i ch·∫°y c√≥ 1 gi√¢y th√¥i!', guide: 'L∆∞·ª£t quan tr·ªçng: Cho G·∫•u (8s) v√† Robo (12s) ƒëi c√πng nhau ƒë·ªÉ "g√≥i" th·ªùi gian ch·∫≠m nh·∫•t l·∫°i.', math: 'T·ªëi ∆∞u h√≥a: Gi·∫£m thi·ªÉu t·ªïng th·ªùi gian ch·ªù (Wait Time Minimization).', rules: '<p>1. ƒê∆∞a 5 ng∆∞·ªùi qua b·ªù ph·∫£i trong 29s.</p><p>2. T·ªëi ƒëa 2 ng∆∞·ªùi/l∆∞·ª£t. Ph·∫£i c√≥ ƒë√®n.</p><p>3. T·ªëc ƒë·ªô: Ch√≥ 1s, An 3s, Kh√°ch 6s, G·∫•u 8s, Robo 12s.</p>' },
            { id: 'c5', type: 'game', game: 'cat', part: 'PH·∫¶N 2', title: 'Ch∆∞∆°ng 5: S·ª± Ph·∫£n B·ªôi', text: 'L·ªØ Kh√°ch l·ªô m·∫∑t l√† H·∫Øc Ph√°p S∆∞! H·∫Øn tr·ªën v√†o khu r·ª´ng ma thu·∫≠t c√≥ 5 b·ª•i c√¢y. M·ªói ƒë√™m, h·∫Øn b·∫Øt bu·ªôc ph·∫£i nh·∫£y sang b·ª•i c√¢y ngay b√™n c·∫°nh.', hint: 'N·∫øu h·∫Øn ·ªü √¥ Ch·∫µn, l·∫ßn sau h·∫Øn ph·∫£i sang L·∫ª.', hint2: 'G√¢u! H·∫Øn c√≥ m√πi ·ªü h·ªôp s·ªë 2...', guide: 'Chi·∫øn thu·∫≠t "D·ªìn toa": Ki·ªÉm tra √¥ 2, n·∫øu kh√¥ng c√≥, ng√†y mai h·∫Øn ch·∫Øc ch·∫Øn ·ªü √¥ l·∫ª.', math: 'Nguy√™n l√Ω Parity (Ch·∫µn/L·∫ª): Tr·∫°ng th√°i thay ƒë·ªïi lu√¢n phi√™n sau m·ªói b∆∞·ªõc.', rules: '<p>1. T√¨m H·∫Øc Ph√°p S∆∞ trong 5 h·ªôp.</p><p>2. Sau m·ªói l·∫ßn m·ªü h·ªôp, h·∫Øn s·∫Ω nh·∫£y sang h·ªôp li·ªÅn k·ªÅ.</p><p>3. Gi·ªõi h·∫°n 10 l∆∞·ª£t.</p>' },
            { id: 'c6', type: 'game', game: 'spider', part: 'PH·∫¶N 2', title: 'Ch∆∞∆°ng 6: V√¢y B·∫Øt Nh·ªán M√°y', text: 'H·∫Øc Ph√°p S∆∞ tri·ªáu h·ªìi Nh·ªán M√°y Kh·ªïng L·ªì. An ph·∫£i ƒëi·ªÅu khi·ªÉn h·ªá th·ªëng radar ƒë·ªÉ v√¢y b·∫Øt n√≥ tr√™n m·∫°ng nh·ªán.', hint: 'ƒê·ª´ng ch·∫°y theo ƒëu√¥i. H√£y chi·∫øm c√°c giao l·ªô quan tr·ªçng ƒë·ªÉ c·∫Øt ƒë∆∞·ªùng r√∫t lui.', hint2: 'G√¢u! Ch·∫∑n ƒë·∫ßu n√≥ ·ªü c√°i v√≤ng ngo√†i kia k√¨a!', guide: 'Chi·∫øn thu·∫≠t "Bao v√¢y": ƒêi v√†o trung t√¢m tr∆∞·ªõc ƒë·ªÉ ki·ªÉm so√°t c√°c h∆∞·ªõng ra.', math: 'Nguy√™n l√Ω Voronoi: Chi·∫øm lƒ©nh c√°c ƒëi·ªÉm trung t√¢m ƒë·ªÉ thu h·∫πp v√πng di chuy·ªÉn c·ªßa ƒë·ªëi ph∆∞∆°ng.', rules: '<p>1. B·∫°n (Xanh) b·∫Øt Nh·ªán (H·ªìng).</p><p>2. Nh·ªán lu√¥n ch·∫°y xa b·∫°n.</p><p>3. B·∫Øt ƒë∆∞·ª£c trong 15 b∆∞·ªõc.</p>' },
            { id: 'c7', type: 'game', game: 'horses', part: 'PH·∫¶N 3', title: 'Ch∆∞∆°ng 7: Tri·ªáu H·ªìi R·ªìng', text: 'T·∫°i Tr·∫°i R·ªìng, An c·∫ßn t√¨m 3 con r·ªìng nhanh nh·∫•t trong 25 con. Kh√¥ng c√≥ ƒë·ªìng h·ªì, ch·ªâ bi·∫øt th·ª© t·ª± v·ªÅ ƒë√≠ch.', hint: 'Chia 25 con th√†nh 5 nh√≥m ƒëua. Lo·∫°i b·ªè nh·ªØng con kh√¥ng th·ªÉ n·∫±m trong Top 3.', hint2: 'G√¢u! (K√≠nh L√∫p) M·∫•y con v·ªÅ b√©t ·ªü v√≤ng lo·∫°i ch·∫Øc ch·∫Øn lo·∫°i r·ªìi!', guide: 'ƒêua 5 nh√≥m ƒë·∫ßu. L·∫•y 5 con nh·∫•t ƒëua v·ªõi nhau (L·∫ßn 6). T·ª´ ƒë√≥ lo·∫°i tr·ª´ ti·∫øp.', math: 'Thu·∫≠t to√°n S·∫Øp x·∫øp: S·ª≠ d·ª•ng t√≠nh ch·∫•t b·∫Øc c·∫ßu (A>B, B>C => A>C) ƒë·ªÉ lo·∫°i b·ªè d·ªØ li·ªáu th·ª´a.', rules: '<p>1. 25 con r·ªìng, ƒëua t·ªëi ƒëa 5 con/l·∫ßn.</p><p>2. Ch·ªâ bi·∫øt th·ª© t·ª± v·ªÅ ƒë√≠ch.</p><p>3. T√¨m 3 con nhanh nh·∫•t. Gi·ªõi h·∫°n 7 l·∫ßn.</p>' },
            { id: 'c8', type: 'game', game: 'balls', part: 'PH·∫¶N 3', title: 'Ch∆∞∆°ng 8: Tr√°i Tim Th·ªùi Gian', text: 'ƒê·ªânh th√°p! H·∫Øc Ph√°p S∆∞ tr·ªôn L√µi Th·ªùi Gian th·∫≠t v√†o 12 qu·∫£ c·∫ßu gi·ªëng h·ªát nhau. D√πng c√¢n 3 l·∫ßn ƒë·ªÉ t√¨m ra qu·∫£ kh√°c bi·ªát.', hint: 'Chia 12 qu·∫£ th√†nh 3 nh√≥m (4-4-4). C√¢n nh√≥m 1 v√† 2 s·∫Ω lo·∫°i tr·ª´ ƒë∆∞·ª£c nhi·ªÅu nh·∫•t.', hint2: null, guide: 'L·∫ßn 1: C√¢n 1,2,3,4 vs 5,6,7,8. N·∫øu c√¢n b·∫±ng -> L·ªói ·ªü nh√≥m c√≤n l·∫°i.', math: 'C√¢y quy·∫øt ƒë·ªãnh Tam ph√¢n: 3 l·∫ßn c√¢n cho 3^3 = 27 kh·∫£ nƒÉng, ƒë·ªß t√¨m ra 1/12.', rules: '<p>1. 12 qu·∫£ c·∫ßu, 1 qu·∫£ gi·∫£ (kh√°c kh·ªëi l∆∞·ª£ng).</p><p>2. C√¢n t·ªëi ƒëa 3 l·∫ßn.</p><p>3. T√¨m qu·∫£ gi·∫£ v√† x√°c ƒë·ªãnh N·∫∑ng/Nh·∫π.</p>' }
        ];

        class GameSwitches { constructor(){this.reset()} reset(){this.map={};let s=['A','B','C','D'].sort(()=>Math.random()-0.5);[1,2,3,4].forEach((n,i)=>this.map[n]=s[i]);this.sw={A:{on:false,heat:0},B:{on:false,heat:0},C:{on:false,heat:0},D:{on:false,heat:0}};this.time=0;this.entered=false;this.render()} toggle(k){if(!this.entered){this.sw[k].on=!this.sw[k].on;playSound('click');this.render()}} wait(){if(!this.entered){this.time+=10;Object.keys(this.sw).forEach(k=>{if(this.sw[k].on)this.sw[k].heat+=10});playSound('click');this.render()}} enter(){this.entered=true;this.render()} check(){let c=0;[1,2,3,4].forEach(n=>{if(document.getElementById(`sel-${n}`).value===this.map[n])c++});if(c===4)GameManager.win(this.time<=20);else{playSound('fail');showToast('Sai r·ªìi! H√£y th·ª≠ l·∫°i.', 'error')}} render(){ const s = document.getElementById('game-stage'); if(!s) return; if(!this.entered){ s.innerHTML=`<div class="flex flex-col items-center w-full h-full justify-start pt-4 overflow-y-auto pb-20"><div class="grid grid-cols-2 md:grid-cols-4 gap-4 w-full max-w-5xl mb-8">${['A','B','C','D'].map(k=>`<button onclick="window.ActiveGame.toggle('${k}')" class="bulb-btn h-32 md:h-40 rounded-2xl border-2 border-slate-600 text-3xl font-bold flex flex-col items-center justify-center transition-all ${this.sw[k].on?'bulb-on':'bulb-off'} shadow-lg w-full hover:scale-105"><span class="text-5xl mb-2">üí°</span><span>${k}</span><span class="text-xs opacity-70 font-normal mt-2 bg-black/30 px-3 py-1 rounded-full border border-white/20">${this.sw[k].on?'ON':'OFF'}</span></button>`).join('')}</div><div class="md:hidden fixed bottom-0 left-0 w-full flex z-50"><button onclick="window.ActiveGame.wait()" class="flex-1 py-5 bg-slate-800 hover:bg-slate-700 text-white font-bold text-lg border-r border-slate-700 rounded-none">‚è±Ô∏è Ch·ªù 10 ph√∫t</button><button onclick="window.ActiveGame.enter()" class="flex-1 py-5 bg-rose-700 hover:bg-rose-600 text-white font-bold text-lg rounded-none">üö™ V√†o Ph√≤ng</button></div><div class="hidden md:flex gap-4 w-full max-w-lg mt-auto"><button onclick="window.ActiveGame.wait()" class="flex-1 py-4 bg-slate-700 hover:bg-slate-600 rounded-xl font-bold text-white text-lg shadow-xl border border-slate-500 active:scale-95 transition-transform">‚è±Ô∏è Ch·ªù 10 ph√∫t</button><button onclick="window.ActiveGame.enter()" class="flex-1 py-4 bg-rose-600 hover:bg-rose-500 rounded-xl font-bold text-white text-lg uppercase shadow-xl border border-rose-400 active:scale-95 transition-transform">üö™ V√†o Ph√≤ng</button></div></div>`; }else{ s.innerHTML=`<div class="flex flex-col items-center w-full h-full justify-start pt-4 overflow-y-auto pb-24"><div class="grid grid-cols-1 md:grid-cols-4 gap-6 w-full max-w-6xl mb-8 px-4">${[1,2,3,4].map(n=>{const st=this.sw[this.map[n]];let txt='T·∫ÆT',sub='L·∫†NH',cls='bulb-off';if(st.on){txt='B·∫¨T';sub='N√ìNG';cls='bulb-on'}else if(st.heat>=15){sub='N√ìNG';cls='heat-high text-white'}else if(st.heat>0){sub='·∫§M';cls='heat-med text-slate-300'}return `<div class="flex flex-row md:flex-col gap-4 w-full bg-slate-800/50 p-4 rounded-2xl border border-slate-700 items-center shadow-md"><div class="${cls} h-24 w-24 md:w-full md:h-32 rounded-xl border-2 flex flex-col items-center justify-center shadow-lg transition-all shrink-0"><span class="text-xs font-bold opacity-50 mb-1">ƒê√®n ${n}</span><span class="text-xl font-black mb-1">${txt}</span><span class="text-[10px] font-bold uppercase tracking-widest bg-black/20 px-2 py-0.5 rounded-full">${sub}</span></div><select id="sel-${n}" class="flex-1 md:w-full p-4 bg-slate-900 border-2 border-slate-600 rounded-xl text-white font-bold cursor-pointer hover:border-indigo-500 outline-none text-center appearance-none text-base shadow-md"><option value="">Ch·ªçn c√¥ng t·∫Øc...</option><option value="A">C√¥ng t·∫Øc A</option><option value="B">C√¥ng t·∫Øc B</option><option value="C">C√¥ng t·∫Øc C</option><option value="D">C√¥ng t·∫Øc D</option></select></div>`}).join('')}</div><div class="fixed bottom-0 left-0 w-full p-4 bg-slate-900/90 border-t border-slate-700 z-50 flex justify-center"><button onclick="window.ActiveGame.check()" class="w-full max-w-md py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl text-xl shadow-xl hover:scale-105 transition-transform">KI·ªÇM TRA ƒê√ÅP √ÅN</button></div></div>`; } 
            if(document.getElementById('game-metric')) document.getElementById('game-metric').innerText=`${this.time} ph√∫t`; 
        } 
        getHint(t){ return ""; } 
    }

        class GameJugs { constructor(){this.reset()} reset(){this.jugs=[8,0,0];this.caps=[8,5,3];this.moves=0;this.sel=null;this.render()} click(i){if(this.sel===null){if(this.jugs[i]>0){this.sel=i;playSound('click')}}else{if(this.sel!==i)this.pour(this.sel,i);this.sel=null}this.render()} pour(f,t){const a=Math.min(this.jugs[f],this.caps[t]-this.jugs[t]);if(a>0){this.jugs[f]-=a;this.jugs[t]+=a;this.moves++;playSound('click')}if(this.jugs.includes(4))GameManager.win(this.moves===6)} render(){ document.getElementById('game-metric').innerText=`${this.moves} b∆∞·ªõc`; const hArr = [320, 200, 120]; const h=this.jugs.map((v,i)=>{ const cls=this.sel===i?'jug-selected':'border-slate-500'; const pct = (v/this.caps[i])*100; return `<div onclick="window.ActiveGame.click(${i})" style="height:${[320,200,120][i]}px" class="jug-container ${cls} flex-shrink-0"><div class="jug-water" style="height:${pct}%"></div><div class="absolute inset-0 flex items-center justify-center font-bold text-white drop-shadow-md z-10 text-3xl">${v}L</div></div>` }).join(''); document.getElementById('game-stage').innerHTML=`<div class="flex flex-col items-center justify-center h-full w-full py-8 flex-1 pt-20"><div class="flex-1 flex items-end justify-center gap-2 w-full pb-12 h-full">${h}</div><div class="text-slate-400 font-bold text-xl mb-4">Ch·ªçn b√¨nh ngu·ªìn ‚ûî Ch·ªçn b√¨nh ƒë√≠ch</div></div>` } getHint(t){ if(t==='dog') return "G√¢u! M√πi d·∫ßu ·ªü b√¨nh 5L v√† 3L l√† n·ªìng nh·∫•t, h√£y d√πng ch√∫ng ƒë·ªÉ t·∫°o ra s·ªë d∆∞!"; return ""; } }
        class GameGraph { constructor(){this.reset()} reset(){this.nodes={1:{x:275,y:50},2:{x:175,y:130},3:{x:375,y:130},4:{x:175,y:230},5:{x:375,y:230},6:{x:175,y:330},7:{x:375,y:330},8:{x:275,y:410}};this.edges=[{u:1,v:2},{u:1,v:3},{u:2,v:3},{u:2,v:4},{u:2,v:5},{u:3,v:4},{u:3,v:5},{u:4,v:5},{u:4,v:6},{u:5,v:7},{u:6,v:7},{u:6,v:8},{u:7,v:8}];this.curr=null;this.visited=new Set();this.path=[];this.bt=0; document.getElementById('game-stage').innerHTML=`<div class="w-full h-full flex items-center justify-center p-0 m-0 overflow-hidden"><canvas id="graph-canvas" class="w-full h-full"></canvas></div>`; this.resizeObserver=new ResizeObserver(()=>window.requestAnimationFrame(()=>this.draw()));this.resizeObserver.observe(document.getElementById('game-stage'));setTimeout(()=>this.draw(),50)} click(e){const c=e.target,r=c.getBoundingClientRect(),scale=(window.innerWidth>=768)?Math.min(c.width/550,c.height/450)*0.9:Math.min(c.width/550,c.height/450)*1.2,offX=(c.width-550*scale)/2,offY=(c.height-450*scale)/2,lx=(e.clientX-r.left-offX)/scale,ly=(e.clientY-r.top-offY)/scale;let h=null;for(let k in this.nodes){if(Math.hypot(lx-this.nodes[k].x,ly-this.nodes[k].y)<50)h=parseInt(k)}if(h){if(this.curr===null){this.curr=h;this.path.push(h);playSound('click')}else if(this.path.length>1&&h===this.path[this.path.length-2]){const u=Math.min(this.curr,h),v=Math.max(this.curr,h),ei=this.edges.findIndex(e=>e.u===u&&e.v===v);this.visited.delete(ei);this.path.pop();this.curr=h;this.bt++;playSound('click')}else{const u=Math.min(this.curr,h),v=Math.max(this.curr,h),ei=this.edges.findIndex(e=>e.u===u&&e.v===v);if(ei>-1&&!this.visited.has(ei)){this.visited.add(ei);this.path.push(h);this.curr=h;playSound('click')}}this.draw();if(this.visited.size===13)GameManager.win(this.bt===0)}} draw(){const c=document.getElementById('graph-canvas');if(!c)return;c.onclick=(e)=>this.click(e);const con=c.parentElement;c.width=con.clientWidth;c.height=con.clientHeight;const ctx=c.getContext('2d'),scale=(window.innerWidth>=768)?Math.min(c.width/550,c.height/450)*0.9:Math.min(c.width/550,c.height/450)*1.2,offX=(c.width-550*scale)/2,offY=(c.height-450*scale)/2;ctx.setTransform(scale,0,0,scale,offX,offY);ctx.clearRect(-offX/scale,-offY/scale,c.width/scale,c.height/scale);ctx.lineWidth=8;this.edges.forEach((e,i)=>{const n1=this.nodes[e.u],n2=this.nodes[e.v];ctx.beginPath();ctx.moveTo(n1.x,n1.y);ctx.lineTo(n2.x,n2.y);ctx.strokeStyle=this.visited.has(i)?'#fbbf24':'#475569';ctx.stroke()});for(let k in this.nodes){const n=this.nodes[k];ctx.beginPath();ctx.arc(n.x,n.y,28,0,6.28);ctx.fillStyle=parseInt(k)===this.curr?'#fbbf24':'#3b82f6';if(this.curr===null)ctx.fillStyle='#fbbf24';ctx.fill();ctx.fillStyle='white';ctx.font='bold 24px Arial';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(k,n.x,n.y)}document.getElementById('game-metric').innerText=`${13-this.visited.size} c·∫°nh`} getHint(t){ if(t==='dog') return "G√¢u! ƒêi·ªÉm g√≥c d∆∞·ªõi n√†y c√≥ m√πi l·∫°, h√£y b·∫Øt ƒë·∫ßu t·ª´ ƒë√≥!"; if(t==='robo') return "D·ªØ li·ªáu: ƒêi·ªÉm b·∫Øt ƒë·∫ßu ph·∫£i c√≥ s·ªë ƒë∆∞·ªùng n·ªëi l√† s·ªë l·∫ª."; return ""; } }
        class GameRiver { constructor(){this.reset()} reset(){this.L=[1,3,6,8,12];this.R=[];this.lamp=[];this.side='L';this.time=0;this.names={1:'üêï',3:'üë¶',6:'üßô‚Äç‚ôÇÔ∏è',8:'üêª',12:'ü§ñ'};this.render()} move(id,loc){if(loc===this.side){if(this.lamp.length<2){this[this.side]=this[this.side].filter(x=>x!==id);this.lamp.push(id);playSound('click')}}else if(loc==='lamp'){this.lamp=this.lamp.filter(x=>x!==id);this[this.side].push(id);playSound('click')}this.render()} go(){if(this.lamp.length===0){showToast('C·∫ßn ng∆∞·ªùi c·∫ßm ƒë√®n!', 'error');playSound('fail');return}this.time+=Math.max(...this.lamp);this.side=this.side==='L'?'R':'L';this.render();playSound('click');
            /* FIX: STRICT FAIL LOGIC */
            if(this.time > 30) {
                showToast('Th·∫•t b·∫°i! Qu√° 30 gi√¢y.', 'error');
                setTimeout(()=>this.reset(), 1500);
                return;
            }
            if(this.L.length===0&&this.side==='R')setTimeout(()=>GameManager.win(this.time<=29),500)} render(){ document.getElementById('game-metric').innerText=`${this.time}s`; const d=(arr,loc)=>arr.map(id=>`<div onclick="window.ActiveGame.move(${id},'${loc}')" class="char-card bg-slate-700 p-2 rounded-lg border-2 border-slate-500 flex flex-col items-center justify-center shadow-lg cursor-pointer transform active:scale-95 w-full"><span class="char-emoji text-2xl md:text-3xl">${this.names[id].split(' ')[0]}</span><span class="font-bold text-emerald-400 text-xs md:text-sm">${id}s</span></div>`).join(''); const desktopHTML = `<div class="bridge-layout shadow-2xl relative w-full h-[600px] flex"><div class="cliff-side"><div class="col-span-full text-xs font-black text-slate-500 w-full text-center mb-2 tracking-widest uppercase">V√ÅCH TR√ÅI</div>${d(this.L,'L')}</div><div class="bridge-zone"><div class="bridge-cable"></div><div class="lamp-carrier ${this.side==='L'?'pos-left':'pos-right'}"><div class="absolute -top-10 text-4xl animate-pulse">üèÆ</div>${this.lamp.map(id=>`<div onclick="window.ActiveGame.move(${id},'lamp')" class="char-card bg-amber-900/90 border-amber-500 p-1 rounded-lg text-center z-30 transform hover:scale-110 shadow-xl" style="width:50px; height:50px; min-height:0;"><div class="text-xl">${this.names[id].split(' ')[0]}</div></div>`).join('')}</div><button onclick="window.ActiveGame.go()" class="btn-go-round hover:scale-105">ƒêI</button></div><div class="cliff-side right"><div class="col-span-full text-xs font-black text-slate-500 w-full text-center mb-2 tracking-widest uppercase">V√ÅCH PH·∫¢I</div>${d(this.R,'R')}</div></div>`; const mobileHTML = `<div class="bridge-layout shadow-2xl relative"><div class="cliff-side"><div class="col-span-full text-xs font-black text-slate-500 w-full text-center mb-2 tracking-widest uppercase">V√ÅCH TR√ÅI</div>${d(this.L,'L')}</div><div class="bridge-zone"><div class="bridge-track-area w-full md:w-full relative h-full"><div class="bridge-cable"></div><div class="lamp-carrier ${this.side==='L'?'pos-left':'pos-right'}"><div class="absolute -top-10 text-4xl animate-pulse">üèÆ</div>${this.lamp.map(id=>`<div onclick="window.ActiveGame.move(${id},'lamp')" class="char-card bg-amber-900/90 border-amber-500 p-1 rounded-lg text-center z-30 transform hover:scale-110 shadow-xl" style="width:50px; height:50px; min-height:0;"><div class="text-xl">${this.names[id].split(' ')[0]}</div></div>`).join('')}</div></div></div><div class="cliff-side right"><div class="col-span-full text-xs font-black text-slate-500 w-full text-center mb-2 tracking-widest uppercase">V√ÅCH PH·∫¢I</div>${d(this.R,'R')}</div><div class="w-full p-4 mt-2 flex justify-center pb-8"><button onclick="window.ActiveGame.go()" class="btn-go-mobile">BƒÇNG QUA</button></div></div>`; const content = window.innerWidth >= 768 ? desktopHTML : mobileHTML; document.getElementById('game-stage').innerHTML = `<div class="w-full max-w-5xl mx-auto flex flex-col h-full md:justify-center md:pt-10 pb-20">${content}</div>`; } getHint(t){ if(t==='dog') return "G√¢u! ƒê·ªÉ t√¥i c·∫ßm ƒë√®n ch·∫°y v·ªÅ cho nhanh, t√¥i ch·∫°y c√≥ 1 gi√¢y th√¥i!"; if(t==='bear') return "Chi·∫øn thu·∫≠t: L∆∞·ª£t ƒëi quan tr·ªçng nh·∫•t h√£y cho 2 ng∆∞·ªùi ch·∫≠m nh·∫•t ƒëi c√πng nhau."; if(t==='robo') return "T√≠nh to√°n: C·∫ßn t·ªëi ∆∞u l∆∞·ª£t ƒëi ƒë·ªÉ gi·∫£m t·ªïng th·ªùi gian ch·ªù xu·ªëng d∆∞·ªõi 29s."; return ""; } }
        class GameCat { constructor(){this.reset()} reset(){this.day=1;this.pos=new Set([1,2,3,4,5]);this.logs=[];this.render()} check(i){if(this.pos.has(i)){if(this.pos.size===1)GameManager.win(this.day<=6);else this.pos.delete(i)}const n=new Set();this.pos.forEach(p=>{if(p>1)n.add(p-1);if(p<5)n.add(p+1)});this.pos=n;this.logs.unshift(`L·∫ßn ${this.day}: H·ªôp ${i} -> Tr·ªëng.`);this.day++;this.render(); if(this.day > 10) { showToast("Th·∫•t b·∫°i! Qu√° 10 ng√†y.", "error"); setTimeout(()=>this.giveUp(), 1500); }} 
        giveUp(){
            /* LOGIC: GENERATE VALID PATH */
            let path = [];
            let current = Array.from(this.pos)[0] || 1; // Pick a possible position
            // Generate backwards to Day 1 for visual effect, but here we just show a valid sequence
            // Simpler: Show one possible current position and movement rule
            let sequence = [current];
            for(let i=0; i<5; i++) {
                let next = (current === 1) ? 2 : (current === 5) ? 4 : (Math.random()>0.5 ? current-1 : current+1);
                sequence.push(next);
                current = next;
            }
            this.logs.unshift(`<div class="text-amber-500 font-bold">GAVE UP. M√®o ƒë√£ ƒëi: ${sequence.join(" -> ")}...</div>`);
            this.render();
            setTimeout(()=>this.reset(), 4000);
        }
        render(){ document.getElementById('game-metric').innerText=`L·∫ßn ${this.day}`; const boxes = [1,2,3,4,5].map(i=>`<button onclick="window.ActiveGame.check(${i})" class="box-btn h-24 md:h-40 flex-1 bg-slate-800 border-4 border-slate-600 rounded-2xl text-5xl md:text-7xl font-black text-slate-500 hover:text-indigo-400 hover:border-indigo-500 quantum-active transition-all shadow-xl">${i}</button>`).join(''); const logs = this.logs.map(l=>`<div class="flex justify-between text-sm md:text-base text-slate-400 mb-2 border-b border-slate-800 pb-1 font-mono"><span>${l}</span></div>`).join(''); document.getElementById('game-stage').innerHTML=`<div class="flex flex-col items-center gap-8 w-full max-w-4xl h-full justify-center pt-4 pb-8"><div class="flex gap-3 w-full justify-center">${boxes}</div><div class="text-slate-400 font-mono text-sm mb-2">Kh·∫£ nƒÉng ·∫©n n·∫•p: <span class="text-indigo-400 font-bold text-2xl">${this.pos.size}</span> v·ªã tr√≠</div><div class="w-full bg-slate-950/50 p-6 rounded-2xl border border-slate-800 h-64 flex-1 overflow-y-auto shadow-inner"><div class="text-xs font-bold text-slate-500 mb-4 uppercase tracking-widest border-b border-slate-800 pb-2 sticky top-0 bg-slate-950/90">L·ªäCH S·ª¨ M·ªû H·ªòP</div>${logs || '<div class="text-center text-slate-600 italic mt-10 text-lg">Ch∆∞a m·ªü h·ªôp n√†o...</div>'}</div></div>`} getHint(t){ if(t==='dog') return "G√¢u! H·∫Øn c√≥ m√πi ·ªü h·ªôp s·ªë 2..."; if(t==='bear') return "Chi·∫øn thu·∫≠t 'D·ªìn toa': Ki·ªÉm tra √¥ 2, n·∫øu kh√¥ng c√≥, ng√†y mai h·∫Øn ch·∫Øc ch·∫Øn ·ªü √¥ l·∫ª."; if(t==='robo') return "D·ªØ li·ªáu: Tr·∫°ng th√°i thay ƒë·ªïi lu√¢n phi√™n Ch·∫µn/L·∫ª sau m·ªói b∆∞·ªõc."; return ""; } }
        class GameSpider { 
            constructor(){this.reset()} 
            reset(){
                this.player=12; this.spider=4; this.moves=15; this.over=false; this.adj = {}; this.adj[0] = [1,2,3,4,5]; 
                for(let r=0; r<4; r++) { for(let ray=0; ray<5; ray++) { const id = 1 + (r*5) + ray; if(!this.adj[id]) this.adj[id] = []; if(ray > 0) this.adj[id].push(id - 1); if(ray < 4) this.adj[id].push(id + 1); if(r===0) { this.adj[id].push(0); } else { this.adj[id].push(id - 5); } if(r<3) { this.adj[id].push(id + 5); } } } 
                this.player = 18; this.spider = 20; 
                document.getElementById('game-stage').innerHTML=`<div class="w-full h-full flex flex-col items-center justify-center p-4" style="touch-action:none; overflow:hidden;"><div class="spider-frame relative w-full h-full flex items-center justify-center" id="spider-wrapper"><div class="absolute top-4 left-4 text-white font-bold text-xl z-10 flex items-center gap-2 pointer-events-none"><span class="text-3xl">üï∏Ô∏è</span> V√¢y B·∫Øt</div><canvas id="spider-canvas" width="600" height="600" style="max-width:100%; max-height:100%; object-fit:contain"></canvas></div></div>`; 
                this.draw(); 
                this.initPanZoom();
            } 
            
            initPanZoom() {
                const wrapper = document.getElementById('spider-wrapper');
                const canvas = document.getElementById('spider-canvas');
                let scale = 1, panning = false, pointX = 0, pointY = 0, start = { x: 0, y: 0 };
                wrapper.onmousedown = (e) => { e.preventDefault(); start = { x: e.clientX - pointX, y: e.clientY - pointY }; panning = true; }
                wrapper.onmouseup = () => { panning = false; }
                wrapper.onmousemove = (e) => { if (!panning) return; e.preventDefault(); pointX = (e.clientX - start.x); pointY = (e.clientY - start.y); canvas.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`; }
                wrapper.addEventListener('wheel', (e) => { e.preventDefault(); scale += e.deltaY * -0.001; scale = Math.min(Math.max(.5, scale), 3); canvas.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`; });
            }
            
            // BFS Algorithm
            getDist(start, end) {
                let q = [[start, 0]]; let visited = new Set([start]);
                while(q.length > 0) {
                    let [node, d] = q.shift();
                    if(node === end) return d;
                    (this.adj[node]||[]).forEach(n => {
                        if(!visited.has(n)) { visited.add(n); q.push([n, d+1]); }
                    });
                }
                return 999;
            }

            getPos(id){ const cx=300, cy=520; if(id===0) return {x:cx, y:cy}; const val = id-1; const ring = Math.floor(val/5); const ray = val % 5; const maxDists = [300, 420, 480, 420, 300]; const maxDist = maxDists[ray]; const ratio = (ring + 1) / 4; const dist = ratio * maxDist; const startAngle = -150 * (Math.PI/180); const step = 30 * (Math.PI/180); const angle = startAngle + (ray * step); return { x: cx + dist * Math.cos(angle), y: cy + dist * Math.sin(angle) }; } 
            
            getMousePos(canvas, evt) {
                var rect = canvas.getBoundingClientRect();
                return { x: (evt.clientX - rect.left) * (canvas.width / rect.width), y: (evt.clientY - rect.top) * (canvas.height / rect.height) };
            }

            click(e){ 
                if(this.over)return; 
                const canvas = document.getElementById('spider-canvas');
                const pos = this.getMousePos(canvas, e);
                let bestNode = -1; let minDist = 9999; 
                for(let i=0; i<=20; i++){ const p = this.getPos(i); const dist = Math.hypot(pos.x-p.x, pos.y-p.y); if(dist < minDist){ minDist = dist; bestNode = i; } } 
                /* FIX HITBOX to 40px */ 
                if(bestNode !== -1 && minDist < 40){ 
                    if(this.adj[this.player].includes(bestNode)){ 
                        this.player = bestNode; playSound('click'); 
                        if(this.player===this.spider) this.win(); 
                        else { this.moves--; document.getElementById('game-metric').innerText=`${this.moves} b∆∞·ªõc`; if(this.moves===0) this.fail(); else setTimeout(()=>this.ai(),300) } 
                        this.draw() 
                    } 
                } 
            } 
            ai(){ 
                if(this.over)return; 
                const nb=this.adj[this.spider]; 
                let best=-1, maxDist=-1; 
                nb.forEach(n=>{ 
                    const d = this.getDist(n, this.player); // Use BFS Distance
                    if(n!==this.player){ if(d > maxDist){ maxDist = d; best = n; } } 
                }); 
                if(best===-1) best=nb[0]; 
                this.spider=best; playSound('click'); 
                if(this.player===this.spider) this.win(); 
                this.draw(); 
            } 
            win(){this.over=true;GameManager.win(15-this.moves<=10)} 
            fail(){this.over=true;showToast('Tho√°t!', 'error');playSound('fail')} 
            draw(){ 
                const cvs=document.getElementById('spider-canvas'); if(!cvs)return;
                cvs.width = 600; cvs.height = 600; cvs.onclick=(e)=>this.click(e); 
                const ctx=cvs.getContext('2d'); ctx.clearRect(0,0,600,600); 
                const cx=300, cy=520; ctx.lineWidth=2; ctx.strokeStyle='#475569'; 
                for(let r=0; r<4; r++) { ctx.beginPath(); for(let ray=0; ray<5; ray++) { const id = 1 + (r*5) + ray; const p = this.getPos(id); if(ray===0) ctx.moveTo(p.x, p.y); else ctx.lineTo(p.x, p.y); } ctx.stroke(); } 
                for(let ray=0; ray<5; ray++) { ctx.beginPath(); ctx.moveTo(cx, cy); const outerId = 1 + (3*5) + ray; const p = this.getPos(outerId); ctx.lineTo(p.x, p.y); ctx.stroke(); } 
                for(let i=0; i<=20; i++){ const p=this.getPos(i); const isNeighbor = this.adj[this.player].includes(i); ctx.beginPath(); ctx.arc(p.x,p.y, i===0?15:10, 0, 6.28); if(i===this.player) { ctx.fillStyle='#3b82f6'; ctx.shadowBlur=20; ctx.shadowColor='#3b82f6'; } else if(i===this.spider) { ctx.fillStyle='#f472b6'; ctx.shadowBlur=20; ctx.shadowColor='#f472b6'; } else if(isNeighbor) { ctx.fillStyle='#94a3b8'; ctx.shadowBlur=0; } else { ctx.fillStyle='#1e293b'; ctx.shadowBlur=0; } ctx.fill(); if(isNeighbor) { ctx.lineWidth=2; ctx.strokeStyle='white'; ctx.stroke(); } ctx.shadowBlur=0; } ctx.fillStyle = '#ef4444'; ctx.font="bold 12px sans-serif"; ctx.textAlign="center"; ctx.fillText("O", cx, cy+30); 
            } 
            getHint(t){ if(t==='dog') return "G√¢u! Ch·∫∑n ƒë·∫ßu n√≥ ·ªü c√°i v√≤ng ngo√†i kia k√¨a!"; if(t==='bear') return "Chi·∫øn thu·∫≠t 'Bao v√¢y': ƒêi v√†o trung t√¢m tr∆∞·ªõc ƒë·ªÉ ki·ªÉm so√°t c√°c h∆∞·ªõng ra."; if(t==='robo') return "D·ªØ li·ªáu: Chi·∫øm lƒ©nh c√°c ƒëi·ªÉm trung t√¢m ƒë·ªÉ thu h·∫πp v√πng di chuy·ªÉn."; return ""; } 
        }
        class GameHorses { 
            constructor(){this.reset()} 
            reset(){
                this.track=[];this.races=0;
                this.pool=Array.from({length:25},(_,i)=>i+1);
                // RIGGED LOGIC: Put #1 and #2 in SAME initial group
                let s=Array.from({length:25},(_,i)=>i+1); 
                let group = Math.floor(Math.random()*5); 
                let idx1 = group*5 + Math.floor(Math.random()*5);
                let idx2 = group*5 + Math.floor(Math.random()*5);
                while(idx1 === idx2) idx2 = group*5 + Math.floor(Math.random()*5); // Ensure distinct positions in same group
                
                let temp = [...s];
                temp = temp.filter(x => x!==1 && x!==2);
                for(let i=temp.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[temp[i],temp[j]]=[temp[j],temp[i]]}
                
                this.speeds = {};
                let tempIdx = 0;
                for(let i=0; i<25; i++) {
                    if(i === idx1) this.speeds[i+1] = 1;
                    else if (i === idx2) this.speeds[i+1] = 2;
                    else this.speeds[i+1] = temp[tempIdx++];
                }
                this.renderHTML();
            } 
            renderHTML(){ document.getElementById('game-stage').innerHTML=`<div class="flex flex-col w-full h-full pb-10 px-4 overflow-y-auto pt-6"><div class="bg-slate-800 p-4 rounded-2xl border-2 border-slate-600 min-h-[100px] flex items-center justify-center gap-3 shadow-lg mb-4 sticky top-0 z-10"><div class="text-slate-500 text-xs font-black uppercase mr-2 tracking-widest">ƒê∆Ø·ªúNG ƒêUA</div><div id="horse-track-container" class="flex gap-2"></div><button onclick="window.ActiveGame.race()" class="px-6 py-2 bg-pink-600 hover:bg-pink-500 rounded-xl font-black text-white shadow-lg text-sm uppercase tracking-wider active:scale-95">ƒêUA</button></div><div class="flex flex-col lg:flex-row gap-6 flex-1"><div class="w-full lg:w-1/2 bg-slate-800 p-4 rounded-2xl border-2 border-slate-600 flex-1 flex-col"><div class="w-full text-slate-500 text-xs font-black uppercase mb-3 border-b border-slate-700 pb-2">TR·∫†I R·ªíNG</div><div id="horse-pool-container" class="grid grid-cols-5 gap-3 place-items-center"></div></div><div class="w-full lg:w-1/2 flex flex-col gap-4"><div class="bg-slate-800 p-4 rounded-2xl border-2 border-slate-600 flex-1 min-h-[200px] flex flex-col"><div class="text-xs font-black text-indigo-400 mb-3 uppercase tracking-widest border-b border-indigo-900 pb-2">TH√ÄNH T√çCH</div><div id="horse-logs" class="log-box flex-1 text-base space-y-3"></div></div><div class="p-5 bg-indigo-950/50 border-2 border-indigo-800 rounded-2xl shrink-0"><div class="text-xs font-black text-indigo-400 mb-3 uppercase tracking-widest">D·ª∞ ƒêO√ÅN TOP 3</div><div class="flex space-x-3 mb-4"><input type="number" id="h-pred-1" placeholder="#1" class="bg-slate-900 border-2 border-slate-600 rounded-lg p-3 w-full text-white text-center text-lg font-bold outline-none"><input type="number" id="h-pred-2" placeholder="#2" class="bg-slate-900 border-2 border-slate-600 rounded-lg p-3 w-full text-white text-center text-lg font-bold outline-none"><input type="number" id="h-pred-3" placeholder="#3" class="bg-slate-900 border-2 border-slate-600 rounded-lg p-3 w-full text-white text-center text-lg font-bold outline-none"></div><button onclick="window.ActiveGame.check()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-xl text-base uppercase shadow-lg active:scale-95">G·ª¨I K·∫æT QU·∫¢</button></div></div></div></div>`; this.updateUI(); } updateUI(){document.getElementById('game-metric').innerText=`Cu·ªôc ƒëua #${this.races}`;document.getElementById('horse-track-container').innerHTML=this.track.map(id=>`<div class="horse" onclick="window.ActiveGame.toggle(${id})">${id}</div>`).join('');document.getElementById('horse-pool-container').innerHTML=this.pool.sort((a,b)=>a-b).map(id=>`<div class="horse bg-slate-700 border-slate-500 text-slate-300 hover:bg-slate-600 hover:border-slate-300" onclick="window.ActiveGame.toggle(${id})">${id}</div>`).join('')} toggle(id){const p=this.pool.indexOf(id);if(p>-1){if(this.track.length<5){this.pool.splice(p,1);this.track.push(id);playSound('click')}}else{const t=this.track.indexOf(id);if(t>-1){this.track.splice(t,1);this.pool.push(id);playSound('click')}}this.pool.sort((a,b)=>a-b);this.updateUI()} race(){
                if(this.races >= 7) { showToast("H·∫øt l∆∞·ª£t ƒëua (Max 7)", "error"); return; }
                if(this.track.length<2)return;
                this.races++;
                const r=[...this.track].sort((a,b)=>this.speeds[a]-this.speeds[b]);
                const l=document.getElementById('horse-logs');
                l.innerHTML=`<div class="mb-3 pb-2 border-b border-slate-700"><div class="text-pink-400 font-bold mb-1">Race #${this.races}</div><div class="flex flex-wrap gap-2 text-xs text-white">${r.map((h,i)=>`<span class="${i===0?'text-emerald-400 font-bold':''}">#${i+1}: ${h}</span>`).join('<span class="text-slate-500 mx-1">|</span>')}</div></div>`+l.innerHTML;
                this.pool.push(...this.track);this.track=[];this.updateUI();
            } 
            check(){const p1=parseInt(document.getElementById('h-pred-1').value),p2=parseInt(document.getElementById('h-pred-2').value),p3=parseInt(document.getElementById('h-pred-3').value);if(!p1||!p2||!p3){showToast("Nh·∫≠p ƒë·ªß 3!", 'warning');return}const s=Object.keys(this.speeds).sort((a,b)=>this.speeds[a]-this.speeds[b]);if(p1==s[0]&&p2==s[1]&&p3==s[2])GameManager.win(this.races<=7);else{playSound('fail');showToast("Sai r·ªìi!", 'error')}} 
            useGlass(){ const l = document.getElementById('horse-logs'); const slowest = Object.keys(this.speeds).sort((a,b)=>this.speeds[b]-this.speeds[a]).slice(0,5); l.innerHTML=`<div class="mb-3 pb-2 border-b border-yellow-500/50 bg-yellow-900/20 p-2 rounded"><div class="text-yellow-400 font-bold mb-1">üîç K√çNH L√öP PH√ÅT HI·ªÜN:</div><div class="text-slate-300 text-sm">5 R·ªìng ch·∫≠m nh·∫•t: ${slowest.join(', ')}</div></div>`+l.innerHTML; } 
            getHint(t){ if(t==='dog') return "G√¢u! M·∫•y con v·ªÅ b√©t ·ªü v√≤ng lo·∫°i ch·∫Øc ch·∫Øn lo·∫°i r·ªìi!"; if(t==='bear') return "ƒêua 5 nh√≥m ƒë·∫ßu. L·∫•y 5 con nh·∫•t ƒëua v·ªõi nhau (L·∫ßn 6). T·ª´ ƒë√≥ lo·∫°i tr·ª´ ti·∫øp."; if(t==='robo') return "Thu·∫≠t to√°n: S·ª≠ d·ª•ng t√≠nh ch·∫•t b·∫Øc c·∫ßu (A>B, B>C => A>C) ƒë·ªÉ lo·∫°i b·ªè d·ªØ li·ªáu th·ª´a."; return ""; } 
        }
        class GameBalls { constructor(){this.reset()} reset(){this.pool=Array.from({length:12},(_,i)=>i+1);this.L=[];this.R=[];this.weighs=3;
            // FIX: RANDOM FAKE 3-10
            this.fake=Math.floor(Math.random()*8)+3; 
            this.heavy=Math.random()>0.5;this.selPan=null;this.render();
            /* LOGIC: Magnet finds Safe1, Dog finds Safe2. Ensure Safe1 != Safe2 != Fake */
            let safe1, safe2;
            do { safe1 = Math.floor(Math.random() * 12) + 1; } while (safe1 === this.fake);
            do { safe2 = Math.floor(Math.random() * 12) + 1; } while (safe2 === this.fake || safe2 === safe1);
            this.magnetSafe = safe1;
            this.dogSafe = safe2;
        } selectPan(s){this.selPan=(this.selPan===s)?null:s;this.updateUI()} click(id){if(this.L.includes(id)){this.L=this.L.filter(x=>x!==id);this.pool.push(id)}else if(this.R.includes(id)){this.R=this.R.filter(x=>x!==id);this.pool.push(id)}else{if(!this.selPan){showToast("Ch·ªçn ƒëƒ©a c√¢n tr∆∞·ªõc!", 'warning');return}this.pool=this.pool.filter(x=>x!==id);if(this.selPan==='L')this.L.push(id);else this.R.push(id)}this.pool.sort((a,b)=>a-b);this.L.sort((a,b)=>a-b);this.R.sort((a,b)=>a-b);playSound('click');this.updateUI()} weigh(){ if(this.weighs<=0)return;this.weighs--; const arm=document.getElementById('scale-arm'); let res=0; if(this.L.length>this.R.length)res=-1;else if(this.R.length>this.L.length)res=1;else{if(this.L.includes(this.fake))res=this.heavy?-1:1;else if(this.R.includes(this.fake))res=this.heavy?1:-1} if(res===-1){ arm.classList.add('tilt-left'); } else if(res===1){ arm.classList.add('tilt-right'); } else { arm.classList.add('balanced-anim'); } const txt=res===0?"C√ÇN B·∫∞NG":(res===-1?"TR√ÅI N·∫∂NG":"PH·∫¢I N·∫∂NG"); document.getElementById('balls-logs').innerHTML=`<div class="mb-3 pb-2 border-b border-slate-700 flex flex-col"><div class="text-amber-400 font-bold text-base">L·∫ßn #${3-this.weighs}: ${txt}</div><div class="text-slate-400 text-xs mt-1 leading-relaxed">L:[${this.L}] <br> R:[${this.R}]</div></div>`+document.getElementById('balls-logs').innerHTML; setTimeout(()=>{ arm.classList.remove('tilt-left','tilt-right','balanced-anim'); this.pool.push(...this.L, ...this.R); this.L=[]; this.R=[]; this.pool.sort((a,b)=>a-b); this.updateUI(); },2500); this.updateUI(); } check(){const id=parseInt(document.getElementById('balls-guess-id').value),st=document.getElementById('balls-guess-status').value;if(!id||!st){showToast("Ch·ªçn b√≥ng!", 'warning');return}if(id===this.fake&&st===(this.heavy?'Heavy':'Light'))GameManager.win(true);else{playSound('fail');showToast("Sai r·ªìi!", 'error')}} render(){ document.getElementById('game-stage').innerHTML=`<div class="flex flex-col lg:flex-row gap-8 w-full max-w-7xl items-start h-full pb-10 overflow-y-auto pt-6"><div class="w-full lg:w-2/3 flex flex-col items-center justify-center min-h-[450px]"><div class="relative w-full max-w-xl mx-auto mb-8 mt-4"><div class="flex justify-between items-end px-4 mb-[-5px] gap-8"><div id="pan-container-L" class="pan-container w-[45%] flex flex-col items-center cursor-pointer group" onclick="window.ActiveGame.selectPan('L')"><div class="text-xs font-bold text-slate-500 mb-2 group-hover:text-white transition-colors uppercase tracking-widest">ƒêƒ©a Tr√°i</div><div id="pan-L" class="pan w-full border-4 border-slate-500 group-hover:border-slate-300 transition-colors shadow-2xl bg-slate-800/50"></div><div class="h-12 w-2 bg-slate-500 mt-[-2px]"></div></div><div id="pan-container-R" class="pan-container w-[45%] flex flex-col items-center cursor-pointer group" onclick="window.ActiveGame.selectPan('R')"><div class="text-xs font-bold text-slate-500 mb-2 group-hover:text-white transition-colors uppercase tracking-widest">ƒêƒ©a Ph·∫£i</div><div id="pan-R" class="pan w-full border-4 border-slate-500 group-hover:border-slate-300 transition-colors shadow-2xl bg-slate-800/50"></div><div class="h-12 w-2 bg-slate-500 mt-[-2px]"></div></div></div><div class="scale-arm-wrapper"><div id="scale-arm" class="scale-arm shadow-xl border border-slate-600"></div><div class="scale-pivot"></div></div></div><button onclick="window.ActiveGame.weigh()" class="px-12 py-4 bg-indigo-600 hover:bg-indigo-500 rounded-full font-black text-white shadow-2xl text-xl uppercase tracking-widest transition-transform hover:scale-105 mb-8 border-4 border-indigo-400/30">‚öñÔ∏è C√ÇN NGAY</button><div class="w-full bg-slate-800 p-6 rounded-2xl border-2 border-slate-600 shadow-inner"><div class="text-xs font-bold text-slate-500 mb-3 uppercase tracking-widest">KHO B√ìNG</div><div id="balls-pool" class="flex flex-wrap justify-start gap-3 min-h-[80px]"></div></div></div><div class="w-full lg:w-1/3 flex flex-col gap-4 h-full"><div class="bg-slate-800 p-4 rounded-2xl border-2 border-slate-600 flex-1 min-h-[250px] flex flex-col max-h-[60vh]"><div class="text-xs font-black text-indigo-400 mb-3 uppercase tracking-widest border-b border-indigo-900 pb-2">L·ªäCH S·ª¨ C√ÇN</div><div id="balls-logs" class="log-box flex-1 text-base space-y-2"></div></div><div class="p-5 bg-emerald-900/30 border-2 border-emerald-700 rounded-2xl"><div class="text-xs font-black text-emerald-400 mb-3 uppercase tracking-widest">ƒê√ÅP √ÅN</div><div class="flex gap-3 mb-4"><select id="balls-guess-id" class="bg-slate-900 border-2 border-slate-600 rounded-xl p-3 text-white w-1/2 font-bold outline-none focus:border-emerald-500"><option value="">B√≥ng #</option>${Array.from({length:12},(_,i)=>`<option value="${i+1}">${i+1}</option>`).join('')}</select><select id="balls-guess-status" class="bg-slate-900 border-2 border-slate-600 rounded-xl p-3 text-white w-1/2 font-bold outline-none focus:border-emerald-500"><option value="">?</option><option value="Heavy">N·∫∑ng</option><option value="Light">Nh·∫π</option></select></div><button onclick="window.ActiveGame.check()" class="w-full py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl text-base uppercase shadow-lg transition-transform hover:scale-105">KI·ªÇM TRA</button></div></div></div>`; this.updateUI(); } updateUI(){ document.getElementById('game-metric').innerText=`${this.weighs} l·∫ßn`; const b=(id)=>`<div onclick="event.stopPropagation(); window.ActiveGame.click(${id})" class="ball text-base shadow-md flex items-center justify-center hover:scale-110 border-2 border-indigo-500/30 transition-transform cursor-pointer font-bold">${id}</div>`; document.getElementById('balls-pool').innerHTML = this.pool.map(b).join(''); document.getElementById('pan-L').innerHTML = this.L.map(b).join(''); document.getElementById('pan-R').innerHTML = this.R.map(b).join(''); const pL = document.getElementById('pan-L'), pR = document.getElementById('pan-R'); if(this.selPan === 'L') { pL.parentElement.classList.add('scale-105'); pL.classList.add('selected-pan'); pR.classList.remove('selected-pan'); pR.parentElement.classList.remove('scale-105'); } else if(this.selPan === 'R') { pR.parentElement.classList.add('scale-105'); pR.classList.add('selected-pan'); pL.classList.remove('selected-pan'); pL.parentElement.classList.remove('scale-105'); } else { pL.classList.remove('selected-pan'); pR.classList.remove('selected-pan'); pL.parentElement.classList.remove('scale-105'); pR.parentElement.classList.remove('scale-105'); } } 
            useMagnet(){ const l = document.getElementById('balls-logs'); l.innerHTML=`<div class="mb-3 pb-2 border-b border-red-500/50 bg-red-900/20 p-2 rounded"><div class="text-red-400 font-bold mb-1">üß≤ NAM CH√ÇM H√öT:</div><div class="text-slate-300 text-sm">B√≥ng s·ªë #${this.magnetSafe} kh√¥ng b·ªã h√∫t (L√† b√≥ng th·∫≠t)</div></div>`+l.innerHTML; } 
            getHint(t){ 
                if(t==='dog') return `G√¢u! G√¢u! M≈©i t√¥i ng·ª≠i th·∫•y b√≥ng s·ªë <b>#${this.dogSafe}</b> c√≥ m√πi gi·ªëng c√°c qu·∫£ kh√°c, n√≥ l√† b√≥ng TH·∫¨T ƒë·∫•y!`;
                if(t==='bear') return "Chia 12 qu·∫£ th√†nh 3 nh√≥m (4-4-4). C√¢n nh√≥m 1 v√† 2 s·∫Ω lo·∫°i tr·ª´ ƒë∆∞·ª£c nhi·ªÅu nh·∫•t."; 
                if(t==='robo') return "D·ªØ li·ªáu: C√¢y quy·∫øt ƒë·ªãnh Tam ph√¢n (3^3 = 27 tr∆∞·ªùng h·ª£p) ƒë·ªß ƒë·ªÉ t√¨m 1/12."; 
                return ""; 
            } 
        }

        const GameManager = {
            idx:0, gears:0, progress:{}, isTransitioning: false, visited: {}, 
            unlockedCompanions: new Set(), inventory: new Set(), usedSkills: {}, usedItems: {},

            init(){
                const s=localStorage.getItem('an_v248_save');
                if(s){
                    const d=JSON.parse(s);
                    this.idx=d.idx; this.gears=d.gears; this.progress=d.prog; this.visited=d.visited || {};
                    this.unlockedCompanions = new Set(d.unlockedCompanions || []);
                    this.inventory = new Set(d.inventory || []);
                    this.usedSkills = d.usedSkills || {};
                    this.usedItems = d.usedItems || {};
                }
                this.renderSidebar(); this.loadContent();
            },
            save(){
                localStorage.setItem('an_v248_save',JSON.stringify({
                    idx:this.idx, gears:this.gears, prog:this.progress, visited:this.visited,
                    unlockedCompanions: Array.from(this.unlockedCompanions),
                    inventory: Array.from(this.inventory),
                    usedSkills: this.usedSkills, usedItems: this.usedItems
                }));
            },
            confirmReset(){
                localStorage.removeItem('an_v248_save');
                location.reload();
            },
            renderSidebar(){
                const nav=document.getElementById('sidebar-nav'), mob=document.getElementById('mobile-nav-list');
                const inv=document.getElementById('inventory-grid');
                const mobInv=document.getElementById('mobile-inventory');
                
                if(nav) nav.innerHTML=''; if(mob) mob.innerHTML=''; if(inv) inv.innerHTML=''; if(mobInv) mobInv.innerHTML='';
                if(document.getElementById('gear-count')) document.getElementById('gear-count').innerText=`${this.gears}/8`;
                if(document.getElementById('mobile-gear')) document.getElementById('mobile-gear').innerText=`${this.gears} ‚öôÔ∏è`;

                // Inventory Render (Desktop & Mobile)
                const items = [
                    {id:'glass', icon:'üîç', name:'K√≠nh L√∫p', game: 'horses'},
                    {id:'magnet', icon:'üß≤', name:'Nam Ch√¢m', game: 'balls'}
                ];
                
                items.forEach(it => {
                    if(this.inventory.has(it.id)) {
                        const currentStory = STORY[this.idx];
                        const isUsable = currentStory && currentStory.game === it.game;
                        const isUsed = this.usedItems[this.idx]?.[it.id];
                        
                        const cls = `item-slot ${isUsed ? 'used' : (isUsable ? 'usable cursor-pointer hover:bg-slate-700' : 'opacity-50')}`;
                        const onclick = isUsable && !isUsed ? `GameManager.useItem('${it.id}')` : '';
                        
                        const el = `<div class="${cls}" title="${it.name}" onclick="${onclick}">${it.icon}</div>`;
                        if(inv) inv.innerHTML += el;
                        if(mobInv) mobInv.innerHTML += el;
                    }
                });

                let cur='';
                STORY.forEach((d,i)=>{
                    if(d.type==='text')return;
                    if(d.part!==cur){cur=d.part;if(nav)nav.innerHTML+=`<div class="nav-part-header text-xs font-bold text-slate-500 uppercase tracking-widest mt-4 mb-2 pl-2 border-l-2 border-indigo-500/30">${cur}</div>`}
                    const p=this.progress[d.id];let st='text-slate-500 cursor-not-allowed',ic='üîí';
                    const prev=STORY[i-1];
                    if(i===0||i<=this.idx||(prev&&this.progress[prev.id]?.done))st='text-slate-300 hover:bg-slate-800 cursor-pointer';
                    if(i===this.idx) st='text-indigo-400 bg-indigo-950/30 border-r-2 border-indigo-500 font-bold';
                    if(p&&p.done){st='text-emerald-400';ic='‚úÖ'}
                    if(p&&p.opt){st='text-amber-400 font-bold';ic='‚öôÔ∏è'}
                    const el=`<div class="flex items-center px-3 py-2 rounded-md transition-all mb-1 gap-2 ${st}" onclick="GameManager.jump(${i})"><span class="text-xs">${ic}</span><span class="truncate text-sm">${d.title.split(':')[1]}</span></div>`;
                    if(nav)nav.innerHTML+=el; if(mob)mob.innerHTML+=el;
                })
                
                // NEW: Add Reset Button to Mobile Menu
                if(mob) {
                    mob.innerHTML += `<div class="mt-6 pt-4 border-t border-slate-800"><button onclick="openModal('reset-modal')" class="w-full py-3 bg-red-900/30 hover:bg-red-900/50 text-red-400 font-bold rounded-lg flex items-center justify-center gap-2"><span>üóëÔ∏è</span> X√ìA H√ÄNH TR√åNH</button></div>`;
                }
            },
            useItem(itemId) {
                if(this.usedItems[this.idx]?.[itemId]) return;
                
                // Logic
                if(itemId === 'glass' && window.ActiveGame.useGlass) window.ActiveGame.useGlass();
                if(itemId === 'magnet' && window.ActiveGame.useMagnet) window.ActiveGame.useMagnet();
                
                if(!this.usedItems[this.idx]) this.usedItems[this.idx] = {};
                this.usedItems[this.idx][itemId] = true;
                this.save(); this.renderSidebar();
                showToast(`ƒê√£ s·ª≠ d·ª•ng v·∫≠t ph·∫©m!`, 'event');
            },
            useSkill(compId) {
                if(this.usedSkills[this.idx]?.[compId]) return;
                
                const content = window.ActiveGame.getHint(compId);
                document.getElementById(`content-${compId}`).innerHTML = content;
                document.getElementById(`content-${compId}`).classList.add('visible');
                document.getElementById(`btn-${compId}`).classList.remove('available');
                document.getElementById(`btn-${compId}`).classList.add('used');
                document.getElementById(`btn-${compId}`).innerText = "ƒê√£ s·ª≠ d·ª•ng";
                
                if(!this.usedSkills[this.idx]) this.usedSkills[this.idx] = {};
                this.usedSkills[this.idx][compId] = true;
                this.save();
            },
            loadContent(){
                const d=STORY[this.idx];
                
                // --- SPECIAL HANDLING FOR START PAGE ---
                if (d.id === 'intro') {
                    document.body.classList.add('intro-active');
                    // Force expand accordion
                    const wrap = document.getElementById('story-content-wrapper');
                    wrap.classList.remove('accordion-collapsed');
                    wrap.classList.add('accordion-expanded');
                } else {
                    document.body.classList.remove('intro-active');
                }

                // Update text content
                if (document.getElementById('chapter-tag-mobile')) document.getElementById('chapter-tag-mobile').innerText = d.title.split(':')[0];
                if (document.getElementById('story-title-mobile')) document.getElementById('story-title-mobile').innerText = d.title.split(':')[1] || d.title;
                if (document.getElementById('part-tag')) document.getElementById('part-tag').innerText=d.part;
                if (document.getElementById('chapter-tag')) document.getElementById('chapter-tag').innerText=d.title;
                if (document.getElementById('story-title')) document.getElementById('story-title').innerText=d.title;
                if (document.getElementById('story-text')) document.getElementById('story-text').innerText=d.text;
                
                const hText = document.getElementById('hint-text'); if(hText) hText.innerText = d.hint || 'Kh√¥ng c√≥ g·ª£i √Ω.';

                // RESET & LOAD SKILL UI
                ['dog', 'bear', 'robo'].forEach(id => {
                    const btn = document.getElementById(`btn-${id}`);
                    const content = document.getElementById(`content-${id}`);
                    const tab = document.getElementById(`comp-${id}`);
                    
                    if(tab) {
                        if(this.unlockedCompanions.has(id)) {
                            tab.classList.remove('opacity-50');
                            document.querySelector(`#comp-${id} .status-text`).innerText = "S·∫µn s√†ng";
                            if(this.usedSkills[this.idx]?.[id]) {
                                 btn.className = 'skill-btn used'; btn.innerText = 'ƒê√£ s·ª≠ d·ª•ng';
                                 // Re-fetch content if previously used
                                 if(window.ActiveGame && window.ActiveGame.getHint) {
                                     content.innerHTML = window.ActiveGame.getHint(id);
                                     content.classList.add('visible');
                                 }
                            } else {
                                 btn.className = 'skill-btn available'; btn.innerText = 'K√çCH HO·∫†T (1 L·∫ßn)';
                                 content.innerHTML = ''; content.classList.remove('visible');
                            }
                        } else {
                            tab.classList.add('opacity-50');
                            document.querySelector(`#comp-${id} .status-text`).innerText = "Ch∆∞a g·∫∑p";
                            btn.className = 'skill-btn used'; btn.innerText = '???';
                            content.classList.remove('visible');
                        }
                    }
                });

                const rulesSection = document.getElementById('game-rules-section');
                const rulesText = document.getElementById('game-rules-text');
                if (d.rules) { rulesText.innerHTML = d.rules; rulesSection.classList.remove('hidden'); } else { rulesSection.classList.add('hidden'); }
                
                const gw=document.getElementById('game-container'),ph=document.getElementById('placeholder');
                const b1=document.getElementById('btn-play');
                
                // Hide Game Container initially
                if(gw) gw.classList.add('hidden'); 
                if(ph) ph.classList.remove('hidden');
                
                const vic = document.getElementById('victory-overlay');
                // CLEANUP OVERLAY STATE ON LOAD
                if(!vic.classList.contains('victory-visible') || d.id !== 'c1') { 
                    vic.classList.remove('victory-visible'); 
                    vic.classList.remove('is-story-overlay'); 
                    vic.style.pointerEvents = 'none'; 
                    vic.innerHTML = ''; 
                }
                document.getElementById('hint-modal').style.display = 'none';
                
                if(window.innerWidth >= 768) {
                    document.body.classList.add('desktop-game-active');
                    const wrap = document.getElementById('story-content-wrapper');
                    const id = document.getElementById('accordion-icon-desktop');
                    if(wrap) {
                        wrap.classList.remove('accordion-collapsed');
                        wrap.classList.add('accordion-expanded');
                    }
                    if(id) id.innerText='‚ñ≤ Thu g·ªçn';
                } else {
                    document.body.classList.remove('desktop-game-active');
                    // On Mobile: Intro handled above. For C1+, auto collapse handled in playLevel
                }

                // Auto-Play logic for non-text levels
                if(d.type!=='text'){
                      this.playLevel(); 
                }

                if(d.type==='text'){
                    if(b1) {b1.classList.remove('hidden');b1.innerText="B·∫ÆT ƒê·∫¶U";}
                }else{
                    if(b1) {b1.classList.remove('hidden');b1.innerText="B·∫ÆT ƒê·∫¶U / TI·∫æP T·ª§C";}
                }
                
                setTimeout(() => { this.isTransitioning = false; }, 500);
            },
            closeStoryOverlay() { 
                const vic = document.getElementById('victory-overlay'); 
                vic.classList.remove('victory-visible'); 
                vic.classList.remove('is-story-overlay'); 
                vic.style.pointerEvents = 'none'; 
                this.playLevel(); 
            },
            playLevel(){
                const d=STORY[this.idx];
                
                // --- FORCE COLLAPSE STORY ON BUTTON CLICK ---
                forceCollapseStory();

                if(d.type==='text'){this.next();return}
                
                document.getElementById('game-container').classList.remove('hidden');
                document.getElementById('placeholder').classList.add('hidden');
                if (document.getElementById('game-msg')) document.getElementById('game-msg').innerText="";

                if(window.ActiveGame && window.ActiveGame.reset) window.ActiveGame = null;

                if(d.game==='switches')window.ActiveGame=new GameSwitches();
                if(d.game==='jugs')window.ActiveGame=new GameJugs();
                if(d.game==='graph')window.ActiveGame=new GameGraph();
                if(d.game==='river')window.ActiveGame=new GameRiver();
                if(d.game==='cat')window.ActiveGame=new GameCat();
                if(d.game==='spider')window.ActiveGame=new GameSpider();
                if(d.game==='horses')window.ActiveGame=new GameHorses();
                if(d.game==='balls')window.ActiveGame=new GameBalls();
                
                this.renderSidebar(); // Re-render for active items
            },
            skip(){showToast("ƒê√£ b·ªè qua m√†n ch∆°i!", 'warning');this.win(false)},
            win(opt){
                if(this.isTransitioning) return; 

                playSound('win');
                const d=STORY[this.idx];
                this.progress[d.id]={done:true,opt:opt};
                let g=0;Object.values(this.progress).forEach(v=>{if(v.opt)g++});this.gears=g;
                
                // LOGIC M·ªû KH√ìA ƒê·ªíNG H√ÄNH
                if(d.id === 'c1') { this.unlockedCompanions.add('dog'); showToast("üêï Ch√∫ Ch√≥ V√†ng ƒë√£ gia nh·∫≠p ƒë·ªôi!", "event"); }
                if(d.id === 'c2') { this.unlockedCompanions.add('robo'); showToast("ü§ñ Robo Tin-Tin ƒë√£ ƒë∆∞·ª£c s·ª≠a ch·ªØa!", "event"); }
                if(d.id === 'c3') { this.unlockedCompanions.add('bear'); this.inventory.add('glass'); showToast("üêª Gi√°o S∆∞ G·∫•u ƒë√£ gia nh·∫≠p ƒë·ªôi!", "event"); showToast("üîç ƒê√£ t√¨m th·∫•y K√≠nh L√∫p!", "event"); }
                if(d.id === 'c6') { this.inventory.add('magnet'); showToast("üß≤ ƒê√£ t√¨m th·∫•y Nam Ch√¢m!", "event"); }

                this.save(); this.renderSidebar();
                
                const nextTitle = STORY[this.idx+1] ? STORY[this.idx+1].title : "K·∫æT TH√öC";
                const nextText = STORY[this.idx+1] ? STORY[this.idx+1].text : "B·∫°n ƒë√£ ho√†n th√†nh h√†nh tr√¨nh!";
                
                const overlayHTML = `
                <div class="animate-bounce text-6xl mb-4">üéâ</div>
                <h2 class="text-4xl md:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-cyan-400 mb-2">CHI·∫æN TH·∫ÆNG!</h2>
                <p class="text-slate-300 text-lg mb-8 font-medium">${opt ? "Xu·∫•t s·∫Øc! +1 B√°nh RƒÉng V√†ng ‚öôÔ∏è" : "Ho√†n th√†nh! (Ch∆∞a t·ªëi ∆∞u)"}</p>
                
                <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 max-w-lg w-full text-left mb-8 shadow-2xl transform rotate-1 overflow-y-auto max-h-[40vh]">
                    <div class="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-2">CH∆Ø∆†NG TI·∫æP THEO</div>
                    <div class="text-xl font-bold text-white mb-2">${nextTitle}</div>
                    <p class="text-slate-400 text-sm leading-relaxed">${nextText}</p>
                </div>

                <button onclick="GameManager.next()" class="px-10 py-4 bg-white text-black font-black text-xl rounded-full shadow-[0_0_30px_rgba(255,255,255,0.3)] hover:scale-105 transition-transform flex items-center gap-2 group">
                    TI·∫æP T·ª§C <span class="group-hover:translate-x-1 transition-transform">‚ûú</span>
                </button>
                <div class="mt-4 text-xs text-slate-500 font-mono">Nh·∫•n Enter ƒë·ªÉ ti·∫øp t·ª•c</div>
                `;
                
                const vic = document.getElementById('victory-overlay');
                vic.innerHTML = overlayHTML;
                vic.classList.add('victory-visible');
                vic.style.pointerEvents = 'auto'; // Enable pointer events for buttons
            },
            next(){
                if(this.isTransitioning) return;
                this.isTransitioning = true;

                const vic = document.getElementById('victory-overlay');
                vic.classList.remove('victory-visible');
                vic.style.pointerEvents = 'none';
                
                if(this.idx<STORY.length-1){
                    this.idx++;
                    this.save();
                    this.loadContent();
                } else {
                    this.ending();
                }
            },
            jump(i){
                const prev=STORY[i-1];if((i===0)||(prev&&this.progress[prev.id]?.done)||this.progress[STORY[i].id]?.done){
                    this.idx=i;
                    this.loadContent();
                    document.getElementById('mobile-menu').classList.add('hidden');
                }
            },
            ending(){
                document.getElementById('ending-screen').classList.remove('hidden');
                const gears = this.gears;
                document.getElementById('end-score').innerText = `${gears}/8 ‚öôÔ∏è`;
                const title = document.getElementById('end-title');
                const sub = document.getElementById('end-subtitle');
                const desc = document.getElementById('end-desc');
                const rank = document.getElementById('end-rank');
                const icon = document.getElementById('end-icon');
                if(gears === 8) {
                    icon.innerText = 'üëë';
                    title.className = "text-3xl md:text-5xl font-serif font-black text-transparent bg-clip-text bg-gradient-to-r from-amber-200 via-yellow-400 to-amber-600 mb-2";
                    title.innerText = "HUY·ªÄN THO·∫†I √ÅNH S√ÅNG";
                    sub.innerText = "TRUE ENDING - HO√ÄN H·∫¢O";
                    rank.innerText = "S+"; rank.className = "text-3xl font-black text-amber-400 mt-1";
                    desc.innerHTML = `"Kh√¥ng th·ªÉ tin ƒë∆∞·ª£c!" - H·∫Øc Ph√°p S∆∞ Mu·ªôi Than th·ªët l√™n khi √°nh s√°ng t·ª´ 8 B√°nh RƒÉng V√†ng h·ª£p nh·∫•t th√†nh m·ªôt lu·ªìng nƒÉng l∆∞·ª£ng thu·∫ßn khi·∫øt, xuy√™n th·ªßng m√†n ƒë√™m vƒ©nh c·ª≠u. <br><br>Cha c·ªßa An b∆∞·ªõc ra t·ª´ kh·ªëi pha l√™ v·ª° v·ª•n, kh√¥ng m·ªôt v·∫øt x∆∞·ªõc. C√¢y ƒê√®n Ch√¢n L√Ω kh√¥ng ch·ªâ soi s√°ng con ƒë∆∞·ªùng, m√† c√≤n thanh t·∫©y t√¢m h·ªìn ƒëen t·ªëi c·ªßa k·∫ª th√π. Mu·ªôi Than, gi·ªù ƒë√¢y ƒë√£ ƒë∆∞·ª£c gi·∫£i tho√°t kh·ªèi l·ªùi nguy·ªÅn b√≥ng t·ªëi, c√∫i ƒë·∫ßu k√≠nh ph·ª•c tr√≠ tu·ªá v√† l√≤ng d≈©ng c·∫£m c·ªßa An.<br><br>V∆∞∆°ng Qu·ªëc Logic b∆∞·ªõc v√†o k·ª∑ nguy√™n th·ªãnh v∆∞·ª£ng nh·∫•t l·ªãch s·ª≠. An tr·ªü th√†nh Th·ª£ ƒê·ªìng H·ªì Ho√†ng Gia tr·∫ª tu·ªïi nh·∫•t, ng∆∞·ªùi n·∫Øm gi·ªØ ch√¨a kh√≥a c·ªßa Th·ªùi Gian v√† S·ª± Th·∫≠t. M·ªôt c√°i k·∫øt vi√™n m√£n kh√¥ng t√¨ v·∫øt!`;
                } else {
                    icon.innerText = '‚ú®';
                    title.className = "text-3xl md:text-5xl font-serif font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-200 to-cyan-500 mb-2";
                    title.innerText = "B√åNH MINH CH∆ØA TR·ªåN";
                    sub.innerText = "NORMAL ENDING";
                    let r = 'B'; if(gears > 5) { r = 'A'; rank.className = "text-3xl font-black text-emerald-400 mt-1"; } else { r = 'B'; rank.className = "text-3xl font-black text-slate-400 mt-1"; }
                    rank.innerText = r;
                    desc.innerHTML = `V·ªõi s·ªë l∆∞·ª£ng B√°nh RƒÉng thu th·∫≠p ƒë∆∞·ª£c (${gears}/8), C√¢y ƒê√®n Ch√¢n L√Ω l√≥e l√™n m·ªôt tia s√°ng m·∫°nh m·∫Ω, ƒë·ªß ƒë·ªÉ ph√° v·ª° kh·ªëi pha l√™ v√† gi·∫£i tho√°t cho Cha. Tuy nhi√™n, nƒÉng l∆∞·ª£ng ƒë√≥ ch∆∞a ƒë·ªß ƒë·ªÉ thanh t·∫©y ho√†n to√†n b√≥ng t·ªëi.<br><br>H·∫Øc Ph√°p S∆∞ Mu·ªôi Than, d√π b·ªã th∆∞∆°ng, ƒë√£ k·ªãp th·ªùi h√≥a th√†nh m·ªôt l√†n kh√≥i ƒëen v√† tr·ªën tho√°t v·ªÅ ph√≠a B·∫Øc. "Ta s·∫Ω tr·ªü l·∫°i...", ti·∫øng c∆∞·ªùi c·ªßa h·∫Øn v·ªçng l·∫°i trong gi√≥.<br><br>An d√¨u cha tr·ªü v·ªÅ nh√†. D√π gia ƒë√¨nh ƒëo√†n t·ª•, nh∆∞ng An bi·∫øt r·∫±ng, ch·ª´ng n√†o ch∆∞a thu th·∫≠p ƒë·ªß 8 B√°nh RƒÉng V√†ng ƒë·ªÉ kh√¥i ph·ª•c to√†n b·ªô s·ª©c m·∫°nh c·ªßa C√¢y ƒê√®n, V∆∞∆°ng Qu·ªëc Logic v·∫´n c√≤n n·∫±m trong m·ªëi ƒëe d·ªça ti·ªÅm t√†ng. H√†nh tr√¨nh t·∫°m k·∫øt th√∫c, nh∆∞ng th·ª≠ th√°ch v·∫´n c√≤n ƒë√≥.`;
                }
            }
        };
        
        document.addEventListener('keydown', (e) => {
            if(e.key === 'Enter' && !GameManager.isTransitioning) {
                const overlay = document.getElementById('victory-overlay');
                
                if(overlay.classList.contains('victory-visible')) {
                    // Check if it's a story overlay or a win overlay
                    if(overlay.classList.contains('is-story-overlay')) {
                        GameManager.closeStoryOverlay();
                    } else {
                        GameManager.next(); 
                    }
                } else {
                   // If no overlay, press Start Game button if present
                   const btn = document.getElementById('btn-play');
                   if(btn && !btn.classList.contains('hidden')) btn.click();
                }
            }
        });
        
        window.GameManager = GameManager;
        window.closeModal=(id)=>document.getElementById(id).style.display='none';
        window.openModal=(id)=>document.getElementById(id).style.display='flex';
        document.addEventListener('DOMContentLoaded', () => { GameManager.init(); });
    </script>
</body>
</html>
