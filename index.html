<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>H√†nh Tr√¨nh C·ªßa An - v40.0 Precision Touch</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Merriweather:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        /* --- CORE --- */
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #e2e8f0; overflow: hidden; touch-action: manipulation; }
        .font-serif { font-family: 'Merriweather', serif; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }

        /* --- TOAST --- */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 200; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { 
            background: rgba(30, 41, 59, 0.95); border-left: 4px solid #6366f1; color: white; 
            padding: 12px 24px; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5);
            animation: slideIn 0.3s ease-out, fadeOut 0.3s ease-in 2.7s forwards; 
            pointer-events: auto; font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 8px;
        }
        .toast.error { border-left-color: #f43f5e; }
        .toast.success { border-left-color: #10b981; }
        .toast.warning { border-left-color: #f59e0b; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

        /* --- MODAL --- */
        .modal { display: none; position: fixed; z-index: 100; inset: 0; background-color: rgba(0,0,0,0.9); backdrop-filter: blur(5px); align-items: center; justify-content: center; padding: 16px; }
        .modal-content { background-color: #1e293b; border: 1px solid #334155; border-radius: 1rem; max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto; animation: zoomIn 0.2s ease-out; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* GAME 1 */
        .bulb-btn { transition: all 0.1s; }
        .bulb-btn:active { transform: scale(0.98); }
        .bulb-on { background-color: #fcd34d !important; color: #713f12 !important; box-shadow: 0 0 40px #fcd34d; border-color: #fbbf24 !important; }
        .bulb-off { background-color: #1e293b; color: #64748b; border-color: #475569; }

        /* GAME 2: JUGS */
        .jug-container { position: relative; background: #334155; border-radius: 0 0 12px 12px; border: 4px solid #64748b; border-top: none; overflow: hidden; transition: all 0.2s; cursor: pointer; width: 90px; margin: 0 8px; }
        .jug-container:hover { border-color: #94a3b8; }
        .jug-water { position: absolute; bottom: 0; left: 0; width: 100%; background-color: #fbbf24; transition: height 0.5s ease; opacity: 0.9; box-shadow: inset 0 -5px 10px rgba(0,0,0,0.1); }
        .jug-selected { border-color: #d946ef !important; box-shadow: 0 0 0 4px rgba(217, 70, 239, 0.5) !important; transform: translateY(-4px); }

        /* GAME 4: BRIDGE */
        .char-card { 
            transition: all 0.2s; cursor: pointer; user-select: none; position: relative; z-index: 20; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.4); background: #1e293b; border: 2px solid #475569; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 8px; width: 100%; aspect-ratio: 1/1;
        }
        .char-card:hover { transform: translateY(-3px); border-color: #fbbf24; background: #334155; }
        
        /* Desktop Layout */
        .bridge-layout { display: flex; width: 100%; height: 600px; border: 2px solid #334155; border-radius: 16px; overflow: hidden; background: #0f172a; position: relative; }
        
        .cliff-side { 
            width: 250px; 
            height: 100%; background: #1e293b; border-right: 2px solid #334155; padding: 16px; overflow-y: auto; flex-shrink: 0;
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; 
            align-content: start; justify-items: center; z-index: 5;
        }
        .cliff-side.right { border-left: 2px solid #334155; border-right: none; }
        
        .bridge-zone { 
            flex: 1; height: 100%; position: relative; 
            background: linear-gradient(180deg, #020617 0%, #0f172a 100%); 
            overflow: hidden; 
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }
        
        /* Desktop: Button inside Bridge Zone, below cable */
        .bridge-zone .btn-go-round { margin-top: 60px; }

        .bridge-cable { position: absolute; width: 100%; height: 8px; background: #64748b; top: 40%; transform: translateY(-50%); border-radius: 4px; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        
        .lamp-carrier { 
            width: 180px; height: 180px;
            border-radius: 50%; border: 4px dashed rgba(251, 191, 36, 0.6); 
            display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 8px; padding: 20px;
            background: radial-gradient(circle, rgba(251,191,36,0.15) 0%, transparent 70%); 
            transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1); 
            z-index: 10; position: absolute; box-shadow: 0 0 30px rgba(251, 191, 36, 0.1); 
            top: 40%; margin-top: -90px;
        }
        
        .pos-left { transform: translateX(0); left: 10px; }
        .pos-right { transform: translateX(0); left: calc(100% - 190px); }

        /* GO BUTTON ROUND */
        .btn-go-round {
            width: 90px; height: 90px; border-radius: 50%;
            background: linear-gradient(135deg, #d97706, #b45309); color: white; font-weight: 900;
            box-shadow: 0 4px 15px rgba(217, 119, 6, 0.5); border: 4px solid rgba(251, 191, 36, 0.3);
            letter-spacing: 0.05em; font-size: 1.3rem; 
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; z-index: 40; cursor: pointer;
        }
        .btn-go-round:active { transform: scale(0.9); box-shadow: 0 2px 5px rgba(217, 119, 6, 0.5); }

        /* BUTTON STYLES MOBILE */
        .btn-go-mobile {
            width: 80%;
            padding: 14px; border-radius: 12px;
            background: linear-gradient(to right, #d97706, #b45309); color: white; font-weight: 900;
            box-shadow: 0 4px 15px rgba(217, 119, 6, 0.4); border: 2px solid rgba(251, 191, 36, 0.5);
            letter-spacing: 0.1em; font-size: 1.1rem; text-transform: uppercase;
            transition: all 0.2s; 
            margin-bottom: 40px; /* INCREASED BOTTOM SPACING for balance */
        }
        .btn-go-mobile:active { transform: scale(0.98); }

        /* Mobile Adjustments */
        @media (max-width: 767px) {
            .bridge-layout { flex-direction: column; height: auto; min-height: auto; border: none; background: transparent; overflow: visible; }
            .cliff-side { 
                width: 100%; height: auto; min-height: 80px; 
                border: 2px solid #334155; border-radius: 12px; background: #1e293b;
                padding: 8px; margin-bottom: 0;
                display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px;
            }
            .cliff-side.right { margin-top: 0; border-top: none; border-radius: 0 0 12px 12px; }
            .cliff-side:first-child { border-bottom: none; border-radius: 12px 12px 0 0; }
            
            /* SPLIT BRIDGE ZONE */
            .bridge-zone { 
                min-height: 280px; border: 2px solid #334155; 
                border-top: none; border-bottom: none;
                background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%);
                margin: 0; 
                display: flex; flex-direction: row; 
                align-items: stretch; justify-content: flex-start;
            }
            .bridge-zone .btn-go-round { margin-top: 0; } 
            
            .bridge-track-area { width: 100%; position: relative; height: 100%; }

            /* Cable in track area */
            .bridge-cable { width: 6px; height: 100%; top: 0; left: 50%; transform: translateX(-50%); }
            
            .lamp-carrier { 
                left: 50%; width: 120px; height: 120px; margin-left: -60px;
                top: 10px; margin-top: 0;
                transition: top 0.8s cubic-bezier(0.4, 0, 0.2, 1); 
            }
            .pos-left { top: 10px; transform: none; left: 50%; }
            .pos-right { top: calc(100% - 130px); transform: none; left: 50%; }
            
            .char-card { height: 45px; width: 100%; padding: 1px; border-radius: 4px; } 
            .char-emoji { font-size: 1.1rem; line-height: 1; }
            .char-text { font-size: 0.55rem; display: none; } 
        }

        /* GAME 5 */
        .box-btn { transition: all 0.2s; cursor: pointer; touch-action: manipulation; }
        .box-btn:active { transform: scale(0.95); }
        .quantum-active { animation: pulse-glow 2s infinite; border-color: #818cf8; }
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 5px rgba(99, 102, 241, 0.2); } 50% { box-shadow: 0 0 20px rgba(99, 102, 241, 0.5); } }

        /* GAME 6: SPIDER FRAME */
        .spider-frame {
            border: 2px solid #475569; border-radius: 24px;
            background: #0f172a; box-shadow: inset 0 0 40px rgba(0,0,0,0.6);
            overflow: hidden; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            max-width: 600px; margin: 0 auto; aspect-ratio: 1/1;
        }

        /* GAME 7 */
        .horse { width: 40px; height: 40px; border-radius: 8px; background-color: #be185d; color: white; display: flex; align-items: center; justify-content: center; font-weight: 800; cursor: pointer; transition: all 0.2s; user-select: none; border: 2px solid #fbcfe8; font-size: 0.9rem; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .horse:active { transform: scale(1.1); }
        #horse-pool-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; width: 100%; max-width: 350px; margin: 0 auto; }

        /* GAME 8 */
        .ball { width: 38px; height: 38px; border-radius: 50%; background-color: #4f46e5; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; cursor: pointer; transition: transform 0.1s; font-size: 0.8rem; margin: 2px; box-shadow: inset -5px -5px 10px rgba(0,0,0,0.4); border: 2px solid #818cf8; }
        
        .pan { 
            min-height: 120px; border: 3px solid #64748b; border-top: none; border-radius: 0 0 20px 20px; background-color: #1e293b; 
            display: grid; grid-template-columns: repeat(2, 1fr); 
            align-content: start; justify-items: center; gap: 5px; padding: 10px; 
            transition: border-color 0.3s; cursor: pointer; width: 100%; position: relative;
        }
        .pan::before { content:''; position: absolute; top: -40px; left: 50%; width: 4px; height: 40px; background: #64748b; transform: translateX(-50%); }
        @media (min-width: 768px) { .pan { grid-template-columns: repeat(4, 1fr); } }
        
        .pan:hover { border-color: #94a3b8; }
        .pan.selected-pan { border-color: #fbbf24; background-color: rgba(251, 191, 36, 0.08); box-shadow: 0 0 20px rgba(251, 191, 36, 0.15); }
        .pan.selected-pan::before { background: #fbbf24; }

        .scale-arm { width: 100%; height: 8px; background: #64748b; border-radius: 4px; transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); transform-origin: center; position: relative; }
        .scale-pivot { width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent; border-bottom: 40px solid #475569; position: absolute; bottom: -48px; left: 50%; transform: translateX(-50%); }
        
        .balanced-anim { animation: balancePulse 0.5s ease-in-out; }
        @keyframes balancePulse { 0% { transform: scaleX(1); } 50% { transform: scaleX(1.1); background-color: #10b981; } 100% { transform: scaleX(1); } }

        .tilt-left { transform: rotate(-10deg); } .tilt-right { transform: rotate(10deg); }
        .pan-container { transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); width: 40%; display: flex; flex-direction: column; items-center; }
        .pan-tilt-up { transform: translateY(-30px); } .pan-tilt-down { transform: translateY(30px); }

        /* UTILS */
        .game-canvas { display: block; width: 100%; height: 100%; object-fit: contain; }
        .story-gradient { background: linear-gradient(180deg, #1e293b 0%, #020617 100%); }
        .log-box { font-family: monospace; font-size: 0.9rem; background: #0f172a; padding: 12px; border-radius: 8px; overflow-y: auto; border: 1px solid #334155; color: #94a3b8; line-height: 1.6; }
        
        /* VICTORY OVERLAY */
        .victory-overlay { position: absolute; inset: 0; background: rgba(2, 6, 23, 0.98); backdrop-filter: blur(12px); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; pointer-events: auto; transition: opacity 0.3s ease-out; padding: 20px; text-align: center; pointer-events: none; }
        .victory-visible { opacity: 1; pointer-events: auto; }

        /* ACCORDION */
        .accordion-content { overflow: hidden; transition: max-height 0.4s ease-in-out; }
        .accordion-collapsed { max-height: 0 !important; padding-top: 0 !important; padding-bottom: 0 !important; }
        .accordion-expanded { max-height: 800px; }
        /* Desktop: Always expanded by default, can be toggled */
        @media (min-width: 768px) { 
            #story-content-wrapper.accordion-collapsed { max-height: 0 !important; }
            #story-content-wrapper:not(.accordion-collapsed) { max-height: 800px !important; }
        }
        
        /* INTRO PAGE OVERRIDE: Hide accordion toggle, force expand */
        .intro-active #accordion-icon-mobile { display: none; }
        .intro-active #accordion-icon-desktop { display: none; }
        .intro-active .accordion-content { max-height: none !important; }
    </style>
</head>
<body class="flex h-screen bg-slate-950 text-slate-200">

    <div id="toast-container"></div>

    <!-- SIDEBAR -->
    <aside class="hidden md:flex flex-col w-72 bg-slate-900 border-r border-slate-800 h-full shrink-0 z-30">
        <div class="p-6 border-b border-slate-800">
            <h1 class="text-lg font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-cyan-400">H√ÄNH TR√åNH C·ª¶A AN</h1>
            <div class="text-[10px] text-slate-500 font-bold mt-1 tracking-widest">v40.0 PRECISION TOUCH</div>
        </div>
        <nav id="sidebar-nav" class="flex-1 overflow-y-auto pb-4 space-y-1 p-2"></nav>
        <div class="p-4 border-t border-slate-800 bg-slate-900/50">
            <div class="flex justify-between items-center bg-slate-800 p-3 rounded-lg border border-slate-700 shadow-inner">
                <div class="flex items-center space-x-2"><span class="text-xl">‚öôÔ∏è</span><span class="text-xs font-bold text-amber-400 uppercase">B√°nh RƒÉng</span></div>
                <span id="gear-count" class="text-xl font-black text-white">0/8</span>
            </div>
        </div>
    </aside>

    <!-- MOBILE HEADER -->
    <div class="md:hidden fixed top-0 w-full h-14 bg-slate-900/95 backdrop-blur border-b border-slate-800 z-50 flex items-center justify-between px-4 shadow-lg">
        <span class="font-bold text-indigo-400 text-sm truncate">H√ÄNH TR√åNH C·ª¶A AN</span>
        <div class="flex items-center gap-3">
            <span class="text-amber-400 text-xs font-bold" id="mobile-gear">0 ‚öôÔ∏è</span>
            <button onclick="document.getElementById('mobile-menu').classList.toggle('hidden')" class="text-2xl p-2">‚ò∞</button>
        </div>
    </div>
    <div id="mobile-menu" class="hidden fixed top-14 left-0 w-full bg-slate-950/95 backdrop-blur z-40 border-b border-slate-800 p-4 md:hidden max-h-[80vh] overflow-y-auto shadow-2xl">
        <nav id="mobile-nav-list" class="space-y-1 pb-4"></nav>
    </div>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col relative pt-14 md:pt-0 overflow-hidden h-full">
        
        <!-- STORY ACCORDION -->
        <div id="story-section" class="bg-slate-900 border-b border-slate-800 shrink-0 z-20 shadow-md relative transition-all duration-300">
            <!-- Mobile Toggle -->
            <div class="md:hidden flex justify-between items-center p-3 bg-slate-800 cursor-pointer active:bg-slate-700 transition border-b border-slate-800" onclick="toggleStory()">
                <div class="flex items-center gap-2 overflow-hidden">
                    <span id="chapter-tag-mobile" class="text-[9px] font-bold text-slate-400 bg-slate-950 px-2 py-1 rounded border border-slate-700 shrink-0">CH∆Ø∆†NG 1</span>
                    <span id="story-title-mobile" class="text-sm font-bold text-white truncate">...</span>
                </div>
                <span id="accordion-icon-mobile" class="text-xs text-slate-500">‚ñº</span>
            </div>

            <!-- Desktop Toggle & Title -->
            <div class="hidden md:flex justify-between items-center p-4 bg-slate-800 border-b border-slate-700 cursor-pointer hover:bg-slate-750 transition" onclick="toggleStory()">
                 <div class="flex items-center gap-3">
                    <span id="part-tag" class="text-[10px] font-black text-indigo-400 uppercase tracking-widest border border-indigo-500/30 px-2 py-0.5 rounded bg-indigo-500/10">PH·∫¶N 1</span>
                    <h3 id="story-title" class="text-xl font-serif font-bold text-white truncate">...</h3>
                 </div>
                 <div class="flex items-center gap-4">
                    <span id="chapter-tag" class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">CH∆Ø∆†NG 1</span>
                    <span id="accordion-icon-desktop" class="text-slate-400 hover:text-white transition text-sm">‚ñ≤ Thu g·ªçn</span>
                 </div>
            </div>
            
            <div id="story-content-wrapper" class="accordion-content accordion-expanded p-4 md:p-6 overflow-y-auto max-h-[40vh] bg-slate-900">
                <div class="max-w-4xl mx-auto">
                    <div id="story-text" class="text-slate-300 text-sm leading-relaxed mb-4 font-light">...</div>
                    <!-- New Rules Section -->
                    <div id="game-rules-section" class="mb-6 p-4 bg-slate-950/50 rounded-xl border border-slate-800 hidden">
                        <h4 class="text-xs font-black text-amber-500 uppercase tracking-widest mb-2">H∆Ø·ªöNG D·∫™N NHI·ªÜM V·ª§</h4>
                        <div id="game-rules-text" class="text-sm text-slate-400 leading-relaxed space-y-2"></div>
                    </div>
                    <div class="flex gap-3 flex-wrap">
                        <button id="btn-play" onclick="GameManager.playLevel()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-bold rounded-lg shadow-lg transition-transform active:scale-95">B·∫ÆT ƒê·∫¶U (Enter)</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- GAME STAGE -->
        <div class="flex-1 bg-[#020617] relative overflow-hidden flex flex-col w-full">
            <div id="game-container" class="flex flex-col h-full w-full hidden">
                <!-- Sticky Toolbar -->
                <div class="flex justify-between items-center p-2 px-4 border-b border-slate-800 bg-slate-900 z-30 shrink-0 h-14">
                    <div class="flex items-center gap-3">
                        <div class="flex flex-col"><span class="text-[9px] text-slate-500 font-bold uppercase">Tr·∫°ng th√°i</span><span id="game-metric" class="font-mono text-sm text-emerald-400 font-bold">...</span></div>
                        <div id="game-msg" class="hidden"></div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="ActiveGame.reset()" class="px-3 py-1.5 bg-slate-800 hover:bg-slate-700 text-slate-300 border border-slate-600 rounded text-xs font-bold transition">‚Ü∫ Reset</button>
                        <button onclick="openModal('hint-modal')" class="px-3 py-1.5 bg-amber-900/30 hover:bg-amber-800 text-amber-200 border border-amber-700/50 rounded text-xs font-bold transition">üí° G·ª£i √Ω</button>
                        <button onclick="GameManager.skip()" class="px-3 py-1.5 bg-rose-900/20 hover:bg-rose-900 text-rose-300 border border-rose-800 rounded text-xs font-bold transition">‚è© SKIP</button>
                    </div>
                </div>

                <!-- Game Content (Scrollable) -->
                <div id="game-stage" class="flex-1 overflow-y-auto w-full p-4 relative flex flex-col items-center"></div>
            </div>
            
            <div id="placeholder" class="absolute inset-0 flex flex-col items-center justify-center opacity-20 select-none pointer-events-none">
                <div class="text-6xl md:text-8xl mb-4 grayscale">üè∞</div>
                <div class="text-xl md:text-2xl font-serif font-bold tracking-[0.2em] text-white">V∆Ø∆†NG QU·ªêC LOGIC</div>
            </div>

            <!-- VICTORY / STORY OVERLAY -->
            <div id="victory-overlay" class="victory-overlay"></div>
        </div>
    </main>

    <!-- MODALS -->
    <div id="hint-modal" class="modal" style="display:none;" onclick="closeModal('hint-modal')">
        <div class="modal-content p-8" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-2">
                <h3 class="text-xl font-bold text-amber-500">L·ªùi Khuy√™n</h3>
                <button onclick="closeModal('hint-modal')" class="text-slate-400 hover:text-white text-2xl">&times;</button>
            </div>
            <p id="hint-text" class="text-slate-300 text-base mb-6 leading-relaxed border-l-4 border-amber-500/30 pl-4">...</p>
            <div class="bg-slate-950 p-4 rounded-lg border border-slate-800"><div class="text-xs font-black text-indigo-500 mb-2 uppercase">Nguy√™n L√Ω Logic</div><p id="math-text" class="text-sm text-slate-400 italic font-serif">...</p></div>
            <button onclick="closeModal('hint-modal')" class="mt-6 w-full py-3 bg-slate-800 hover:bg-slate-700 text-white font-bold rounded-lg border border-slate-600 transition">ƒê√£ Hi·ªÉu</button>
        </div>
    </div>

    <div id="ending-screen" class="hidden fixed inset-0 z-[200] bg-black flex flex-col items-center justify-center p-6 text-center">
        <h1 id="end-title" class="text-4xl md:text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-200 to-amber-600 mb-4">THE END</h1>
        <p id="end-desc" class="text-base md:text-xl text-slate-300 max-w-xl mb-8 font-serif leading-relaxed">...</p>
        <div class="text-2xl font-bold text-white mb-8">Th√†nh t√≠ch: <span id="end-score" class="text-amber-400">0/8 ‚öôÔ∏è</span></div>
        <button onclick="localStorage.removeItem('an_v240_save'); location.reload();" class="px-8 py-3 bg-white text-black font-bold text-lg rounded-full hover:scale-105 transition-transform">CH∆†I L·∫†I T·ª™ ƒê·∫¶U</button>
    </div>

    <script>
        // --- TOAST SYSTEM ---
        function showToast(msg, type='info') {
            const c = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = `toast ${type}`; t.innerHTML = msg;
            c.appendChild(t); setTimeout(() => t.remove(), 3000);
        }

        /* UTILS */
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(t) { 
            if(audioCtx.state==='suspended')audioCtx.resume();
            if(t==='silent')return; 
            const osc=audioCtx.createOscillator(),g=audioCtx.createGain();
            osc.connect(g);g.connect(audioCtx.destination);
            const n=audioCtx.currentTime;
            if(t==='click'){osc.type='sine';osc.frequency.setValueAtTime(600,n);g.gain.setValueAtTime(0.05,n);g.gain.exponentialRampToValueAtTime(0.001,n+0.1);osc.start(n);osc.stop(n+0.1)}
            else if(t==='win'){osc.type='triangle';osc.frequency.setValueAtTime(523,n);osc.frequency.linearRampToValueAtTime(1046,n+0.3);g.gain.setValueAtTime(0.1,n);g.gain.linearRampToValueAtTime(0.001,n+1);osc.start(n);osc.stop(n+1)}
            else if(t==='fail'){osc.type='sawtooth';osc.frequency.setValueAtTime(150,n);osc.frequency.linearRampToValueAtTime(100,n+0.3);g.gain.setValueAtTime(0.1,n);g.gain.linearRampToValueAtTime(0.001,n+0.5);osc.start(n);osc.stop(n+0.5)} 
        }
        
        function toggleStory() { 
            const w=document.getElementById('story-content-wrapper');
            const im=document.getElementById('accordion-icon-mobile');
            const id=document.getElementById('accordion-icon-desktop');
            
            // Disable toggle on Intro page
            if(document.body.classList.contains('intro-active')) return;

            if(w.classList.contains('accordion-collapsed')){
                w.classList.remove('accordion-collapsed');
                w.classList.add('accordion-expanded');
                if(im) im.innerText='‚ñ≤';
                if(id) id.innerText='‚ñ≤ Thu g·ªçn';
            } else {
                w.classList.remove('accordion-expanded');
                w.classList.add('accordion-collapsed');
                if(im) im.innerText='‚ñº';
                if(id) id.innerText='‚ñº M·ªü r·ªông';
            } 
        }
        
        // Helper function to explicitly collapse the story accordion
        function forceCollapseStory() {
            const w=document.getElementById('story-content-wrapper');
            const im=document.getElementById('accordion-icon-mobile');
            const id=document.getElementById('accordion-icon-desktop');
            
            if(w) {
                w.classList.remove('accordion-expanded');
                w.classList.add('accordion-collapsed');
                if(im) im.innerText='‚ñº';
                if(id) id.innerText='‚ñº M·ªü r·ªông';
            }
        }

        /* DATA - ENRICHED STORY & RULES */
        const STORY = [
            { 
                id: 'intro', type: 'text', part: 'M·ªû ƒê·∫¶U', title: 'L·ªùi Nh·∫Øn T·ª´ Qu√° Kh·ª©', 
                text: 'An, con trai y√™u qu√Ω c·ªßa ta. N·∫øu con ƒë·ªçc ƒë∆∞·ª£c nh·ªØng d√≤ng n√†y, c√≥ l·∫Ω ta ƒë√£ kh√¥ng c√≤n ·ªü b√™n con. H·∫Øc Ph√°p S∆∞ Mu·ªôi Than - k·∫ª th√π truy·ªÅn ki·∫øp c·ªßa Ho√†ng Gia - ƒë√£ tr·ªói d·∫≠y v√† b·∫Øt c√≥c ta ƒë·ªÉ chi·∫øm ƒëo·∫°t b√≠ m·∫≠t v·ªÅ Th·ªùi Gian. Ta ƒë√£ k·ªãp gi·∫•u C√¢y ƒê√®n Ch√¢n L√Ω v√†o g√≥i b∆∞u ph·∫©m n√†y. N√≥ kh√¥ng ch·ªâ l√† m·ªôt c√¥ng c·ª•, m√† l√† ng∆∞·ªùi d·∫´n ƒë∆∞·ªùng. H√£y l·∫Øng nghe ti·∫øng n√≥i c·ªßa √°nh s√°ng, n√≥ s·∫Ω ch·ªâ cho con con ƒë∆∞·ªùng c·ª©u ta v√† c·∫£ V∆∞∆°ng Qu·ªëc Logic. H√£y d≈©ng c·∫£m l√™n, con trai!',
                rules: null 
            },
            { 
                id: 'c1', type: 'game', game: 'switches', part: 'PH·∫¶N 1: KH·ªûI ƒê·∫¶U', title: 'Ch∆∞∆°ng 1: CƒÉn Nh√† G·ªó', 
                text: 'Theo ch·ªâ d·∫´n c·ªßa ng·ªçn ƒë√®n, An t√¨m ƒë·∫øn cƒÉn nh√† g·ªó b√¨a r·ª´ng n∆°i ng∆∞·ªùi b·∫°n trung th√†nh c·ªßa cha - Ch√∫ Ch√≥ V√†ng - ƒëang b·ªã giam gi·ªØ. CƒÉn ph√≤ng t·ªëi om, ch·ªâ c√≥ m·ªôt l·ªìng nƒÉng l∆∞·ª£ng nhi·ªát ƒëang nh·ªët Ch√∫ Ch√≥. ƒê·ªÉ ph√° l·ªìng, An c·∫ßn t√¨m ƒë√∫ng c√¥ng t·∫Øc k√≠ch ho·∫°t trong 4 c√¥ng t·∫Øc tr√™n t∆∞·ªùng. Ng·ªçn ƒë√®n th√¨ th·∫ßm: "√Ånh s√°ng kh√¥ng ph·∫£i l√† t·∫•t c·∫£, h√£y c·∫£m nh·∫≠n h∆°i ·∫•m c√≤n v∆∞∆°ng l·∫°i..."', 
                hint: 'B·∫≠t c√¥ng t·∫Øc, ƒë·ª£i n√≥ng, r·ªìi t·∫Øt ƒëi. B√≥ng ƒë√®n t·∫Øt nh∆∞ng c√≤n N√ìNG ch√≠nh l√† ch√¨a kh√≥a.', math: 'Logic Nh·ªã ph√¢n m·ªü r·ªông (Tr·∫°ng th√°i th·ª© 3).',
                rules: '<p>1. C√≥ 4 c√¥ng t·∫Øc (A, B, C, D) v√† 4 b√≥ng ƒë√®n (1, 2, 3, 4) trong ph√≤ng k√≠n. B·∫°n kh√¥ng bi·∫øt c√¥ng t·∫Øc n√†o n·ªëi v·ªõi ƒë√®n n√†o.</p><p>2. B·∫°n c√≥ th·ªÉ B·∫¨T/T·∫ÆT c√¥ng t·∫Øc t√πy √Ω.</p><p>3. Nh·∫•n "‚è±Ô∏è Ch·ªù 10\'" ƒë·ªÉ c√°c ƒë√®n ƒëang B·∫¨T n√≥ng l√™n.</p><p>4. Sau khi thao t√°c xong, nh·∫•n "üö™ V√†o Ph√≤ng" ƒë·ªÉ ki·ªÉm tra tr·∫°ng th√°i (S√°ng/T·ªëi, N√≥ng/·∫§m/L·∫°nh) c·ªßa c√°c b√≥ng ƒë√®n.</p><p>5. <strong>Nhi·ªám v·ª•:</strong> X√°c ƒë·ªãnh ch√≠nh x√°c c√¥ng t·∫Øc n√†o ƒëi·ªÅu khi·ªÉn b√≥ng ƒë√®n n√†o.</p>'
            },
            { 
                id: 'c2', type: 'game', game: 'jugs', part: 'PH·∫¶N 1: KH·ªûI ƒê·∫¶U', title: 'Ch∆∞∆°ng 2: Su·ªëi D·∫ßu C·∫°n', 
                text: 'Gi·∫£i c·ª©u th√†nh c√¥ng, Ch√∫ Ch√≥ V√†ng d·∫´n An ƒë·∫øn m·ªôt su·ªëi d·∫ßu c·∫°n. T·∫°i ƒë√≥, Robo Tin-Tin - h·ªô v·ªá kh·ªïng l·ªì c·ªßa cha - ƒëang n·∫±m b·∫•t ƒë·ªông v√¨ c·∫°n ki·ªát nƒÉng l∆∞·ª£ng. L√µi nƒÉng l∆∞·ª£ng c·ªßa Tin-Tin y√™u c·∫ßu n·∫°p ch√≠nh x√°c 4 L√≠t d·∫ßu ƒë·ªÉ t√°i kh·ªüi ƒë·ªông. An ch·ªâ t√¨m th·∫•y 3 chi·∫øc b√¨nh r·ªóng v·ªõi dung t√≠ch 8L, 5L v√† 3L. M·ªôt gi·ªçt c≈©ng kh√¥ng ƒë∆∞·ª£c sai!', 
                hint: 'T·∫≠p trung v√†o s·ª± ch√™nh l·ªách. 5 - 3 = 2. L√†m sao t·ª´ 2 ra 4?', math: 'Ph∆∞∆°ng tr√¨nh Diophantine: 5x + 3y = 4.',
                rules: '<p>1. B·∫°n c√≥ 3 b√¨nh ch·ª©a v·ªõi dung t√≠ch t·ªëi ƒëa l√† 8L, 5L v√† 3L. Ban ƒë·∫ßu b√¨nh 8L ƒë·∫ßy, 2 b√¨nh kia r·ªóng.</p><p>2. <strong>C√°ch ch∆°i:</strong> Nh·∫•n v√†o m·ªôt b√¨nh ƒë·ªÉ ch·ªçn l√†m ngu·ªìn, sau ƒë√≥ nh·∫•n v√†o b√¨nh kh√°c ƒë·ªÉ ƒë·ªï d·∫ßu sang.</p><p>3. D·∫ßu s·∫Ω ƒë∆∞·ª£c ƒë·ªï cho ƒë·∫øn khi b√¨nh ngu·ªìn c·∫°n HO·∫∂C b√¨nh ƒë√≠ch ƒë·∫ßy.</p><p>4. <strong>Nhi·ªám v·ª•:</strong> T·∫°o ra ch√≠nh x√°c 4 L√≠t d·∫ßu trong b·∫•t k·ª≥ b√¨nh n√†o.</p>'
            },
            { 
                id: 'c3', type: 'game', game: 'graph', part: 'PH·∫¶N 1: KH·ªûI ƒê·∫¶U', title: 'Ch∆∞∆°ng 3: C·ªïng ƒê√° C·ªï ƒê·∫°i', 
                text: 'V·ªõi s·ª± gia nh·∫≠p c·ªßa Tin-Tin, c·∫£ nh√≥m ti·∫øn s√¢u v√†o r·ª´ng v√† b·ªã ch·∫∑n l·∫°i b·ªüi m·ªôt C·ªïng ƒê√° C·ªï ƒê·∫°i kh·ªïng l·ªì. Gi√°o S∆∞ G·∫•u - nh√† nghi√™n c·ª©u c·ªï ng·ªØ - ƒëang loay hoay tr∆∞·ªõc c·ªïng. "C·ªïng n√†y phong ·∫•n b·∫±ng m·ªôt h√¨nh v·∫Ω sao," Gi√°o S∆∞ n√≥i, "ƒê·ªÉ m·ªü n√≥, ta ph·∫£i d√πng nƒÉng l∆∞·ª£ng c·ªßa ƒë√®n v·∫Ω l·∫°i to√†n b·ªô h√¨nh ng√¥i sao n√†y b·∫±ng m·ªôt n√©t b√∫t li·ªÅn m·∫°ch, kh√¥ng ƒë∆∞·ª£c nh·∫•c tay v√† kh√¥ng ƒë∆∞·ª£c v·∫Ω l·∫°i ƒë∆∞·ªùng ƒë√£ ƒëi."', 
                hint: 'ƒê·∫øm s·ªë ƒë∆∞·ªùng n·ªëi t·∫°i m·ªói ƒëi·ªÉm. B·∫Øt ƒë·∫ßu t·ª´ ƒëi·ªÉm c√≥ s·ªë ƒë∆∞·ªùng n·ªëi L·∫∫.', math: 'ƒê∆∞·ªùng ƒëi Euler: ƒê·ªì th·ªã c√≥ 0 ho·∫∑c 2 ƒë·ªânh b·∫≠c l·∫ª.',
                rules: '<p>1. B·∫°n c·∫ßn v·∫Ω l·∫°i h√¨nh ng√¥i sao tr√™n c·ªïng ƒë√°.</p><p>2. <strong>C√°ch ch∆°i:</strong> Nh·∫•n v√†o m·ªôt ƒëi·ªÉm (node) ƒë·ªÉ b·∫Øt ƒë·∫ßu. Sau ƒë√≥ nh·∫•n v√†o c√°c ƒëi·ªÉm k·ªÅ nhau ƒë·ªÉ di chuy·ªÉn.</p><p>3. <strong>Lu·∫≠t:</strong> B·∫°n ph·∫£i ƒëi qua T·∫§T C·∫¢ c√°c ƒë∆∞·ªùng n·ªëi (c·∫°nh) m√†u x√°m ƒë√∫ng 1 l·∫ßn duy nh·∫•t.</p><p>4. N·∫øu ƒëi sai ho·∫∑c h·∫øt ƒë∆∞·ªùng, nh·∫•n n√∫t "‚Ü∫ Reset" ƒë·ªÉ l√†m l·∫°i.</p>'
            },
            { 
                id: 'c4', type: 'game', game: 'river', part: 'PH·∫¶N 2: H√ÄNH TR√åNH', title: 'Ch∆∞∆°ng 4: C√¢y C·∫ßu ƒê·ª©t G√£y', 
                text: 'C·ªïng ƒë√° m·ªü ra m·ªôt v·ª±c th·∫≥m. C√¢y c·∫ßu treo duy nh·∫•t ƒë√£ b·ªã ƒë·ª©t g√£y, ch·ªâ hi·ªán ra l·ªù m·ªù d∆∞·ªõi √°nh s√°ng c·ªßa C√¢y ƒê√®n Ch√¢n L√Ω. M·ªôt L·ªØ Kh√°ch B√≠ ·∫®n xu·∫•t hi·ªán v√† xin ƒëi nh·ªù. Ng·ªçn ƒë√®n c·∫£nh b√°o nƒÉng l∆∞·ª£ng ch·ªâ c√≤n ƒë·ªß chi·∫øu s√°ng trong 29 gi√¢y. C·∫£ nh√≥m ph·∫£i qua c·∫ßu tr∆∞·ªõc khi b√≥ng t·ªëi nu·ªët ch·ª≠ng t·∫•t c·∫£. Nh∆∞ng c√¢y c·∫ßu ch·ªâ ch·ªãu ƒë∆∞·ª£c t·ªëi ƒëa 2 ng∆∞·ªùi m·ªôt l√∫c, v√† b·∫Øt bu·ªôc ph·∫£i c√≥ ng∆∞·ªùi c·∫ßm ƒë√®n ƒë·ªÉ soi ƒë∆∞·ªùng.', 
                hint: 'ƒê·ª´ng ƒë·ªÉ ng∆∞·ªùi nhanh nh·∫•t l√†m m·ªçi vi·ªác. H√£y ƒë·ªÉ hai ng∆∞·ªùi ch·∫≠m nh·∫•t (G·∫•u & Robo) ƒëi c√πng nhau m·ªôt l∆∞·ª£t.', math: 'B√†i to√°n l·∫≠p l·ªãch t·ªëi ∆∞u (Critical Path).',
                rules: '<p>1. <strong>M·ª•c ti√™u:</strong> ƒê∆∞a t·∫•t c·∫£ 5 th√†nh vi√™n (Ch√≥, An, Kh√°ch, G·∫•u, Robo) qua b·ªù ph·∫£i trong v√≤ng 29 gi√¢y.</p><p>2. <strong>T·ªëc ƒë·ªô:</strong> Ch√≥(1s), An(3s), Kh√°ch(6s), G·∫•u(8s), Robo(12s).</p><p>3. <strong>Lu·∫≠t ƒëi:</strong><br>- T·ªëi ƒëa 2 ng∆∞·ªùi l√™n c·∫ßu m·ªôt l∆∞·ª£t.<br>- Ph·∫£i c√≥ ng∆∞·ªùi c·∫ßm ƒë√®n (üèÆ) m·ªõi ƒë∆∞·ª£c ƒëi.<br>- Th·ªùi gian ƒëi t√≠nh theo ng∆∞·ªùi ch·∫≠m nh·∫•t trong l∆∞·ª£t ƒë√≥.</p><p>4. <strong>C√°ch ch∆°i:</strong> Nh·∫•n v√†o nh√¢n v·∫≠t ƒë·ªÉ ƒë∆∞a l√™n/xu·ªëng ƒë√®n. Nh·∫•n n√∫t "BƒÇNG QUA" (ho·∫∑c n√∫t tr√≤n "ƒêI") ƒë·ªÉ di chuy·ªÉn.</p>'
            },
            { 
                id: 'c5', type: 'game', game: 'cat', part: 'PH·∫¶N 2: H√ÄNH TR√åNH', title: 'Ch∆∞∆°ng 5: S·ª± Ph·∫£n B·ªôi', 
                text: 'Ngay khi qua c·∫ßu an to√†n, L·ªØ Kh√°ch B√≠ ·∫®n c∆∞·ªùi nham hi·ªÉm v√† hi·ªán nguy√™n h√¨nh l√† H·∫Øc Ph√°p S∆∞ Mu·ªôi Than! H·∫Øn gi·∫≠t l·∫•y m·∫£nh b·∫£n ƒë·ªì t·ª´ tay An r·ªìi bi·∫øn m·∫•t v√†o khu r·ª´ng ma thu·∫≠t. Khu r·ª´ng n√†y c√≥ 5 b·ª•i c√¢y l∆∞·ª£ng t·ª≠, v√† h·∫Øn ch·ªâ c√≥ th·ªÉ l·∫©n tr·ªën trong ƒë√≥. H·∫Øn c√≥ th√≥i quen k·ª≥ l·∫°: m·ªói khi b·∫°n ki·ªÉm tra m·ªôt h·ªôp, h·∫Øn b·∫Øt bu·ªôc ph·∫£i nh·∫£y sang m·ªôt h·ªôp ngay b√™n c·∫°nh.', 
                hint: 'N·∫øu h·∫Øn ·ªü √¥ Ch·∫µn, l·∫ßn sau h·∫Øn ph·∫£i sang L·∫ª. H√£y ki·ªÉm tra theo tr√¨nh t·ª±.', math: 'ƒê·ªì th·ªã l∆∞·ª°ng ph√¢n (T√≠nh ch·∫µn l·∫ª/Parity).',
                rules: '<p>1. H·∫Øc Ph√°p S∆∞ tr·ªën trong 1 trong 5 h·ªôp (ƒë√°nh s·ªë 1-5).</p><p>2. <strong>M·ªói l∆∞·ª£t</strong>, b·∫°n ƒë∆∞·ª£c ph√©p ch·ªçn m·ªü 1 h·ªôp ƒë·ªÉ ki·ªÉm tra.</p><p>3. <strong>Sau m·ªói l·∫ßn ki·ªÉm tra</strong>, h·∫Øn S·∫º di chuy·ªÉn sang h·ªôp li·ªÅn k·ªÅ (VD: t·ª´ 2 sang 1 ho·∫∑c 3).</p><p>4. <strong>Nhi·ªám v·ª•:</strong> T√¨m ra v·ªã tr√≠ ch√≠nh x√°c c·ªßa h·∫Øn trong t·ªëi ƒëa 6 l·∫ßn th·ª≠.</p>'
            },
            { 
                id: 'c6', type: 'game', game: 'spider', part: 'PH·∫¶N 2: H√ÄNH TR√åNH', title: 'Ch∆∞∆°ng 6: V√¢y B·∫Øt Nh·ªán M√°y', 
                text: 'B·ªã d·ªìn v√†o ƒë∆∞·ªùng c√πng, H·∫Øc Ph√°p S∆∞ tri·ªáu h·ªìi m·ªôt con Nh·ªán M√°y Kh·ªïng L·ªì ƒë·ªÉ ch·∫∑n ƒë∆∞·ªùng r·ªìi ti·∫øp t·ª•c b·ªè ch·∫°y. Con nh·ªán di chuy·ªÉn c·ª±c nhanh tr√™n m·∫°ng l∆∞·ªõi c·ªßa n√≥. An ph·∫£i s·ª≠ d·ª•ng kh·∫£ nƒÉng c·ªßa C√¢y ƒê√®n ƒë·ªÉ x√¢m nh·∫≠p v√†o h·ªá th·ªëng radar, ƒëi·ªÅu khi·ªÉn c√°c ƒëi·ªÉm n√∫t tr√™n m·∫°ng nh·ªán ƒë·ªÉ v√¢y b·∫Øt v√† v√¥ hi·ªáu h√≥a con qu√°i v·∫≠t n√†y tr∆∞·ªõc khi n√≥ tr·ªën tho√°t.', 
                hint: 'ƒê·ª´ng ch·∫°y theo ƒëu√¥i. H√£y chi·∫øm c√°c giao l·ªô quan tr·ªçng ƒë·ªÉ c·∫Øt ƒë∆∞·ªùng r√∫t lui.', math: 'L√Ω thuy·∫øt tr√≤ ch∆°i ƒëu·ªïi b·∫Øt tr√™n ƒë·ªì th·ªã.',
                rules: '<p>1. B·∫°n ƒëi·ªÅu khi·ªÉn ƒëi·ªÉm m√†u Xanh (üîµ), Nh·ªán l√† ƒëi·ªÉm m√†u H·ªìng (üî¥).</p><p>2. <strong>C√°ch ch∆°i:</strong> Nh·∫•n v√†o c√°c ƒëi·ªÉm n√∫t l√¢n c·∫≠n (c√≥ ƒë∆∞·ªùng n·ªëi m√†u tr·∫Øng) ƒë·ªÉ di chuy·ªÉn.</p><p>3. <strong>Lu·∫≠t:</strong><br>- B·∫°n ƒëi tr∆∞·ªõc 1 b∆∞·ªõc, Nh·ªán ƒëi sau 1 b∆∞·ªõc.<br>- Nh·ªán s·∫Ω lu√¥n c·ªë g·∫Øng di chuy·ªÉn ra xa b·∫°n nh·∫•t c√≥ th·ªÉ.</p><p>4. <strong>Nhi·ªám v·ª•:</strong> B·∫Øt ƒë∆∞·ª£c Nh·ªán (di chuy·ªÉn v√†o c√πng v·ªã tr√≠) trong t·ªëi ƒëa 15 b∆∞·ªõc ƒëi c·ªßa b·∫°n.</p>'
            },
            { 
                id: 'c7', type: 'game', game: 'horses', part: 'PH·∫¶N 3: ƒê·ªàNH CAO', title: 'Ch∆∞∆°ng 7: Tri·ªáu H·ªìi R·ªìng', 
                text: 'V∆∞·ª£t qua Nh·ªán M√°y, c·∫£ nh√≥m ƒë·∫øn ƒë∆∞·ª£c ch√¢n T√≤a Th√°p Th·ªùi Gian. C·∫ßu thang ƒë√£ b·ªã ph√° h·ªßy. C√°ch duy nh·∫•t ƒë·ªÉ l√™n ƒë·ªânh l√† nh·ªù s·ª± tr·ª£ gi√∫p c·ªßa lo√†i R·ªìng. T·∫°i Tr·∫°i R·ªìng g·∫ßn ƒë√≥, c√≥ 25 con r·ªìng ƒëang ng·ªß say. An c·∫ßn ƒë√°nh th·ª©c 3 con r·ªìng nhanh nh·∫•t ƒë·ªÉ ƒë∆∞a m·ªçi ng∆∞·ªùi l√™n ƒë·ªânh th√°p. Kh√¥ng c√≥ thi·∫øt b·ªã ƒëo th·ªùi gian, An ch·ªâ c√≥ th·ªÉ t·ªï ch·ª©c c√°c cu·ªôc ƒëua gi·ªØa ch√∫ng ƒë·ªÉ x√°c ƒë·ªãnh th·ª© h·∫°ng.', 
                hint: 'Chia 25 con th√†nh 5 nh√≥m ƒëua. Lo·∫°i b·ªè nh·ªØng con kh√¥ng th·ªÉ n·∫±m trong Top 3 d·ª±a tr√™n t√≠nh ch·∫•t b·∫Øc c·∫ßu.', math: 'Thu·∫≠t to√°n s·∫Øp x·∫øp v√† l·ª±a ch·ªçn t·ªëi ∆∞u.',
                rules: '<p>1. C√≥ 25 con r·ªìng v·ªõi t·ªëc ƒë·ªô kh√°c nhau (b·∫°n kh√¥ng bi·∫øt t·ªëc ƒë·ªô c·ª• th·ªÉ).</p><p>2. ƒê∆∞·ªùng ƒëua ch·ªâ cho ph√©p t·ªëi ƒëa 5 con r·ªìng ch·∫°y c√πng l√∫c.</p><p>3. Sau m·ªói cu·ªôc ƒëua, b·∫°n ch·ªâ bi·∫øt th·ª© t·ª± v·ªÅ ƒë√≠ch (nh·∫•t, nh√¨, ba...), kh√¥ng bi·∫øt th·ªùi gian.</p><p>4. <strong>C√°ch ch∆°i:</strong> Ch·ªçn 2-5 con r·ªìng t·ª´ "Tr·∫°i R·ªìng" ƒë∆∞a v√†o "ƒê∆∞·ªùng ƒêua", r·ªìi nh·∫•n "ƒêUA".</p><p>5. <strong>Nhi·ªám v·ª•:</strong> X√°c ƒë·ªãnh ch√≠nh x√°c 3 con r·ªìng nhanh nh·∫•t (theo th·ª© t·ª± #1, #2, #3) v·ªõi s·ªë l·∫ßn ƒëua √≠t nh·∫•t (T·ªëi ∆∞u: 7 l·∫ßn).</p>'
            },
            { 
                id: 'c8', type: 'game', game: 'balls', part: 'PH·∫¶N 3: ƒê·ªàNH CAO', title: 'Ch∆∞∆°ng 8: Tr√°i Tim Th·ªùi Gian', 
                text: 'ƒê·ªânh th√°p! Cha c·ªßa An ƒëang b·ªã giam gi·ªØ trong m·ªôt kh·ªëi pha l√™ th·ªùi gian. H·∫Øc Ph√°p S∆∞ ƒë√£ tr·ªôn L√µi Th·ªùi Gian th·∫≠t v√†o 12 qu·∫£ c·∫ßu nƒÉng l∆∞·ª£ng gi·ªëng h·ªát nhau. H·∫Øn c∆∞·ªùi nh·∫°o: "Ch·ªâ c√≥ L√µi th·∫≠t m·ªõi ph√° ƒë∆∞·ª£c pha l√™. N·∫øu ch·ªçn sai, cha ng∆∞∆°i s·∫Ω b·ªã k·∫πt trong d√≤ng th·ªùi gian m√£i m√£i!". Chi·∫øc c√¢n thƒÉng b·∫±ng c·ªï x∆∞a ·ªü gi·ªØa ph√≤ng l√† hy v·ªçng duy nh·∫•t. An ch·ªâ c√≥ 3 l·∫ßn c√¢n ƒë·ªÉ t√¨m ra qu·∫£ c·∫ßu ch·ª©a L√µi th·∫≠t v√† bi·∫øt n√≥ N·∫∑ng hay Nh·∫π h∆°n c√°c qu·∫£ kh√°c.', 
                hint: 'Chia 12 qu·∫£ th√†nh 3 nh√≥m (4-4-4). C√¢n nh√≥m 1 v√† 2 s·∫Ω lo·∫°i tr·ª´ ƒë∆∞·ª£c nhi·ªÅu nh·∫•t.', math: 'C√¢y quy·∫øt ƒë·ªãnh tam ph√¢n (Ternary Search Tree).',
                rules: '<p>1. C√≥ 12 qu·∫£ c·∫ßu (ƒë√°nh s·ªë 1-12). M·ªôt qu·∫£ l√† gi·∫£ (kh√°c kh·ªëi l∆∞·ª£ng), 11 qu·∫£ c√≤n l·∫°i l√† th·∫≠t (c√πng kh·ªëi l∆∞·ª£ng).</p><p>2. B·∫°n c√≥ m·ªôt chi·∫øc c√¢n thƒÉng b·∫±ng v√† ƒë∆∞·ª£c ph√©p c√¢n t·ªëi ƒëa 3 l·∫ßn.</p><p>3. <strong>C√°ch ch∆°i:</strong><br>- Nh·∫•n ch·ªçn "ƒêƒ©a Tr√°i" ho·∫∑c "ƒêƒ©a Ph·∫£i".<br>- Nh·∫•n v√†o c√°c qu·∫£ b√≥ng ƒë·ªÉ ƒë·∫∑t l√™n ƒëƒ©a c√¢n ƒë√£ ch·ªçn.<br>- Nh·∫•n "‚öñÔ∏è C√ÇN NGAY" ƒë·ªÉ xem k·∫øt qu·∫£ (Tr√°i n·∫∑ng, Ph·∫£i n·∫∑ng, ho·∫∑c C√¢n b·∫±ng).</p><p>4. <strong>Nhi·ªám v·ª•:</strong> Sau 3 l·∫ßn c√¢n, x√°c ƒë·ªãnh ch√≠nh x√°c qu·∫£ b√≥ng n√†o l√† gi·∫£ v√† n√≥ N·∫∑ng hay Nh·∫π h∆°n b√≥ng th·∫≠t.</p>'
            }
        ];

        /* --- GAMES --- */
        class GameSwitches {
            constructor(){this.reset()}
            reset(){this.map={};let s=['A','B','C','D'].sort(()=>Math.random()-0.5);[1,2,3,4].forEach((n,i)=>this.map[n]=s[i]);this.sw={A:{on:false,heat:0},B:{on:false,heat:0},C:{on:false,heat:0},D:{on:false,heat:0}};this.time=0;this.entered=false;this.render()}
            toggle(k){if(!this.entered){this.sw[k].on=!this.sw[k].on;playSound('click');this.render()}}
            wait(){if(!this.entered){this.time+=10;Object.keys(this.sw).forEach(k=>{if(this.sw[k].on)this.sw[k].heat+=10});playSound('click');this.render()}}
            enter(){this.entered=true;this.render()}
            check(){let c=0;[1,2,3,4].forEach(n=>{if(document.getElementById(`sel-${n}`).value===this.map[n])c++});if(c===4)GameManager.win(this.time<=20);else{playSound('fail');showToast('Sai r·ªìi! H√£y th·ª≠ l·∫°i.', 'error')}}
            render(){
                const m = document.getElementById('game-metric'); if(m) m.innerText=`${this.time} ph√∫t`;
                const s = document.getElementById('game-stage'); if(!s) return;
                
                if(!this.entered){
                    s.innerHTML=`
                    <div class="flex flex-col items-center w-full h-full justify-start pt-4 overflow-y-auto pb-20">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 w-full max-w-5xl mb-8">
                            ${['A','B','C','D'].map(k=>`
                                <button onclick="window.ActiveGame.toggle('${k}')" class="bulb-btn h-32 md:h-40 rounded-2xl border-2 border-slate-600 text-3xl font-bold flex flex-col items-center justify-center transition-all ${this.sw[k].on?'bulb-on':'bulb-off'} shadow-lg w-full hover:scale-105">
                                    <span class="text-5xl mb-2">üí°</span>
                                    <span>${k}</span>
                                    <span class="text-xs opacity-70 font-normal mt-2 bg-black/30 px-3 py-1 rounded-full border border-white/20">${this.sw[k].on?'ON':'OFF'}</span>
                                </button>
                            `).join('')}
                        </div>
                        <div class="md:hidden fixed bottom-0 left-0 w-full flex z-50">
                             <button onclick="window.ActiveGame.wait()" class="flex-1 py-5 bg-slate-800 hover:bg-slate-700 text-white font-bold text-lg border-r border-slate-700 rounded-none">‚è±Ô∏è Ch·ªù 10'</button>
                             <button onclick="window.ActiveGame.enter()" class="flex-1 py-5 bg-rose-700 hover:bg-rose-600 text-white font-bold text-lg rounded-none">üö™ V√†o Ph√≤ng</button>
                        </div>
                        <div class="hidden md:flex gap-4 w-full max-w-lg mt-auto">
                             <button onclick="window.ActiveGame.wait()" class="flex-1 py-4 bg-slate-700 hover:bg-slate-600 rounded-xl font-bold text-white text-lg shadow-xl border border-slate-500 active:scale-95 transition-transform">‚è±Ô∏è Ch·ªù 10'</button>
                             <button onclick="window.ActiveGame.enter()" class="flex-1 py-4 bg-rose-600 hover:bg-rose-500 rounded-xl font-bold text-white text-lg uppercase shadow-xl border border-rose-400 active:scale-95 transition-transform">üö™ V√†o Ph√≤ng</button>
                        </div>
                    </div>`;
                }else{
                    s.innerHTML=`<div class="flex flex-col items-center w-full h-full justify-start pt-4 overflow-y-auto pb-24"><div class="grid grid-cols-1 md:grid-cols-4 gap-6 w-full max-w-6xl mb-8 px-4">${[1,2,3,4].map(n=>{const st=this.sw[this.map[n]];let txt='T·∫ÆT',sub='L·∫†NH',cls='bulb-off';if(st.on){txt='B·∫¨T';sub='N√ìNG';cls='bulb-on'}else if(st.heat>=15){sub='N√ìNG';cls='heat-high text-white'}else if(st.heat>0){sub='·∫§M';cls='heat-med text-slate-300'}return `<div class="flex flex-row md:flex-col gap-4 w-full bg-slate-800/50 p-4 rounded-2xl border border-slate-700 items-center shadow-md"><div class="${cls} h-24 w-24 md:w-full md:h-32 rounded-xl border-2 flex flex-col items-center justify-center shadow-lg transition-all shrink-0"><span class="text-xs font-bold opacity-50 mb-1">ƒê√®n ${n}</span><span class="text-xl font-black mb-1">${txt}</span><span class="text-[10px] font-bold uppercase tracking-widest bg-black/20 px-2 py-0.5 rounded-full">${sub}</span></div><select id="sel-${n}" class="flex-1 md:w-full p-4 bg-slate-900 border-2 border-slate-600 rounded-xl text-white font-bold cursor-pointer hover:border-indigo-500 outline-none text-center appearance-none text-base shadow-md"><option value="">Ch·ªçn c√¥ng t·∫Øc...</option><option value="A">C√¥ng t·∫Øc A</option><option value="B">C√¥ng t·∫Øc B</option><option value="C">C√¥ng t·∫Øc C</option><option value="D">C√¥ng t·∫Øc D</option></select></div>`}).join('')}</div><div class="fixed bottom-0 left-0 w-full p-4 bg-slate-900/90 border-t border-slate-700 z-50 flex justify-center"><button onclick="window.ActiveGame.check()" class="w-full max-w-md py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl text-xl shadow-xl hover:scale-105 transition-transform">KI·ªÇM TRA ƒê√ÅP √ÅN</button></div></div>`;
                }
            }
        }

        class GameJugs {
            constructor(){this.reset()}
            reset(){this.jugs=[8,0,0];this.caps=[8,5,3];this.moves=0;this.sel=null;this.render()}
            click(i){if(this.sel===null){if(this.jugs[i]>0){this.sel=i;playSound('click')}}else{if(this.sel!==i)this.pour(this.sel,i);this.sel=null}this.render()}
            pour(f,t){const a=Math.min(this.jugs[f],this.caps[t]-this.jugs[t]);if(a>0){this.jugs[f]-=a;this.jugs[t]+=a;this.moves++;playSound('click')}if(this.jugs.includes(4))GameManager.win(this.moves===6)}
            render(){
                document.getElementById('game-metric').innerText=`${this.moves} b∆∞·ªõc`;
                const hArr = [320, 200, 120];
                const h=this.jugs.map((v,i)=>{
                    const cls=this.sel===i?'jug-selected':'border-slate-500';
                    const pct = (v/this.caps[i])*100;
                    return `<div onclick="window.ActiveGame.click(${i})" style="height:${hArr[i]}px" class="jug-container ${cls} flex-shrink-0"><div class="jug-water" style="height:${pct}%"></div><div class="absolute inset-0 flex items-center justify-center font-bold text-white drop-shadow-md z-10 text-3xl">${v}L</div></div>`
                }).join('');
                document.getElementById('game-stage').innerHTML=`<div class="flex flex-col items-center justify-center h-full w-full py-8 flex-1 pt-20"><div class="flex-1 flex items-end justify-center gap-2 w-full pb-12 h-full">${h}</div><div class="text-slate-400 font-bold text-xl mb-4">Ch·ªçn b√¨nh ngu·ªìn ‚ûî Ch·ªçn b√¨nh ƒë√≠ch</div></div>`
            }
        }

        class GameGraph {
            constructor(){this.reset()}
            reset(){this.nodes={1:{x:275,y:50},2:{x:175,y:130},3:{x:375,y:130},4:{x:175,y:230},5:{x:375,y:230},6:{x:175,y:330},7:{x:375,y:330},8:{x:275,y:410}};this.edges=[{u:1,v:2},{u:1,v:3},{u:2,v:3},{u:2,v:4},{u:2,v:5},{u:3,v:4},{u:3,v:5},{u:4,v:5},{u:4,v:6},{u:5,v:7},{u:6,v:7},{u:6,v:8},{u:7,v:8}];this.curr=null;this.visited=new Set();this.path=[];this.bt=0;
            document.getElementById('game-stage').innerHTML=`<div class="w-full h-full flex items-center justify-center p-0 m-0 overflow-hidden"><canvas id="graph-canvas" class="w-full h-full"></canvas></div>`;
            this.resizeObserver=new ResizeObserver(()=>window.requestAnimationFrame(()=>this.draw()));this.resizeObserver.observe(document.getElementById('game-stage'));setTimeout(()=>this.draw(),50)}
            click(e){const c=e.target,r=c.getBoundingClientRect(),scale=(window.innerWidth>=768)?Math.min(c.width/550,c.height/450)*0.9:Math.min(c.width/550,c.height/450)*1.2,offX=(c.width-550*scale)/2,offY=(c.height-450*scale)/2,lx=(e.clientX-r.left-offX)/scale,ly=(e.clientY-r.top-offY)/scale;let h=null;for(let k in this.nodes){if(Math.hypot(lx-this.nodes[k].x,ly-this.nodes[k].y)<50)h=parseInt(k)}if(h){if(this.curr===null){this.curr=h;this.path.push(h);playSound('click')}else if(this.path.length>1&&h===this.path[this.path.length-2]){const u=Math.min(this.curr,h),v=Math.max(this.curr,h),ei=this.edges.findIndex(e=>e.u===u&&e.v===v);this.visited.delete(ei);this.path.pop();this.curr=h;this.bt++;playSound('click')}else{const u=Math.min(this.curr,h),v=Math.max(this.curr,h),ei=this.edges.findIndex(e=>e.u===u&&e.v===v);if(ei>-1&&!this.visited.has(ei)){this.visited.add(ei);this.path.push(h);this.curr=h;playSound('click')}}this.draw();if(this.visited.size===13)GameManager.win(this.bt===0)}}
            draw(){const c=document.getElementById('graph-canvas');if(!c)return;c.onclick=(e)=>this.click(e);const con=c.parentElement;c.width=con.clientWidth;c.height=con.clientHeight;const ctx=c.getContext('2d'),scale=(window.innerWidth>=768)?Math.min(c.width/550,c.height/450)*0.9:Math.min(c.width/550,c.height/450)*1.2,offX=(c.width-550*scale)/2,offY=(c.height-450*scale)/2;ctx.setTransform(scale,0,0,scale,offX,offY);ctx.clearRect(-offX/scale,-offY/scale,c.width/scale,c.height/scale);ctx.lineWidth=8;this.edges.forEach((e,i)=>{const n1=this.nodes[e.u],n2=this.nodes[e.v];ctx.beginPath();ctx.moveTo(n1.x,n1.y);ctx.lineTo(n2.x,n2.y);ctx.strokeStyle=this.visited.has(i)?'#fbbf24':'#475569';ctx.stroke()});for(let k in this.nodes){const n=this.nodes[k];ctx.beginPath();ctx.arc(n.x,n.y,28,0,6.28);ctx.fillStyle=parseInt(k)===this.curr?'#fbbf24':'#3b82f6';if(this.curr===null)ctx.fillStyle='#fbbf24';ctx.fill();ctx.fillStyle='white';ctx.font='bold 24px Arial';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(k,n.x,n.y)}document.getElementById('game-metric').innerText=`${13-this.visited.size} c·∫°nh`}
        }

        class GameRiver {
            constructor(){this.reset()}
            reset(){this.L=[1,3,6,8,12];this.R=[];this.lamp=[];this.side='L';this.time=0;this.names={1:'üêï',3:'üë¶',6:'üßô‚Äç‚ôÇÔ∏è',8:'üêª',12:'ü§ñ'};this.render()}
            move(id,loc){if(loc===this.side){if(this.lamp.length<2){this[this.side]=this[this.side].filter(x=>x!==id);this.lamp.push(id);playSound('click')}}else if(loc==='lamp'){this.lamp=this.lamp.filter(x=>x!==id);this[this.side].push(id);playSound('click')}this.render()}
            go(){if(this.lamp.length===0){showToast('C·∫ßn ng∆∞·ªùi c·∫ßm ƒë√®n!', 'error');playSound('fail');return}this.time+=Math.max(...this.lamp);this.side=this.side==='L'?'R':'L';this.render();playSound('click');if(this.L.length===0&&this.side==='R')setTimeout(()=>GameManager.win(this.time<=29),500)}
            render(){
                document.getElementById('game-metric').innerText=`${this.time}s`;
                const d=(arr,loc)=>arr.map(id=>`<div onclick="window.ActiveGame.move(${id},'${loc}')" class="char-card bg-slate-700 p-2 rounded-lg border-2 border-slate-500 flex flex-col items-center justify-center shadow-lg cursor-pointer transform active:scale-95 w-full"><span class="char-emoji text-2xl md:text-3xl">${this.names[id].split(' ')[0]}</span><span class="font-bold text-emerald-400 text-xs md:text-sm">${id}s</span></div>`).join('');
                
                // DESKTOP LAYOUT (Unified Frame)
                const desktopHTML = `
                <div class="bridge-layout shadow-2xl relative w-full h-[600px] flex">
                    <div class="cliff-side"><div class="col-span-full text-xs font-black text-slate-500 w-full text-center mb-2 tracking-widest uppercase">V√ÅCH TR√ÅI</div>${d(this.L,'L')}</div>
                    
                    <div class="bridge-zone">
                        <div class="bridge-cable"></div>
                        <div class="lamp-carrier ${this.side==='L'?'pos-left':'pos-right'}">
                            <div class="absolute -top-10 text-4xl animate-pulse">üèÆ</div>
                            ${this.lamp.map(id=>`<div onclick="window.ActiveGame.move(${id},'lamp')" class="char-card bg-amber-900/90 border-amber-500 p-1 rounded-lg text-center z-30 transform hover:scale-110 shadow-xl" style="width:50px; height:50px; min-height:0;"><div class="text-xl">${this.names[id].split(' ')[0]}</div></div>`).join('')}
                        </div>
                        <button onclick="window.ActiveGame.go()" class="btn-go-round hover:scale-105">ƒêI</button>
                    </div>
                    
                    <div class="cliff-side right"><div class="col-span-full text-xs font-black text-slate-500 w-full text-center mb-2 tracking-widest uppercase">V√ÅCH PH·∫¢I</div>${d(this.R,'R')}</div>
                </div>`;

                // MOBILE LAYOUT (Stacked)
                const mobileHTML = `
                <div class="bridge-layout shadow-2xl relative">
                    <div class="cliff-side"><div class="col-span-full text-xs font-black text-slate-500 w-full text-center mb-2 tracking-widest uppercase">V√ÅCH TR√ÅI</div>${d(this.L,'L')}</div>
                    <div class="bridge-zone">
                        <div class="bridge-track-area w-full md:w-full relative h-full">
                            <div class="bridge-cable"></div>
                            <div class="lamp-carrier ${this.side==='L'?'pos-left':'pos-right'}">
                                <div class="absolute -top-10 text-4xl animate-pulse">üèÆ</div>
                                ${this.lamp.map(id=>`<div onclick="window.ActiveGame.move(${id},'lamp')" class="char-card bg-amber-900/90 border-amber-500 p-1 rounded-lg text-center z-30 transform hover:scale-110 shadow-xl" style="width:50px; height:50px; min-height:0;"><div class="text-xl">${this.names[id].split(' ')[0]}</div></div>`).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="cliff-side right"><div class="col-span-full text-xs font-black text-slate-500 w-full text-center mb-2 tracking-widest uppercase">V√ÅCH PH·∫¢I</div>${d(this.R,'R')}</div>
                    
                    <!-- MOBILE GO BUTTON (IN FLOW, AT BOTTOM) -->
                    <div class="w-full p-4 mt-2 flex justify-center pb-8">
                         <button onclick="window.ActiveGame.go()" class="btn-go-mobile">BƒÇNG QUA</button>
                    </div>
                </div>`;

                const content = window.innerWidth >= 768 ? desktopHTML : mobileHTML;
                
                document.getElementById('game-stage').innerHTML = `
                <div class="w-full max-w-5xl mx-auto flex flex-col h-full md:justify-center md:pt-10 pb-20"> 
                    ${content}
                </div>`;
            }
        }

        class GameCat {
            constructor(){this.reset()}
            reset(){this.day=1;this.pos=new Set([1,2,3,4,5]);this.logs=[];this.render()}
            check(i){if(this.pos.has(i)){if(this.pos.size===1)GameManager.win(this.day<=6);else this.pos.delete(i)}const n=new Set();this.pos.forEach(p=>{if(p>1)n.add(p-1);if(p<5)n.add(p+1)});this.pos=n;this.logs.unshift(`L·∫ßn ${this.day}: H·ªôp ${i} -> Tr·ªëng.`);this.day++;this.render()}
            render(){
                document.getElementById('game-metric').innerText=`L·∫ßn ${this.day}`;
                const boxes = [1,2,3,4,5].map(i=>`<button onclick="window.ActiveGame.check(${i})" class="box-btn h-24 md:h-40 flex-1 bg-slate-800 border-4 border-slate-600 rounded-2xl text-5xl md:text-7xl font-black text-slate-500 hover:text-indigo-400 hover:border-indigo-500 quantum-active transition-all shadow-xl">${i}</button>`).join('');
                const logs = this.logs.map(l=>`<div class="flex justify-between text-sm md:text-base text-slate-400 mb-2 border-b border-slate-800 pb-1 font-mono"><span>${l}</span></div>`).join('');
                document.getElementById('game-stage').innerHTML=`<div class="flex flex-col items-center gap-8 w-full max-w-4xl h-full justify-center pt-4 pb-8"><div class="flex gap-3 w-full justify-center">${boxes}</div><div class="text-slate-400 font-mono text-sm mb-2">Kh·∫£ nƒÉng ·∫©n n·∫•p: <span class="text-indigo-400 font-bold text-2xl">${this.pos.size}</span> v·ªã tr√≠</div><div class="w-full bg-slate-950/50 p-6 rounded-2xl border border-slate-800 h-64 flex-1 overflow-y-auto shadow-inner"><div class="text-xs font-bold text-slate-500 mb-4 uppercase tracking-widest border-b border-slate-800 pb-2 sticky top-0 bg-slate-950/90">L·ªäCH S·ª¨ M·ªû H·ªòP</div>${logs || '<div class="text-center text-slate-600 italic mt-10 text-lg">Ch∆∞a m·ªü h·ªôp n√†o...</div>'}</div></div>`}
        }

        class GameSpider {
            constructor(){this.reset()}
            reset(){
                this.player=12; this.spider=4; this.moves=15; this.over=false;
                this.adj = {};
                this.adj[0] = [1,2,3,4,5]; 
                for(let r=0; r<4; r++) { 
                    for(let ray=0; ray<5; ray++) { 
                        const id = 1 + (r*5) + ray;
                        if(!this.adj[id]) this.adj[id] = [];
                        if(ray > 0) this.adj[id].push(id - 1); 
                        if(ray < 4) this.adj[id].push(id + 1);
                        if(r===0) { this.adj[id].push(0); } else { this.adj[id].push(id - 5); }
                        if(r<3) { this.adj[id].push(id + 5); }
                    }
                }
                this.player = 18; this.spider = 20;
                document.getElementById('game-stage').innerHTML=`<div class="w-full h-full flex flex-col items-center justify-center p-4"><div class="spider-frame relative"><div class="absolute top-4 left-4 text-white font-bold text-xl z-10 flex items-center gap-2 pointer-events-none"><span class="text-3xl">üï∏Ô∏è</span> V√¢y B·∫Øt</div><canvas id="spider-canvas" width="600" height="600" class="w-full h-full object-contain"></canvas></div></div>`;
                this.draw();
            }
            
            getPos(id){
                const cx=300, cy=520; 
                if(id===0) return {x:cx, y:cy};
                const val = id-1;
                const ring = Math.floor(val/5); 
                const ray = val % 5; 
                
                const maxDists = [300, 420, 480, 420, 300];
                const maxDist = maxDists[ray];
                const ratio = (ring + 1) / 4;
                const dist = ratio * maxDist;
                
                const startAngle = -150 * (Math.PI/180);
                const step = 30 * (Math.PI/180);
                const angle = startAngle + (ray * step);
                return { x: cx + dist * Math.cos(angle), y: cy + dist * Math.sin(angle) };
            }

            click(e){
                if(this.over)return;
                const canvas = document.getElementById('spider-canvas');
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                
                const lx = (e.clientX - rect.left) * scaleX;
                const ly = (e.clientY - rect.top) * scaleY;
                
                // SMART TOUCH: Find CLOSEST node
                let bestNode = -1;
                let minDist = 9999;
                
                for(let i=0; i<=20; i++){
                    const p = this.getPos(i);
                    const dist = Math.hypot(lx-p.x, ly-p.y);
                    if(dist < minDist){
                        minDist = dist;
                        bestNode = i;
                    }
                }
                
                // Check if closest node is within threshold (30px for precision in center)
                if(bestNode !== -1 && minDist < 30){
                    if(this.adj[this.player].includes(bestNode)){
                        this.player = bestNode; 
                        playSound('click');
                        if(this.player===this.spider) this.win();
                        else {
                            this.moves--; document.getElementById('game-metric').innerText=`${this.moves} b∆∞·ªõc`;
                            if(this.moves===0) this.fail(); else setTimeout(()=>this.ai(),300)
                        }
                        this.draw()
                    }
                }
            }

            ai(){
                if(this.over)return;
                const nb=this.adj[this.spider];
                let best=-1, max=-1;
                nb.forEach(n=>{
                    const pp=this.getPos(this.player); const np=this.getPos(n);
                    const d=Math.hypot(pp.x-np.x, pp.y-np.y);
                    if(n!==this.player){ if(d>max){ max=d; best=n; } }
                });
                if(best===-1) best=nb[0];
                this.spider=best; playSound('click');
                if(this.player===this.spider) this.win();
                this.draw();
            }

            win(){this.over=true;GameManager.win(15-this.moves<=10)}
            fail(){this.over=true;showToast('Tho√°t!', 'error');playSound('fail')}

            draw(){
                const c=document.getElementById('spider-canvas');if(!c)return;c.onclick=(e)=>this.click(e);
                const ctx=c.getContext('2d');
                ctx.clearRect(0,0,c.width,c.height);
                const cx=300, cy=520;
                ctx.lineWidth=2; ctx.strokeStyle='#475569';
                
                for(let r=0; r<4; r++) {
                    ctx.beginPath();
                    for(let ray=0; ray<5; ray++) {
                       const id = 1 + (r*5) + ray;
                       const p = this.getPos(id);
                       if(ray===0) ctx.moveTo(p.x, p.y); else ctx.lineTo(p.x, p.y);
                    }
                    ctx.stroke();
                }
                
                for(let ray=0; ray<5; ray++) {
                    ctx.beginPath(); ctx.moveTo(cx, cy);
                    const outerId = 1 + (3*5) + ray;
                    const p = this.getPos(outerId);
                    ctx.lineTo(p.x, p.y);
                    ctx.stroke();
                }

                for(let i=0; i<=20; i++){
                    const p=this.getPos(i);
                    const isNeighbor = this.adj[this.player].includes(i);
                    ctx.beginPath(); ctx.arc(p.x,p.y, i===0?15:10, 0, 6.28);
                    if(i===this.player) { ctx.fillStyle='#3b82f6'; ctx.shadowBlur=20; ctx.shadowColor='#3b82f6'; }
                    else if(i===this.spider) { ctx.fillStyle='#f472b6'; ctx.shadowBlur=20; ctx.shadowColor='#f472b6'; }
                    else if(isNeighbor) { ctx.fillStyle='#94a3b8'; ctx.shadowBlur=0; }
                    else { ctx.fillStyle='#1e293b'; ctx.shadowBlur=0; }
                    ctx.fill();
                    if(isNeighbor) { ctx.lineWidth=2; ctx.strokeStyle='white'; ctx.stroke(); }
                    ctx.shadowBlur=0;
                }
                ctx.fillStyle = '#ef4444'; ctx.font="bold 12px sans-serif"; ctx.textAlign="center"; ctx.fillText("O", cx, cy+30);
            }
        }

        class GameHorses {
            constructor(){this.reset()}
            reset(){this.pool=Array.from({length:25},(_,i)=>i+1);this.track=[];this.races=0;let s=[...this.pool];for(let i=24;i>0;i--){const j=Math.floor(Math.random()*(i+1));[s[i],s[j]]=[s[j],s[i]]}this.speeds={};this.pool.forEach((id,i)=>this.speeds[id]=s[i]);this.renderHTML()}
            renderHTML(){
                document.getElementById('game-stage').innerHTML=`
                <div class="flex flex-col w-full h-full pb-10 px-4 overflow-y-auto pt-6">
                    <div class="bg-slate-800 p-4 rounded-2xl border-2 border-slate-600 min-h-[100px] flex items-center justify-center gap-3 shadow-lg mb-4 sticky top-0 z-10"><div class="text-slate-500 text-xs font-black uppercase mr-2 tracking-widest">ƒê∆Ø·ªúNG ƒêUA</div><div id="horse-track-container" class="flex gap-2"></div><button onclick="window.ActiveGame.race()" class="px-6 py-2 bg-pink-600 hover:bg-pink-500 rounded-xl font-black text-white shadow-lg text-sm uppercase tracking-wider active:scale-95">ƒêUA</button></div>
                    
                    <div class="flex flex-col lg:flex-row gap-6 flex-1">
                        <div class="w-full lg:w-1/2 bg-slate-800 p-4 rounded-2xl border-2 border-slate-600 flex-1 flex-col"><div class="w-full text-slate-500 text-xs font-black uppercase mb-3 border-b border-slate-700 pb-2">TR·∫†I R·ªíNG</div><div id="horse-pool-container" class="grid grid-cols-5 gap-3 place-items-center"></div></div>
                        <div class="w-full lg:w-1/2 flex flex-col gap-4">
                            <div class="bg-slate-800 p-4 rounded-2xl border-2 border-slate-600 flex-1 min-h-[200px] flex flex-col"><div class="text-xs font-black text-indigo-400 mb-3 uppercase tracking-widest border-b border-indigo-900 pb-2">TH√ÄNH T√çCH</div><div id="horse-logs" class="log-box flex-1 text-base space-y-3"></div></div>
                            <div class="p-5 bg-indigo-950/50 border-2 border-indigo-800 rounded-2xl shrink-0"><div class="text-xs font-black text-indigo-400 mb-3 uppercase tracking-widest">D·ª∞ ƒêO√ÅN TOP 3</div><div class="flex space-x-3 mb-4"><input type="number" id="h-pred-1" placeholder="#1" class="bg-slate-900 border-2 border-slate-600 rounded-lg p-3 w-full text-white text-center text-lg font-bold outline-none"><input type="number" id="h-pred-2" placeholder="#2" class="bg-slate-900 border-2 border-slate-600 rounded-lg p-3 w-full text-white text-center text-lg font-bold outline-none"><input type="number" id="h-pred-3" placeholder="#3" class="bg-slate-900 border-2 border-slate-600 rounded-lg p-3 w-full text-white text-center text-lg font-bold outline-none"></div><button onclick="window.ActiveGame.check()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-xl text-base uppercase shadow-lg active:scale-95">G·ª¨I K·∫æT QU·∫¢</button></div>
                        </div>
                    </div>
                </div>`;
                this.updateUI();
            }
            updateUI(){document.getElementById('game-metric').innerText=`Cu·ªôc ƒëua #${this.races}`;document.getElementById('horse-track-container').innerHTML=this.track.map(id=>`<div class="horse" onclick="window.ActiveGame.toggle(${id})">${id}</div>`).join('');document.getElementById('horse-pool-container').innerHTML=this.pool.sort((a,b)=>a-b).map(id=>`<div class="horse bg-slate-700 border-slate-500 text-slate-300 hover:bg-slate-600 hover:border-slate-300" onclick="window.ActiveGame.toggle(${id})">${id}</div>`).join('')}
            toggle(id){const p=this.pool.indexOf(id);if(p>-1){if(this.track.length<5){this.pool.splice(p,1);this.track.push(id);playSound('click')}}else{const t=this.track.indexOf(id);if(t>-1){this.track.splice(t,1);this.pool.push(id);playSound('click')}}this.pool.sort((a,b)=>a-b);this.updateUI()}
            race(){if(this.track.length<2)return;this.races++;const r=[...this.track].sort((a,b)=>this.speeds[a]-this.speeds[b]);const l=document.getElementById('horse-logs');l.innerHTML=`<div class="mb-3 pb-2 border-b border-slate-700"><div class="text-pink-400 font-bold mb-1">Cu·ªôc ƒëua #${this.races}</div><div class="text-emerald-400 font-bold text-base tracking-wide">${r.join(' > ')}</div></div>`+l.innerHTML;this.pool.push(...this.track);this.track=[];this.pool.sort((a,b)=>a-b);this.updateUI()}
            check(){const p1=parseInt(document.getElementById('h-pred-1').value),p2=parseInt(document.getElementById('h-pred-2').value),p3=parseInt(document.getElementById('h-pred-3').value);if(!p1||!p2||!p3){showToast("Nh·∫≠p ƒë·ªß 3!", 'warning');return}const s=Object.keys(this.speeds).sort((a,b)=>this.speeds[a]-this.speeds[b]);if(p1==s[0]&&p2==s[1]&&p3==s[2])GameManager.win(this.races<=7);else{playSound('fail');showToast("Sai r·ªìi!", 'error')}}
        }

        class GameBalls {
            constructor(){this.reset()}
            reset(){this.pool=Array.from({length:12},(_,i)=>i+1);this.L=[];this.R=[];this.weighs=3;this.fake=Math.floor(Math.random()*12)+1;this.heavy=Math.random()>0.5;this.selPan=null;this.render()}
            selectPan(s){this.selPan=(this.selPan===s)?null:s;this.updateUI()}
            click(id){if(this.L.includes(id)){this.L=this.L.filter(x=>x!==id);this.pool.push(id)}else if(this.R.includes(id)){this.R=this.R.filter(x=>x!==id);this.pool.push(id)}else{if(!this.selPan){showToast("Ch·ªçn ƒëƒ©a c√¢n tr∆∞·ªõc!", 'warning');return}this.pool=this.pool.filter(x=>x!==id);if(this.selPan==='L')this.L.push(id);else this.R.push(id)}this.pool.sort((a,b)=>a-b);this.L.sort((a,b)=>a-b);this.R.sort((a,b)=>a-b);playSound('click');this.updateUI()}
            weigh(){
                if(this.weighs<=0)return;this.weighs--;
                const arm=document.getElementById('scale-arm');
                let res=0; if(this.L.length>this.R.length)res=-1;else if(this.R.length>this.L.length)res=1;else{if(this.L.includes(this.fake))res=this.heavy?-1:1;else if(this.R.includes(this.fake))res=this.heavy?1:-1}
                if(res===-1){ arm.classList.add('tilt-left'); } else if(res===1){ arm.classList.add('tilt-right'); }
                else { arm.classList.add('balanced-anim'); } 
                
                const txt=res===0?"C√ÇN B·∫∞NG":(res===-1?"TR√ÅI N·∫∂NG":"PH·∫¢I N·∫∂NG");
                document.getElementById('balls-logs').innerHTML=`<div class="mb-3 pb-2 border-b border-slate-700 flex flex-col"><div class="text-amber-400 font-bold text-base">L·∫ßn #${3-this.weighs}: ${txt}</div><div class="text-slate-400 text-xs mt-1 leading-relaxed">L:[${this.L}] <br> R:[${this.R}]</div></div>`+document.getElementById('balls-logs').innerHTML;
                
                setTimeout(()=>{
                    arm.classList.remove('tilt-left','tilt-right','balanced-anim');
                    this.pool.push(...this.L, ...this.R); this.L=[]; this.R=[]; this.pool.sort((a,b)=>a-b); this.updateUI();
                },2500);
                this.updateUI();
            }
            check(){const id=parseInt(document.getElementById('balls-guess-id').value),st=document.getElementById('balls-guess-status').value;if(!id||!st){showToast("Ch·ªçn b√≥ng!", 'warning');return}if(id===this.fake&&st===(this.heavy?'Heavy':'Light'))GameManager.win(true);else{playSound('fail');showToast("Sai r·ªìi!", 'error')}}
            render(){
                document.getElementById('game-stage').innerHTML=`
                <div class="flex flex-col lg:flex-row gap-8 w-full max-w-7xl items-start h-full pb-10 overflow-y-auto pt-6">
                    <div class="w-full lg:w-2/3 flex flex-col items-center justify-center min-h-[450px]">
                        <div class="relative w-full max-w-xl mx-auto mb-8 mt-4">
                             <div class="flex justify-between items-end px-4 mb-[-5px] gap-8">
                                <div id="pan-container-L" class="pan-container w-[45%] flex flex-col items-center cursor-pointer group" onclick="window.ActiveGame.selectPan('L')">
                                    <div class="text-xs font-bold text-slate-500 mb-2 group-hover:text-white transition-colors uppercase tracking-widest">ƒêƒ©a Tr√°i</div>
                                    <div id="pan-L" class="pan w-full border-4 border-slate-500 group-hover:border-slate-300 transition-colors shadow-2xl bg-slate-800/50"></div>
                                    <div class="h-12 w-2 bg-slate-500 mt-[-2px]"></div>
                                </div>
                                <div id="pan-container-R" class="pan-container w-[45%] flex flex-col items-center cursor-pointer group" onclick="window.ActiveGame.selectPan('R')">
                                    <div class="text-xs font-bold text-slate-500 mb-2 group-hover:text-white transition-colors uppercase tracking-widest">ƒêƒ©a Ph·∫£i</div>
                                    <div id="pan-R" class="pan w-full border-4 border-slate-500 group-hover:border-slate-300 transition-colors shadow-2xl bg-slate-800/50"></div>
                                    <div class="h-12 w-2 bg-slate-500 mt-[-2px]"></div>
                                </div>
                             </div>
                             <div class="scale-arm-wrapper">
                                <div id="scale-arm" class="scale-arm shadow-xl border border-slate-600"></div>
                                <div class="scale-pivot"></div>
                             </div>
                        </div>
                        <button onclick="window.ActiveGame.weigh()" class="px-12 py-4 bg-indigo-600 hover:bg-indigo-500 rounded-full font-black text-white shadow-2xl text-xl uppercase tracking-widest transition-transform hover:scale-105 mb-8 border-4 border-indigo-400/30">‚öñÔ∏è C√ÇN NGAY</button>
                        <div class="w-full bg-slate-800 p-6 rounded-2xl border-2 border-slate-600 shadow-inner">
                            <div class="text-xs font-bold text-slate-500 mb-3 uppercase tracking-widest">KHO B√ìNG</div>
                            <div id="balls-pool" class="flex flex-wrap justify-start gap-3 min-h-[80px]"></div>
                        </div>
                    </div>
                    <div class="w-full lg:w-1/3 flex flex-col gap-4 h-full">
                        <div class="bg-slate-800 p-4 rounded-2xl border-2 border-slate-600 flex-1 min-h-[250px] flex flex-col max-h-[60vh]">
                            <div class="text-xs font-black text-indigo-400 mb-3 uppercase tracking-widest border-b border-indigo-900 pb-2">L·ªäCH S·ª¨ C√ÇN</div>
                            <div id="balls-logs" class="log-box flex-1 text-base space-y-2"></div>
                        </div>
                        <div class="p-5 bg-emerald-900/30 border-2 border-emerald-700 rounded-2xl">
                            <div class="text-xs font-black text-emerald-400 mb-3 uppercase tracking-widest">ƒê√ÅP √ÅN</div>
                            <div class="flex gap-3 mb-4">
                                <select id="balls-guess-id" class="bg-slate-900 border-2 border-slate-600 rounded-xl p-3 text-white w-1/2 font-bold outline-none focus:border-emerald-500"><option value="">B√≥ng #</option>${Array.from({length:12},(_,i)=>`<option value="${i+1}">${i+1}</option>`).join('')}</select>
                                <select id="balls-guess-status" class="bg-slate-900 border-2 border-slate-600 rounded-xl p-3 text-white w-1/2 font-bold outline-none focus:border-emerald-500"><option value="">?</option><option value="Heavy">N·∫∑ng</option><option value="Light">Nh·∫π</option></select>
                            </div>
                            <button onclick="window.ActiveGame.check()" class="w-full py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl text-base uppercase shadow-lg transition-transform hover:scale-105">KI·ªÇM TRA</button>
                        </div>
                    </div>
                </div>`;
                this.updateUI();
            }
            updateUI(){
                document.getElementById('game-metric').innerText=`${this.weighs} l·∫ßn`;
                const b=(id)=>`<div onclick="event.stopPropagation(); window.ActiveGame.click(${id})" class="ball text-base shadow-md flex items-center justify-center hover:scale-110 border-2 border-indigo-500/30 transition-transform cursor-pointer font-bold">${id}</div>`;
                document.getElementById('balls-pool').innerHTML = this.pool.map(b).join('');
                document.getElementById('pan-L').innerHTML = this.L.map(b).join('');
                document.getElementById('pan-R').innerHTML = this.R.map(b).join('');
                const pL = document.getElementById('pan-L'), pR = document.getElementById('pan-R');
                if(this.selPan === 'L') { pL.parentElement.classList.add('scale-105'); pL.classList.add('selected-pan'); pR.classList.remove('selected-pan'); pR.parentElement.classList.remove('scale-105'); }
                else if(this.selPan === 'R') { pR.parentElement.classList.add('scale-105'); pR.classList.add('selected-pan'); pL.classList.remove('selected-pan'); pL.parentElement.classList.remove('scale-105'); }
                else { pL.classList.remove('selected-pan'); pR.classList.remove('selected-pan'); pL.parentElement.classList.remove('scale-105'); pR.parentElement.classList.remove('scale-105'); }
            }
        }

        const GameManager = {
            idx:0, gears:0, progress:{}, isTransitioning: false, visited: {}, // Added visited state
            init(){
                const s=localStorage.getItem('an_v240_save');
                if(s){
                    const d=JSON.parse(s);
                    this.idx=d.idx;
                    this.gears=d.gears;
                    this.progress=d.prog;
                    this.visited=d.visited || {};
                }
                this.renderSidebar();
                this.loadContent();
            },
            save(){
                localStorage.setItem('an_v240_save',JSON.stringify({
                    idx:this.idx,
                    gears:this.gears,
                    prog:this.progress,
                    visited:this.visited
                }));
            },
            renderSidebar(){
                const nav=document.getElementById('sidebar-nav'), mob=document.getElementById('mobile-nav-list');
                if(nav) nav.innerHTML=''; if(mob) mob.innerHTML='';
                if(document.getElementById('gear-count')) document.getElementById('gear-count').innerText=`${this.gears}/8`;
                if(document.getElementById('mobile-gear')) document.getElementById('mobile-gear').innerText=`${this.gears} ‚öôÔ∏è`;
                let cur='';
                STORY.forEach((d,i)=>{
                    if(d.type==='text')return;
                    if(d.part!==cur){cur=d.part;if(nav)nav.innerHTML+=`<div class="nav-part-header text-xs font-bold text-slate-500 uppercase tracking-widest mt-4 mb-2 pl-2 border-l-2 border-indigo-500/30">${cur}</div>`}
                    const p=this.progress[d.id];let st='text-slate-500 cursor-not-allowed',ic='üîí';
                    const prev=STORY[i-1];
                    if(i===0||i<=this.idx||(prev&&this.progress[prev.id]?.done))st='text-slate-300 hover:bg-slate-800 cursor-pointer';
                    if(i===this.idx) st='text-indigo-400 bg-indigo-950/30 border-r-2 border-indigo-500 font-bold';
                    if(p&&p.done){st='text-emerald-400';ic='‚úÖ'}
                    if(p&&p.opt){st='text-amber-400 font-bold';ic='‚öôÔ∏è'}
                    const el=`<div class="flex items-center px-3 py-2 rounded-md transition-all mb-1 gap-2 ${st}" onclick="GameManager.jump(${i})"><span class="text-xs">${ic}</span><span class="truncate text-sm">${d.title.split(':')[1]}</span></div>`;
                    if(nav)nav.innerHTML+=el; if(mob)mob.innerHTML+=el;
                })
            },
            loadContent(){
                const d=STORY[this.idx];
                
                // --- SPECIAL HANDLING FOR START PAGE ---
                if (d.id === 'intro') {
                    document.body.classList.add('intro-active');
                    // Force expand accordion
                    const wrap = document.getElementById('story-content-wrapper');
                    wrap.classList.remove('accordion-collapsed');
                    wrap.classList.add('accordion-expanded');
                } else {
                    document.body.classList.remove('intro-active');
                }

                // Update text content
                if (document.getElementById('chapter-tag-mobile')) document.getElementById('chapter-tag-mobile').innerText = d.title.split(':')[0];
                if (document.getElementById('story-title-mobile')) document.getElementById('story-title-mobile').innerText = d.title.split(':')[1] || d.title;
                if (document.getElementById('part-tag')) document.getElementById('part-tag').innerText=d.part;
                if (document.getElementById('chapter-tag')) document.getElementById('chapter-tag').innerText=d.title;
                if (document.getElementById('story-title')) document.getElementById('story-title').innerText=d.title;
                if (document.getElementById('story-text')) document.getElementById('story-text').innerText=d.text;
                if (document.getElementById('hint-text')) document.getElementById('hint-text').innerText=d.hint||'';
                if (document.getElementById('math-text')) document.getElementById('math-text').innerText=d.math||'';

                // --- CHAPTER 1 STORY OVERLAY ---
                const vic = document.getElementById('victory-overlay');
                if (d.id === 'c1' && !this.visited['c1']) {
                    // Show Story Overlay
                    const storyHTML = `
                    <div class="max-w-2xl bg-slate-900 p-8 rounded-2xl border border-slate-700 shadow-2xl relative animate-fade-in mx-4">
                        <div class="text-xs font-black text-indigo-400 uppercase tracking-widest mb-4">CH∆Ø∆†NG 1</div>
                        <h2 class="text-3xl font-serif font-bold text-white mb-4">${d.title.split(':')[1]}</h2>
                        <div class="text-slate-300 text-base leading-relaxed mb-8 max-h-[60vh] overflow-y-auto">
                            ${d.text}
                        </div>
                        <button onclick="GameManager.closeStoryOverlay()" class="w-full py-4 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-xl uppercase tracking-wider transition-transform active:scale-95">TI·∫æP T·ª§C</button>
                    </div>`;
                    vic.innerHTML = storyHTML;
                    vic.classList.add('victory-visible');
                    vic.style.pointerEvents = 'auto'; // Enable clicks
                    
                    // Mark as visited
                    this.visited['c1'] = true;
                    this.save();
                } else {
                    if(!vic.classList.contains('victory-visible') || d.id !== 'c1') {
                       vic.classList.remove('victory-visible');
                       vic.style.pointerEvents = 'none';
                       vic.innerHTML = '';
                    }
                }

                // Show Rules
                const rulesSection = document.getElementById('game-rules-section');
                const rulesText = document.getElementById('game-rules-text');
                if (d.rules) {
                    rulesText.innerHTML = d.rules;
                    rulesSection.classList.remove('hidden');
                } else {
                    rulesSection.classList.add('hidden');
                }
                
                const gw=document.getElementById('game-container'),ph=document.getElementById('placeholder');
                const b1=document.getElementById('btn-play');
                
                // Hide Game Container initially
                if(gw) gw.classList.add('hidden'); 
                if(ph) ph.classList.remove('hidden');
                
                document.getElementById('hint-modal').style.display = 'none';
                
                // Accordion Logic
                if(window.innerWidth >= 768) {
                    document.body.classList.add('desktop-game-active');
                    // On desktop, keep accordion expanded unless explicitly collapsed by user
                    // We reset state for new chapter
                    const wrap = document.getElementById('story-content-wrapper');
                    const id = document.getElementById('accordion-icon-desktop');
                    if(wrap) {
                        wrap.classList.remove('accordion-collapsed');
                        wrap.classList.add('accordion-expanded');
                    }
                    if(id) id.innerText='‚ñ≤ Thu g·ªçn';
                } else {
                    document.body.classList.remove('desktop-game-active');
                    // On Mobile: Intro handled above. For C1+, auto collapse handled in playLevel
                }

                // Auto-Play logic for non-text levels
                if(d.type!=='text'){
                      this.playLevel(); 
                }

                if(d.type==='text'){
                    if(b1) {b1.classList.remove('hidden');b1.innerText="B·∫ÆT ƒê·∫¶U";}
                }else{
                    if(b1) {b1.classList.remove('hidden');b1.innerText="B·∫ÆT ƒê·∫¶U / TI·∫æP T·ª§C";}
                }
                
                setTimeout(() => { this.isTransitioning = false; }, 500);
            },
            closeStoryOverlay() {
                const vic = document.getElementById('victory-overlay');
                vic.classList.remove('victory-visible');
                vic.style.pointerEvents = 'none';
                this.playLevel();
            },
            playLevel(){
                const d=STORY[this.idx];
                
                // --- FORCE COLLAPSE STORY ON BUTTON CLICK ---
                forceCollapseStory();

                if(d.type==='text'){this.next();return}
                
                document.getElementById('game-container').classList.remove('hidden');
                document.getElementById('placeholder').classList.add('hidden');
                if (document.getElementById('game-msg')) document.getElementById('game-msg').innerText="";

                if(window.ActiveGame && window.ActiveGame.reset) window.ActiveGame = null;

                if(d.game==='switches')window.ActiveGame=new GameSwitches();
                if(d.game==='jugs')window.ActiveGame=new GameJugs();
                if(d.game==='graph')window.ActiveGame=new GameGraph();
                if(d.game==='river')window.ActiveGame=new GameRiver();
                if(d.game==='cat')window.ActiveGame=new GameCat();
                if(d.game==='spider')window.ActiveGame=new GameSpider();
                if(d.game==='horses')window.ActiveGame=new GameHorses();
                if(d.game==='balls')window.ActiveGame=new GameBalls();
            },
            skip(){showToast("ƒê√£ b·ªè qua m√†n ch∆°i!", 'warning');this.win(false)},
            win(opt){
                if(this.isTransitioning) return; 

                playSound('win');
                const d=STORY[this.idx];
                this.progress[d.id]={done:true,opt:opt};
                let g=0;Object.values(this.progress).forEach(v=>{if(v.opt)g++});this.gears=g;
                this.save();
                this.renderSidebar();
                
                const nextTitle = STORY[this.idx+1] ? STORY[this.idx+1].title : "K·∫æT TH√öC";
                const nextText = STORY[this.idx+1] ? STORY[this.idx+1].text : "B·∫°n ƒë√£ ho√†n th√†nh h√†nh tr√¨nh!";
                
                const overlayHTML = `
                <div class="animate-bounce text-6xl mb-4">üéâ</div>
                <h2 class="text-4xl md:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-cyan-400 mb-2">CHI·∫æN TH·∫ÆNG!</h2>
                <p class="text-slate-300 text-lg mb-8 font-medium">${opt ? "Xu·∫•t s·∫Øc! +1 B√°nh RƒÉng V√†ng ‚öôÔ∏è" : "Ho√†n th√†nh! (Ch∆∞a t·ªëi ∆∞u)"}</p>
                
                <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 max-w-lg w-full text-left mb-8 shadow-2xl transform rotate-1 overflow-y-auto max-h-[40vh]">
                    <div class="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-2">CH∆Ø∆†NG TI·∫æP THEO</div>
                    <div class="text-xl font-bold text-white mb-2">${nextTitle}</div>
                    <p class="text-slate-400 text-sm leading-relaxed">${nextText}</p>
                </div>

                <button onclick="GameManager.next()" class="px-10 py-4 bg-white text-black font-black text-xl rounded-full shadow-[0_0_30px_rgba(255,255,255,0.3)] hover:scale-105 transition-transform flex items-center gap-2 group">
                    TI·∫æP T·ª§C <span class="group-hover:translate-x-1 transition-transform">‚ûú</span>
                </button>
                <div class="mt-4 text-xs text-slate-500 font-mono">Nh·∫•n Enter ƒë·ªÉ ti·∫øp t·ª•c</div>
                `;
                
                const vic = document.getElementById('victory-overlay');
                vic.innerHTML = overlayHTML;
                vic.classList.add('victory-visible');
                vic.style.pointerEvents = 'auto'; // Enable pointer events for buttons
            },
            next(){
                if(this.isTransitioning) return;
                this.isTransitioning = true;

                const vic = document.getElementById('victory-overlay');
                vic.classList.remove('victory-visible');
                vic.style.pointerEvents = 'none';
                
                if(this.idx<STORY.length-1){
                    this.idx++;
                    this.save();
                    this.loadContent();
                } else {
                    this.ending();
                }
            },
            jump(i){
                const prev=STORY[i-1];if((i===0)||(prev&&this.progress[prev.id]?.done)||this.progress[STORY[i].id]?.done){
                    this.idx=i;
                    this.loadContent();
                    document.getElementById('mobile-menu').classList.add('hidden');
                }
            },
            ending(){document.getElementById('ending-screen').classList.remove('hidden');document.getElementById('end-score').innerText=`${this.gears}/8 ‚öôÔ∏è`;const t=document.getElementById('end-title'),d=document.getElementById('end-desc');if(this.gears===8){t.innerText="TRUE ENDING";d.innerText="Huy·ªÅn tho·∫°i! B·∫°n ƒë√£ c·ª©u cha v√† thanh t·∫©y H·∫Øc Ph√°p S∆∞."}else{t.innerText="NORMAL ENDING";d.innerText="B·∫°n c·ª©u ƒë∆∞·ª£c cha nh∆∞ng H·∫Øc Ph√°p S∆∞ ƒë√£ tr·ªën tho√°t."}}
        };
        
        // Enter Key Listener
        document.addEventListener('keydown', (e) => {
            if(e.key === 'Enter' && !GameManager.isTransitioning) {
                const overlay = document.getElementById('victory-overlay');
                if(overlay.classList.contains('victory-visible')) { 
                    GameManager.next(); 
                } else {
                   const btn = document.getElementById('btn-play');
                   if(btn && !btn.classList.contains('hidden')) btn.click();
                }
            }
        });
        
        window.GameManager = GameManager;
        window.closeModal=(id)=>document.getElementById(id).style.display='none';
        window.openModal=(id)=>document.getElementById(id).style.display='flex';
        document.addEventListener('DOMContentLoaded', () => { GameManager.init(); });
    </script>
</body>
</html>
